{% extends 'base.html' %}
{% block title %}Session Details{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>{{ _('Session Details') }}</h1>
  <a href="/photo-view" class="btn btn-secondary">{{ _('Back to Sessions') }}</a>
</div>

<div class="mb-3">
  <button id="btn-import-start" class="btn btn-primary">
    {{ _('Start Import') }}
  </button>
</div>

<div id="import-status" class="mt-3" aria-live="polite"></div>

<div class="mt-4">
  <h2>{{ _('Selected Files') }}</h2>
  <div id="selection-counts" class="mb-2"></div>
  <table class="table table-sm">
    <thead>
      <tr>
        <th>{{ _('File') }}</th>
        <th>{{ _('Status') }}</th>
        <th>{{ _('Attempts') }}</th>
        <th>{{ _('Error') }}</th>
      </tr>
    </thead>
    <tbody id="selection-body"></tbody>
  </table>
</div>

<div id="server-data" 
     data-picker-session-id="{{ picker_session_id or '' }}" 
     style="display: none;"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // クエリパラメータ、もしくはサーバー側セッションから session_id を取得
  function resolveSessionId() {
    const params = new URLSearchParams(window.location.search);
    const fromQuery = params.get('session_id');
    if (fromQuery) return fromQuery;
    const serverDataEl = document.getElementById('server-data');
    const fromServer = serverDataEl.getAttribute('data-picker-session-id');
    return fromServer || '';
  }
  const pickerSessionId = resolveSessionId();
  if (!pickerSessionId) {
    // セッションIDが無ければセッション一覧ページに遷移
    window.location.href = '/photo-view';
    return;
  }
  
  // 数値IDの場合はセッション一覧に戻る（セキュリティ対策）
  if (/^\d+$/.test(pickerSessionId)) {
    console.warn('Numeric session ID detected, redirecting to sessions list');
    window.location.href = '/photo-view';
    return;
  }
  const importBtn = document.getElementById('btn-import-start');
  const statusEl = document.getElementById('import-status');
  const selectionBody = document.getElementById('selection-body');
  const countsEl = document.getElementById('selection-counts');

  function getCsrfTokenFromCookie() {
    // Flask-WTF の既定名が "csrf_token" の想定。環境に合わせて変更してください。
    const m = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }

  async function withBusy(btn, fn) {
    const originalHtml = btn.innerHTML;
    // シンプルなスピナー（Bootstrap 前提）
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> {{ _("Working...") }}';
    btn.disabled = true;
    btn.setAttribute('aria-busy', 'true');
    try {
      return await fn();
    } finally {
      btn.innerHTML = originalHtml;
      btn.disabled = false;
      btn.removeAttribute('aria-busy');
    }
  }

  importBtn.addEventListener('click', async () => {
    if (!pickerSessionId) return;

    await withBusy(importBtn, async () => {
      try {
        const headers = {};
        const csrf = getCsrfTokenFromCookie();
        if (csrf) headers['X-CSRFToken'] = csrf;

        const resp = await fetch(`/api/picker/session/${encodeURIComponent(pickerSessionId)}/import`, {
          method: 'POST',
          headers
          // body が不要なら送らない。必要なら JSON を設定し Content-Type を追加。
        });

        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          console.error('Import start failed:', resp.status, text);
          statusEl.textContent = '{{ _("Failed to start import.") }}';
          alert('{{ _("Failed to start import.") }}');
          return;
        }

        statusEl.textContent = '{{ _("Import started.") }}';
      } catch (err) {
        console.error(err);
        statusEl.textContent = '{{ _("Failed to start import.") }}';
        alert('{{ _("Failed to start import.") }}');
      }
    });
  });

  async function refreshSelections() {
    // 数値IDの場合はAPIリクエストを送信せずリダイレクト
    if (/^\d+$/.test(pickerSessionId)) {
      console.warn('Numeric session ID detected in refresh, redirecting to sessions list');
      window.location.href = '/photo-view';
      return;
    }
    
    try {
      const resp = await fetch(`/api/picker/session/${encodeURIComponent(pickerSessionId)}/selections`);
      if (!resp.ok) return;
      const data = await resp.json();
      selectionBody.innerHTML = '';
      data.selections.forEach(sel => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${sel.filename || sel.googleMediaId}</td>` +
                        `<td>${sel.status}</td>` +
                        `<td>${sel.attempts}</td>` +
                        `<td>${sel.error || ''}</td>`;
        selectionBody.appendChild(tr);
      });
      countsEl.textContent = Object.entries(data.counts).map(([k,v]) => `${k}: ${v}`).join(', ');
    } catch (err) {
      console.error(err);
    }
  }

  setInterval(refreshSelections, 3000);
  refreshSelections();
});
</script>
{% endblock %}

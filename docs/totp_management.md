# TOTP 管理ガイド

PhotoNest に組み込まれている TOTP (Time-based One-Time Password) 管理機能の概要と使い方をまとめています。管理者ロールを対象とした運用を前提としており、otpauth URI や QR コードからの登録、OTP プレビュー表示、JSON による一括インポート/エクスポートをサポートします。

## 前提条件

- `flask db upgrade` と `flask seed-master` を実行して最新のマイグレーションとマスターデータを適用していること。
- 対象ユーザーに以下の権限スコープを付与していること。
  - `totp:view` — TOTP 一覧の閲覧とエクスポートが可能。
  - `totp:write` — 新規登録、編集、削除、インポートが可能。
- ナビゲーションバーの「管理」メニュー、またはトップページのカードから「TOTP 管理」に遷移できます。

## UI の使い方

### 登録フォーム

1. 「新規 TOTP 登録」カードのフォームから `account`, `issuer`, `secret` を入力します。`description` は任意です。
2. シークレットは Base32 形式を想定しており、スペースやハイフンは自動で除去されます。入力が不正な場合は API 側で検証エラーが返ります。
3. 桁数 (`digits`) と有効期間 (`period`) を必要に応じて変更できます。既定値は 6 桁・30 秒です。
4. 入力値に応じて右下のプレビュー領域に OTP コードと残り秒数のプログレスバーがリアルタイム表示されます。

### QR コード読み取り

- 「QR コードから読み込む」入力に画像をアップロードすると、`otpauth://` URI を解析しフォームへ自動反映します。
- 解析結果はプレビューとして表示されるため、登録前に内容を確認できます。

### otpauth URI 展開

- otpauth URI を直接ペーストして「URI を展開」を押すと、アカウント・発行元・シークレットなどがフォームへ入力されます。

### 一覧表示

- 一覧テーブルは 1 秒ごとに OTP コードと残り時間を再計算します。API は静的なシークレット情報のみを返し、OTP の生成はフロントエンドで行います。
- ソートメニューから発行元、アカウント、更新日時順を切り替えられます。
- 行ごとに「編集」「削除」ボタンがあり、編集はモーダルで実行します。シークレットを変更しない場合は空欄のまま保存できます。

## JSON エクスポート / インポート

### エクスポート

- 「Export JSON」ボタンを押すと `/api/totp/export` から取得した JSON をダウンロードします。
- 出力フォーマットは以下の通りです。

```json
[
  {
    "account": "alice@example.com",
    "issuer": "Example",
    "secret": "JBSWY3DPEHPK3PXP",
    "description": "Example account",
    "algorithm": "SHA1",
    "digits": 6,
    "period": 30,
    "created_at": "2025-10-15T14:00:00Z"
  }
]
```

### インポート

1. 「Import JSON」ボタンからモーダルを開き、ファイルを選択するか JSON を直接貼り付けます。
2. `force` をオンにしない場合、`account` と `issuer` の組み合わせが既存レコードと重複すると確認メッセージのみが返されます。
3. `force` をオンにすると重複行も上書き登録されます。`created_at` を指定するとその値が保持されます。

## バックエンド API

| メソッド | エンドポイント | 説明 |
| --- | --- | --- |
| `GET` | `/api/totp` | 登録済み TOTP の一覧を取得します。OTP コードと残り時間はレスポンスにも含まれます。 |
| `POST` | `/api/totp` | 新規登録。フォーム入力、otpauth URI、QR 解析結果の JSON をそのまま送信できます。 |
| `PUT` | `/api/totp/<id>` | 既存レコードの編集。`secret` を含めた場合のみシークレットを更新します。 |
| `DELETE` | `/api/totp/<id>` | レコードの削除。 |
| `GET` | `/api/totp/export` | すべてのレコードを JSON 配列としてエクスポートします。 |
| `POST` | `/api/totp/import` | JSON 配列をインポートします。`force` フラグで重複時の上書きを制御します。 |

すべてのエンドポイントは `login_or_jwt_required` を通過し、かつ `totp:view` または `totp:write` 権限のチェックが行われます。

## テスト

API の基本的なフロー（認可、新規登録、更新、エクスポート、インポート、削除）は `tests/test_api_totp_management.py` で検証されています。必要に応じて `pytest tests/test_api_totp_management.py` を実行してください。

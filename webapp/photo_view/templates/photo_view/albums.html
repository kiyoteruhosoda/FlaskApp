{% extends 'base.html' %}
{% block title %}Albums{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
<style>
  .album-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    padding: 20px 0;
  }
  
  .album-card {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    background: white;
  }
  
  .album-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 24px rgba(0,0,0,0.15);
  }
  
  .album-cover {
    position: relative;
    height: 200px;
    overflow: hidden;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  
  .album-thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .album-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    color: white;
    padding: 20px 15px 15px;
  }
  
  .album-info {
    padding: 15px;
  }
  
  .album-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 8px 0;
    color: #2c3e50;
  }
  
  .album-meta {
    font-size: 0.9rem;
    color: #6c757d;
    margin: 0 0 5px 0;
  }
  
  .album-description {
    font-size: 0.85rem;
    color: #7f8c8d;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .loading-spinner {
    text-align: center;
    padding: 40px;
  }
  
  .no-albums {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
  }
  
  .no-albums .icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.3;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>{{ _('Albums') }}</h1>
  <div class="d-flex gap-2">
    <select id="sort-order" class="form-select form-select-sm" style="width: auto;">
      <option value="desc">{{ _('Newest First') }}</option>
      <option value="asc">{{ _('Oldest First') }}</option>
    </select>
    <button id="refresh-btn" class="btn btn-outline-primary btn-sm">
      <i class="fas fa-refresh"></i> {{ _('Refresh') }}
    </button>
  </div>
</div>

<div id="album-stats" class="mb-3">
  <span id="album-count" class="badge bg-info">{{ _('Loading...') }}</span>
</div>

<div id="albums-grid" class="album-grid">
  <!-- „Ç¢„É´„Éê„É†„Ç´„Éº„Éâ„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Åæ„Åô -->
</div>

<div id="loading-indicator" class="loading-spinner" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">{{ _('Loading...') }}</span>
  </div>
  <p class="mt-2">{{ _('Loading more albums...') }}</p>
</div>

<div id="no-more-data" class="text-center text-muted" style="display: none;">
  <p>{{ _('All albums loaded') }}</p>
</div>

<div id="no-albums" class="no-albums" style="display: none;">
  <div class="icon">üìÅ</div>
  <h3>{{ _('No Albums Found') }}</h3>
  <p>{{ _('Albums will appear here when they are created from your media collection.') }}</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const albumsGrid = document.getElementById('albums-grid');
  const loadingIndicator = document.getElementById('loading-indicator');
  const noMoreData = document.getElementById('no-more-data');
  const noAlbums = document.getElementById('no-albums');
  const sortOrder = document.getElementById('sort-order');
  const refreshBtn = document.getElementById('refresh-btn');
  const albumCount = document.getElementById('album-count');
  
  let infiniteScroll;
  let totalLoaded = 0;

  function formatDateTime(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    return date.toLocaleDateString();
  }

  function createAlbumCard(album) {
    const card = document.createElement('div');
    card.className = 'album-card';
    
    // „Ç´„Éê„ÉºÁîªÂÉè„ÅÆURLÔºàÊúÄÂàù„ÅÆ„É°„Éá„Ç£„Ç¢„ÅÆ„Çµ„É†„Éç„Ç§„É´„Åæ„Åü„ÅØ„Éá„Éï„Ç©„É´„ÉàÔºâ
    const coverUrl = album.coverImageId 
      ? `/api/media/${album.coverImageId}/thumbnail?size=512`
      : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM2NjdlZWEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM3NjRiYTIiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2cpIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5OCPC90ZXh0Pjwvc3ZnPg==';
    
    card.innerHTML = `
      <div class="album-cover">
        <img class="album-thumbnail" 
             src="${coverUrl}" 
             alt="${album.title || 'Album'}"
             loading="lazy">
        <div class="album-overlay">
          <div class="d-flex justify-content-between align-items-end">
            <span class="fw-bold">${album.mediaCount || 0} {{ _('photos') }}</span>
            <small>${formatDateTime(album.createdAt)}</small>
          </div>
        </div>
      </div>
      <div class="album-info">
        <h5 class="album-title">${album.title || _('Untitled Album')}</h5>
        <p class="album-meta">
          ${_('Created')} ${formatDateTime(album.createdAt)}
          ${album.lastModified ? ` ‚Ä¢ ${_('Updated')} ${formatDateTime(album.lastModified)}` : ''}
        </p>
        ${album.description ? `<p class="album-description">${album.description}</p>` : ''}
      </div>
    `;
    
    // „ÇØ„É™„ÉÉ„ÇØ„Åß„Ç¢„É´„Éê„É†Ë©≥Á¥∞„Éö„Éº„Ç∏„Å´ÈÅ∑Áßª
    card.addEventListener('click', () => {
      window.location.href = `/photo-view/albums/${album.id}`;
    });
    
    return card;
  }

  function initializeInfiniteScroll() {
    const paginationClient = new PaginationClient({
      baseUrl: '/api/albums',
      pageSize: 24, // „Ç¢„É´„Éê„É†„ÅØ1„Éö„Éº„Ç∏24‰ª∂Á®ãÂ∫¶
      parameters: {
        order: sortOrder.value
      },
      onItemsLoaded: (items, meta) => {
        if (meta.isFirstPage) {
          albumsGrid.innerHTML = '';
          totalLoaded = 0;
          noAlbums.style.display = 'none';
        }
        
        if (items.length === 0 && meta.isFirstPage) {
          noAlbums.style.display = 'block';
          albumCount.textContent = '0 albums';
          return;
        }
        
        items.forEach(album => {
          const card = createAlbumCard(album);
          albumsGrid.appendChild(card);
          totalLoaded++;
        });
        
        albumCount.textContent = `${totalLoaded} ${_('albums loaded')}`;
      },
      onError: (error) => {
        console.error('Albums loading error:', error);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'col-12';
        errorDiv.innerHTML = '<div class="alert alert-danger">{{ _("Failed to load albums. Please try again.") }}</div>';
        albumsGrid.appendChild(errorDiv);
      }
    });

    infiniteScroll = new InfiniteScrollHelper({
      paginationClient: paginationClient,
      loadingIndicator: loadingIndicator,
      noMoreDataIndicator: noMoreData,
      container: document.body,
      threshold: 200
    });

    infiniteScroll.start();
  }

  // „ÇΩ„Éº„ÉàÈ†ÜÂ§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
  sortOrder.addEventListener('change', () => {
    if (infiniteScroll) {
      infiniteScroll.destroy();
    }
    initializeInfiniteScroll();
  });

  // Êõ¥Êñ∞„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
  refreshBtn.addEventListener('click', () => {
    if (infiniteScroll) {
      infiniteScroll.destroy();
    }
    initializeInfiniteScroll();
  });

  // ÂàùÊúüÂåñ
  initializeInfiniteScroll();
});
</script>
{% endblock %}

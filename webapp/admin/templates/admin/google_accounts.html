{% extends "base.html" %}
{% block title %}{{ _('Google Accounts Management') }}{% endblock %}

{% block content %}
<h2>{{ _('Management') }}</h2>

<!-- Management Navigation Tabs -->
<ul class="nav nav-tabs mb-4">
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.user') }}">
      <i class="fas fa-users"></i> {{ _('User Management') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link active" href="{{ url_for('admin.google_accounts') }}">
      <i class="fab fa-google"></i> {{ _('Google Accounts') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.show_config') }}">
      <i class="fas fa-cogs"></i> {{ _('Config Settings') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.roles') }}">
      <i class="fas fa-user-tag"></i> {{ _('Roles') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.permissions') }}">
      <i class="fas fa-shield-alt"></i> {{ _('Permissions') }}
    </a>
  </li>
</ul>

<h3>{{ _('Google Accounts Management') }}</h3>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>ID</th>
        <th>{{ _('User') }}</th>
        <th>{{ _('Email') }}</th>
        <th>{{ _('Status') }}</th>
        <th>{{ _('Scopes') }}</th>
        <th>{{ _('Last Synced') }}</th>
        <th>{{ _('Token') }}</th>
        <th>{{ _('Refresh Token Expiry') }}</th>
        <th>{{ _('Actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for a in accounts %}
      <tr>
        <td>{{ a.id }}</td>
        <td>
          {% if a.user %}
            {{ a.user.email }}
          {% else %}
            <span class="text-muted">{{ _('No User') }}</span>
          {% endif %}
        </td>
        <td>{{ a.email }}</td>
        <td>
          {% if a.status == 'active' %}
            <span class="badge bg-success">{{ _('active') }}</span>
          {% else %}
            <span class="badge bg-secondary">{{ a.status }}</span>
          {% endif %}
        </td>
        <td style="max-width: 340px;">
          <div class="d-flex flex-wrap gap-1">
            {% for s in a.scopes_list() %}
              <span class="badge text-bg-secondary scope-badge" title="{{ s }}">{{ s }}</span>
            {% endfor %}
          </div>
        </td>
        <td>{{ a.last_synced_at or '-' }}</td>
        <td>
          {% if a.oauth_token_json %}
            <span class="badge bg-success">OK</span>
          {% else %}
            <span class="badge bg-danger">NG</span>
          {% endif %}
        </td>
        <td>{{ a.refresh_token_expires_at() or '-' }}</td>
        <td>
          <div class="btn-group btn-group-sm" role="group"
               data-id="{{ a.id }}" data-scopes="{{ a.scopes }}">
            <a href="#" class="btn btn-outline-secondary btn-disable">{{ _('Disable') }}</a>
            <a href="#" class="btn btn-outline-danger btn-delete">{{ _('Delete') }}</a>
            <a href="#" class="btn btn-outline-secondary btn-test">{{ _('Test') }}</a>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<style>
/* スコープバッジを長文でも崩さず見せる（省略表示＋ホバーで読みやすく） */
.scope-badge {
  display: inline-block;
  max-width: 160px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  vertical-align: middle;
  cursor: default;
}
.scope-badge:hover,
.scope-badge:focus {
  background: #e9ecef;
  position: relative;
  z-index: 1;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Disable
  document.querySelectorAll('.btn-disable').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = e.target.closest('[data-id]')?.dataset.id;
      if (!id) return;
      if (!confirm('{{ _("Disable this Google account?") }}')) return;
      const resp = await fetch(`/api/google/accounts/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'disabled' })
      });
      if (resp.ok) location.reload();
    });
  });

  // Delete
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = e.target.closest('[data-id]')?.dataset.id;
      if (!id) return;
      if (!confirm('{{ _("Delete this Google account?") }}')) return;
      const resp = await fetch(`/api/google/accounts/${id}`, { method: 'DELETE' });
      if (resp.ok) location.reload();
    });
  });

  // Test
  document.querySelectorAll('.btn-test').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = e.target.closest('[data-id]')?.dataset.id;
      if (!id) return;
      const resp = await fetch(`/api/google/accounts/${id}/test`, { method: 'POST' });
      const data = await resp.json();
      alert(data.result || data.error || 'OK');
    });
  });
});
</script>

{% endblock %}

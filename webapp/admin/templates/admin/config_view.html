{% extends "base.html" %}
{% block title %}{{ _('Config Settings') }}{% endblock %}
{% block content %}
<h2>{{ _('Management') }}</h2>

<!-- Management Navigation Tabs -->
<ul class="nav nav-tabs mb-4">
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.user') }}">
      <i class="fas fa-users"></i> {{ _('User Management') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.google_accounts') }}">
      <i class="fab fa-google"></i> {{ _('Google Accounts') }}
    </a>
  </li>
  {% if current_user.can('service_account:manage') %}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.service_accounts') }}">
      <i class="fas fa-key"></i> {{ _('Service Accounts') }}
    </a>
  </li>
  {% endif %}
  <li class="nav-item">
    <a class="nav-link active" href="{{ url_for('admin.show_config') }}">
      <i class="fas fa-cogs"></i> {{ _('Config Settings') }}
    </a>
  </li>
  {% if current_user.can('group:manage') %}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.groups') }}">
      <i class="fas fa-layer-group"></i> {{ _('Groups') }}
    </a>
  </li>
  {% endif %}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.roles') }}">
      <i class="fas fa-user-tag"></i> {{ _('Roles') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.permissions') }}">
      <i class="fas fa-shield-alt"></i> {{ _('Permissions') }}
    </a>
  </li>
</ul>

<h3>{{ _('Config Settings') }}</h3>

<div class="row g-4 align-items-start">
  <div class="col-12 col-xl-3" data-config-sidebar>
    <div class="card shadow-sm config-sidebar sticky-top">
      <div class="card-body">
        <div class="config-sidebar__header">
          <span class="config-sidebar__title">{{ _('Settings navigation') }}</span>
          <button
            type="button"
            class="btn-close config-sidebar__close"
            data-config-sidebar-close
            aria-label="{{ _('Hide navigation') }}"
            aria-controls="config-navigation"
            aria-expanded="true"
          ></button>
        </div>
        <nav
          id="config-navigation"
          class="config-tree"
          data-config-tree
          aria-label="{{ _('Configuration navigation') }}"
          tabindex="-1"
        >
          <ul class="list-unstyled mb-0">
            <li
              class="config-tree__item"
              data-config-tree-node
              data-target="#section-signing"
              data-search-text="{{ _('Access Token Signing')|e }}"
            >
              <a class="config-tree__link" href="#section-signing">{{ _('Access Token Signing') }}</a>
            </li>
            <li class="config-tree__heading">{{ _('Application configuration') }}</li>
            <li
              class="config-tree__item"
              data-config-tree-node
              data-target="#section-application"
              data-search-text="{{ _('Application Configuration (system settings)')|e }}"
            >
              <a class="config-tree__link" href="#section-application">
                {{ _('Application Configuration (system settings)') }}
              </a>
            </li>
            {% for section in application_sections %}
            <li
              class="config-tree__item config-tree__item--section"
              data-config-tree-section
              data-section="{{ section.identifier }}"
              data-search-text="{{ section.search_text|e }}"
            >
              <div class="config-tree__section-header">
                {% if section.fields %}
                <button
                  class="config-tree__toggle"
                  type="button"
                  data-config-tree-toggle
                  aria-expanded="true"
                  aria-controls="{{ section.anchor_id }}-tree"
                >
                  <span class="visually-hidden">{{ _('Toggle section visibility') }}</span>
                </button>
                {% endif %}
                <a class="config-tree__link" href="#{{ section.anchor_id }}">{{ section.label }}</a>
              </div>
              {% if section.fields %}
              <ul
                class="list-unstyled config-tree__children"
                id="{{ section.anchor_id }}-tree"
                data-config-tree-children
              >
                {% for field in section.fields %}
                <li
                  class="config-tree__item"
                  data-config-tree-field
                  data-section="{{ section.identifier }}"
                  data-field-key="{{ field.key }}"
                  data-search-text="{{ field.search_text|e }}"
                >
                  <a class="config-tree__link config-tree__link--field" href="#{{ field.anchor_id }}">
                    {{ field.label }}
                    <span class="config-tree__hint">{{ field.key }}</span>
                  </a>
                </li>
                {% endfor %}
              </ul>
              {% endif %}
            </li>
            {% endfor %}
            <li
              class="config-tree__item mt-3"
              data-config-tree-node
              data-target="#section-cors"
              data-search-text="{{ _('CORS Allowed Origins')|e }}"
            >
              <a class="config-tree__link" href="#section-cors">{{ _('CORS Allowed Origins') }}</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
  <div class="col-12 col-xl-9" data-config-content>
    <button
      type="button"
      class="btn btn-outline-secondary btn-sm config-sidebar__open d-none mb-3"
      data-config-sidebar-open
      aria-controls="config-navigation"
      aria-expanded="false"
      aria-hidden="true"
    >
      <i class="fas fa-bars me-1" aria-hidden="true"></i>
      {{ _('Show navigation') }}
    </button>
    <div class="config-search mb-4">
      <div class="config-search__field">
        <label class="form-label" for="config-search">{{ _('Search settings') }}</label>
        <input
          type="search"
          class="form-control"
          id="config-search"
          placeholder="{{ _('Filter by label, key, or description...') }}"
          data-config-search
        >
        <div class="form-text">{{ _('Type keywords to filter settings across all categories.') }}</div>
      </div>
    </div>
    <div class="alert alert-info d-none" data-config-empty-state>
      {{ _('No settings match your search. Try a different keyword.') }}
    </div>

    {% set signing_search_terms = [_('Access Token Signing')] %}
    {% for group in server_signing_groups or [] %}
      {% set _ = signing_search_terms.append(group.group_label or group.group_code or '') %}
      {% if group.group_code %}
        {% set _ = signing_search_terms.append(group.group_code) %}
      {% endif %}
    {% endfor %}
    {% set signing_search_text = signing_search_terms | select | join(' ') %}

    <section
      id="section-signing"
      class="config-block"
      data-config-block="signing"
      data-search-text="{{ signing_search_text|e }}"
    >
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-0 pb-0">
          <h4 class="card-title mb-1">{{ _('Access Token Signing') }}</h4>
          <p class="text-muted small mb-0">
            {{ _('Choose how access tokens are signed and distributed to clients.') }}
          </p>
        </div>
        <div class="card-body">
          <form method="post" class="config-form" data-ajax-config-form data-config-form="signing">
            <input type="hidden" name="action" value="update-signing">
            <div class="form-check mb-3">
              <input
                class="form-check-input"
                type="radio"
                name="access_token_signing"
                id="access-token-signing-builtin"
                value="builtin"
                {% if signing_setting.is_builtin %}checked{% endif %}
              >
              <label class="form-check-label" for="access-token-signing-builtin">
                {{ _('Built-in secret (HS256)') }}
              </label>
              <div class="form-text">
                {{ _('Use the built-in JWT secret key configured below.') }}
              </div>
              <div
                class="ms-4 mt-2 {% if not signing_setting.is_builtin %}d-none{% endif %}"
                data-builtin-secret-field
              >
                <label class="form-label" for="access-token-signing-secret">
                  {{ _('JWT secret key') }}
                </label>
                <input
                  type="password"
                  class="form-control"
                  id="access-token-signing-secret"
                  name="builtin_secret"
                  value="{{ (builtin_signing_secret or '')|e }}"
                  autocomplete="new-password"
                  spellcheck="false"
                  {% if not signing_setting.is_builtin %}disabled{% endif %}
                >
                <div class="form-text">
                  {{ _('HS256 secret used for application issued JWT tokens.') }}
                </div>
              </div>
            </div>

            <div>
              <label class="form-label" for="access-token-signing-server">
                {{ _('Server signing certificate groups') }}
              </label>
              {% if server_signing_groups %}
              <div class="list-group">
                {% for group in server_signing_groups %}
                {% set latest = group.latest_certificate %}
                <label class="list-group-item{% if not latest %} disabled{% endif %}">
                  <input
                    class="form-check-input me-2"
                    type="radio"
                    name="access_token_signing"
                    value="server_signing:{{ group.group_code }}"
                    {% if not latest %}disabled{% endif %}
                    {% if signing_setting.is_server_signing and signing_setting.group_code == group.group_code %}checked{% endif %}
                  >
                  <span class="fw-semibold">{{ group.group_label or group.group_code or _('Unnamed group') }}</span>
                  <span class="text-muted ms-2">{{ group.group_code }}</span>
                  {% if latest %}
                  <div class="small text-muted mt-1">
                    {{ _('Latest active certificate: %(kid)s', kid=latest.kid) }}
                    {% if latest.algorithm %}
                    <span class="ms-2">
                      {{ _('Algorithm: %(algorithm)s', algorithm=latest.algorithm) }}
                    </span>
                    {% endif %}
                    {% if latest.expires_at %}
                    <span class="ms-2">
                      {{ _('Expires at: %(timestamp)s', timestamp=latest.expires_at|localtime('%Y-%m-%d %H:%M')) }}
                    </span>
                    {% endif %}
                  </div>
                  {% if latest.subject %}
                  <div class="small text-muted">{{ latest.subject }}</div>
                  {% endif %}
                  {% else %}
                  <div class="small text-muted mt-1">
                    {{ _('No active certificates are available in this group.') }}
                  </div>
                  {% endif %}
                </label>
                {% endfor %}
              </div>
              {% else %}
              <p class="text-muted mb-0">
                {{ _('No server signing certificate groups are available. Create a certificate group first.') }}
              </p>
              {% endif %}
            </div>
            <div class="config-section-actions" data-config-section-actions="">
              <button type="submit" class="btn btn-primary mt-3">
                {{ _('Save signing settings') }}
              </button>
            </div>
            {% if signing_config_updated_at %}
            <div
              class="form-text text-muted mt-2"
              data-timestamp-target="signing"
              data-label-updated="{{ _('Last updated at: %(timestamp)s', timestamp='__TIME__') }}"
              data-description-label="{{ _('Description: %(description)s', description='__DESC__') }}"
            >
              {{ _('Last updated at: %(timestamp)s', timestamp=signing_config_updated_at|localtime('%Y-%m-%d %H:%M')) }}
            </div>
            {% endif %}
          </form>
        </div>
      </div>
    </section>

    <section
      id="section-application"
      class="config-block mt-4"
      data-config-block="application"
      data-search-text="{{ _('Application Configuration (system settings)')|e }}"
    >
      <header class="mb-3">
        <h4 class="mb-1">{{ _('Application Configuration (system settings)') }}</h4>
        <p class="text-muted small mb-0">
          {{ _('Update persisted configuration grouped by category.') }}
        </p>
        {% if application_config_updated_at %}
        <div
          class="form-text text-muted mt-2"
          data-timestamp-target="application"
          data-description-target="application"
          data-label-updated="{{ _('Last updated at: %(timestamp)s', timestamp='__TIME__') }}"
          data-description-label="{{ _('Description: %(description)s', description='__DESC__') }}"
        >
          {{ _('Last updated at: %(timestamp)s', timestamp=application_config_updated_at|localtime('%Y-%m-%d %H:%M')) }}
          {% if application_config_description %}
          <br>{{ _('Description: %(description)s', description=application_config_description) }}
          {% endif %}
        </div>
        {% endif %}
      </header>
      <form method="post" class="config-form" data-ajax-config-form data-config-form="application">
        <input type="hidden" name="action" value="update-app-config-fields">
        <div class="d-grid gap-4">
          {% for section in application_sections %}
          <div
            id="{{ section.anchor_id }}"
            class="card config-section-card shadow-sm"
            data-config-section
            data-section="{{ section.identifier }}"
            data-search-text="{{ section.search_text|e }}"
          >
            <div class="card-header bg-white border-0 pb-0">
              <h5 class="card-title mb-1">{{ section.label }}</h5>
              {% if section.description %}
              <p class="text-muted small mb-0">{{ section.description }}</p>
              {% endif %}
            </div>
            <div class="card-body pt-0">
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th scope="col">{{ _('Key') }}</th>
                      <th scope="col">{{ _('Current value') }}</th>
                      <th scope="col">{{ _('Default') }}</th>
                      <th scope="col">{{ _('New value') }}</th>
                      <th scope="col">{{ _('Required') }}</th>
                      <th scope="col">{{ _('Description') }}</th>
                      <th scope="col">{{ _('Apply') }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for field in section.fields %}
                    <tr
                      id="{{ field.anchor_id }}"
                      data-config-row
                      data-section="{{ field.section }}"
                      data-search-text="{{ field.search_text|e }}"
                      data-app-key="{{ field.key }}"
                    >
                      <td class="config-table__cell config-table__cell--key">
                        <div><code>{{ field.key }}</code></div>
                        <div class="text-muted small">{{ field.label }}</div>
                        <span
                          class="badge mt-1 {% if field.using_default %}bg-secondary{% else %}bg-info{% endif %}"
                          data-field="status-badge"
                          data-label-using-default="{{ _('Using default') }}"
                          data-label-overridden="{{ _('Overridden') }}"
                        >
                          {% if field.using_default %}
                          {{ _('Using default') }}
                          {% else %}
                          {{ _('Overridden') }}
                          {% endif %}
                        </span>
                      </td>
                      <td
                        class="config-table__cell config-table__cell--current font-monospace small"
                        data-field="current"
                      >
                        {{ field.current_json }}
                      </td>
                      <td
                        class="config-table__cell config-table__cell--default font-monospace small{% if not field.default_json %} text-muted{% endif %}"
                        data-field="default"
                        data-none-label="{{ _('None') }}"
                      >
                        {% if field.default_json %}
                          {{ field.default_json }}
                        {% else %}
                          {{ _('None') }}
                        {% endif %}
                      </td>
                      <td>
                        {% if field.editable %}
                          {% if field.data_type == 'boolean' %}
                          <select
                            class="form-select form-select-sm"
                            name="app_config_new[{{ field.key }}]"
                            data-field-input
                          >
                            {% for value, label in field.choices %}
                            <option value="{{ value }}" {% if field.form_value == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                          </select>
                          {% elif field.data_type == 'list' %}
                          <textarea
                            class="form-control form-control-sm font-monospace"
                            name="app_config_new[{{ field.key }}]"
                            rows="3"
                            data-field-input
                          >{{ field.form_value }}</textarea>
                          <div class="form-text">{{ _('One value per line.') }}</div>
                          {% elif field.data_type == 'integer' %}
                          <input
                            type="number"
                            class="form-control form-control-sm"
                            name="app_config_new[{{ field.key }}]"
                            value="{{ field.form_value }}"
                            data-field-input
                          >
                          {% elif field.data_type == 'float' %}
                          <input
                            type="number"
                            step="any"
                            class="form-control form-control-sm"
                            name="app_config_new[{{ field.key }}]"
                            value="{{ field.form_value }}"
                            data-field-input
                          >
                          {% else %}
                          <input
                            type="text"
                            class="form-control form-control-sm"
                            name="app_config_new[{{ field.key }}]"
                            value="{{ field.form_value }}"
                            data-field-input
                          >
                          {% endif %}
                          <div class="form-check mt-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="app-config-use-default-{{ field.key }}"
                              name="app_config_use_default[{{ field.key }}]"
                              value="1"
                              {% if field.use_default %}checked{% endif %}
                              data-field-use-default
                            >
                            <label class="form-check-label" for="app-config-use-default-{{ field.key }}">
                              {{ _('Revert to default value') }}
                            </label>
                          </div>
                        {% else %}
                          {% if field.multiline %}
                          <textarea class="form-control form-control-sm font-monospace" rows="3" readonly disabled>{{ field.form_value }}</textarea>
                          {% else %}
                          <input
                            type="text"
                            class="form-control form-control-sm"
                            value="{{ field.form_value }}"
                            readonly
                            disabled
                          >
                          {% endif %}
                          <div class="form-text text-muted">{{ _('This setting is read-only and cannot be changed from the admin UI.') }}</div>
                        {% endif %}
                      </td>
                      <td>{% if field.required %}{{ _('Yes') }}{% else %}{{ _('No') }}{% endif %}</td>
                      <td class="small">
                        {{ field.description }}
                        {% if field.default_hint %}
                        <div class="text-muted">{{ field.default_hint }}</div>
                        {% endif %}
                      </td>
                      <td>
                        {% if field.editable %}
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="app-config-selected-{{ field.key }}"
                            name="app_config_selected"
                            value="{{ field.key }}"
                            {% if field.selected %}checked{% endif %}
                            data-field-select
                          >
                          <label class="form-check-label" for="app-config-selected-{{ field.key }}">
                            {{ _('Update') }}
                          </label>
                        </div>
                        {% else %}
                        <span class="badge bg-secondary">{{ _('Read only') }}</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="config-section-actions" data-config-section-actions>
                <button
                  type="submit"
                  class="btn btn-primary"
                  name="save_section"
                  value="{{ section.identifier }}"
                >
                  {{ _('Save changes for this category') }}
                </button>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </form>
    </section>

    <section
      id="section-cors"
      class="config-block mt-4"
      data-config-block="cors"
      data-search-text="{{ (_('CORS Allowed Origins') ~ ' ' ~ _('Effective allowed origins') ~ ' ' ~ _('Allowed origins'))|e }}"
    >
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-0 pb-0">
          <h4 class="card-title mb-1">{{ _('CORS Allowed Origins') }}</h4>
          <p class="text-muted small mb-0">
            {{ _('Manage origins permitted by the CORS policy.') }}
          </p>
        </div>
        <div class="card-body">
          {% set allowed_field = (cors_fields | selectattr('key', 'equalto', 'allowedOrigins') | list | first) %}
          {% set effective_field = (cors_fields | selectattr('key', 'equalto', 'CORS_ALLOWED_ORIGINS') | list | first) %}
          {% set effective_value = (effective_field.form_value if effective_field else '') %}
          <form method="post" class="config-form" data-ajax-config-form data-config-form="cors">
            <input type="hidden" name="action" value="update-cors">
            <div class="row gy-4">
              {% if effective_field %}
              <div
                class="col-12 col-lg-6"
                id="cors-{{ effective_field.key }}"
                data-search-text="{{ effective_field.search_text|e }}"
              >
                <label class="form-label">{{ effective_field.label }}</label>
                {% if effective_field.description %}
                <div class="text-muted small mb-2">{{ effective_field.description }}</div>
                {% endif %}
                <textarea
                  class="form-control form-control-sm font-monospace"
                  rows="6"
                  readonly
                  disabled
                  data-cors-effective
                >{{ effective_field.form_value }}</textarea>
                <div
                  class="form-text text-muted{% if effective_value|trim %} d-none{% endif %}"
                  data-cors-effective-empty
                >
                  {{ _('No origins are currently allowed.') }}
                </div>
                {% if effective_field.default_hint %}
                <div class="form-text text-muted">{{ effective_field.default_hint }}</div>
                {% else %}
                <div class="form-text text-muted">{{ _('Updated automatically after saving allowedOrigins.') }}</div>
                {% endif %}
              </div>
              {% endif %}

              {% if allowed_field %}
              <div
                class="col-12 col-lg-6"
                id="cors-{{ allowed_field.key }}"
                data-cors-key="{{ allowed_field.key }}"
                data-search-text="{{ allowed_field.search_text|e }}"
              >
                <div class="d-flex align-items-center gap-2 mb-1">
                  <label class="form-label mb-0" for="cors-input-{{ allowed_field.key }}">
                    {{ allowed_field.label }}
                  </label>
                  <span
                    class="badge mt-0 {% if allowed_field.using_default %}bg-secondary{% else %}bg-info{% endif %}"
                    data-field="status-badge"
                    data-label-using-default="{{ _('Using default') }}"
                    data-label-overridden="{{ _('Overridden') }}"
                  >
                    {% if allowed_field.using_default %}
                    {{ _('Using default') }}
                    {% else %}
                    {{ _('Overridden') }}
                    {% endif %}
                  </span>
                </div>
                <div class="text-muted small mb-2">{{ allowed_field.description }}</div>
                <textarea
                  class="form-control form-control-sm font-monospace"
                  id="cors-input-{{ allowed_field.key }}"
                  name="cors_new[{{ allowed_field.key }}]"
                  rows="6"
                  data-cors-input
                >{{ allowed_field.form_value }}</textarea>
                <div class="form-text">{{ _('One value per line. Use "*" to allow any origin.') }}</div>
                <div class="form-check mt-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="cors-use-default-{{ allowed_field.key }}"
                    name="cors_use_default[{{ allowed_field.key }}]"
                    value="1"
                    {% if allowed_field.use_default %}checked{% endif %}
                    data-cors-use-default
                  >
                  <label class="form-check-label" for="cors-use-default-{{ allowed_field.key }}">
                    {{ _('Revert to default value') }}
                  </label>
                </div>
                <div class="mt-3">
                  <div class="small fw-semibold">{{ _('Default') }}</div>
                  <pre
                    class="form-control form-control-sm font-monospace bg-light{{ ' text-muted' if not allowed_field.default_json else '' }}"
                    data-field="default"
                    data-none-label="{{ _('None') }}"
                  >{% if allowed_field.default_json %}{{ allowed_field.default_json }}{% else %}{{ _('None') }}{% endif %}</pre>
                </div>
              </div>
              {% endif %}
            </div>
            <div class="config-section-actions mt-4">
              <button type="submit" class="btn btn-primary">
                {{ _('Save CORS settings') }}
              </button>
            </div>
          </form>
          {% if cors_config_updated_at %}
          <div
            class="form-text text-muted text-lg-end"
            data-timestamp-target="cors"
            data-description-target="cors"
            data-label-updated="{{ _('Last updated at: %(timestamp)s', timestamp='__TIME__') }}"
            data-description-label="{{ _('Description: %(description)s', description='__DESC__') }}"
          >
            {{ _('Last updated at: %(timestamp)s', timestamp=cors_config_updated_at|localtime('%Y-%m-%d %H:%M')) }}
            {% if cors_config_description %}
            <br>{{ _('Description: %(description)s', description=cors_config_description) }}
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </section>

  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script>
  window.i18nStrings = Object.assign(window.i18nStrings || {}, {
    'admin.config.update.success': "{{ _('Configuration updated successfully.') }}",
    'admin.config.update.failure': "{{ _('Configuration update failed.') }}",
    'admin.config.request.failure': "{{ _('Failed to submit the request.') }}",
  });
</script>
<script src="{{ url_for('static', filename='js/admin-config.js') }}"></script>
{% endblock %}

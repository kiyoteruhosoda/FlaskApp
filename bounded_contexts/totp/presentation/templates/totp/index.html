{% extends "base.html" %}
{% set can_write = can_write | default(false) %}
{% block title %}{{ _('TOTP Management') }}{% endblock %}

{% block extra_head %}
<style>
  .totp-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }
  .totp-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
  }
  .totp-toolbar .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }
  .otp-code {
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 1.75rem;
    letter-spacing: 0.3rem;
  }
  .otp-copyable {
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.375rem;
    transition: background-color 0.15s ease-in-out;
  }
  .otp-copyable:hover,
  .otp-copyable:focus {
    background-color: rgba(13, 110, 253, 0.1);
  }
  .otp-copyable:focus {
    outline: none;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }
  .otp-progress {
    height: 8px;
  }
  .totp-list-actions {
    display: inline-flex;
    justify-content: flex-start;
    gap: 0.25rem;
  }
  .totp-list-actions .btn {
    min-width: 4.5rem;
    justify-content: center;
  }
  .qr-preview {
    max-width: 200px;
    max-height: 200px;
  }
  .qr-canvas-offscreen {
    position: absolute;
    width: 1px;
    height: 1px;
    margin: -1px;
    border: 0;
    padding: 0;
    clip: rect(0 0 0 0);
    overflow: hidden;
  }
  .totp-layout {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .totp-create-panel {
    transition: opacity 0.3s ease;
  }
  .totp-create-panel.collapsed {
    display: none;
  }
  .totp-list-panel {
    min-width: 0;
    flex: 1 1 auto;
  }
  @media (min-width: 992px) {
    .totp-layout {
      flex-direction: row;
      align-items: stretch;
    }
    .totp-layout.totp-layout-collapsed {
      gap: 0;
    }
    .totp-layout .totp-create-panel {
      flex: 0 0 360px;
      display: block;
    }
    .totp-layout .totp-create-panel.collapsed {
      display: block;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .totp-layout.totp-layout-collapsed .totp-create-panel {
      display: none;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
  <h1 class="h3 mb-0">{{ _('TOTP Management') }}</h1>
  <div class="totp-toolbar">
    {% if can_write %}
    <button
      class="btn btn-outline-primary btn-sm"
      type="button"
      id="totp-create-toggle"
      aria-expanded="false"
      aria-label="{{ _('Show registration form') }}"
    >
      <i class="bi bi-layout-sidebar" aria-hidden="true"></i>
      <span data-role="label">{{ _('Show registration form') }}</span>
    </button>
    {% endif %}
    <button type="button" class="btn btn-outline-secondary" id="totp-export-btn">
      <i class="bi bi-download" aria-hidden="true"></i>
      <span>{{ _('Export JSON') }}</span>
    </button>
    {% if can_write %}
    <button type="button" class="btn btn-outline-primary" id="totp-import-btn">
      <i class="bi bi-upload" aria-hidden="true"></i>
      <span>{{ _('Import JSON') }}</span>
    </button>
    {% endif %}
  </div>
</div>

<div class="totp-layout totp-layout-collapsed" id="totp-layout">
  <div class="totp-list-panel">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <h2 class="h5 mb-0">{{ _('Registered TOTP entries') }}</h2>
          <small class="text-muted">{{ _('The list refreshes every second.') }}</small>
        </div>
        <div class="input-group" style="max-width: 320px;">
          <span class="input-group-text"><i class="bi bi-funnel"></i></span>
          <select class="form-select" id="totp-sort-select">
            <option value="issuer">{{ _('Sort by issuer') }}</option>
            <option value="account">{{ _('Sort by account') }}</option>
            <option value="updated">{{ _('Sort by updated time') }}</option>
          </select>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table align-middle mb-0" id="totp-table">
          <thead class="table-light">
            <tr>
              <th scope="col">{{ _('Issuer') }}</th>
              <th scope="col">{{ _('Account') }}</th>
              <th scope="col" style="width: 180px;">{{ _('One-time code') }}</th>
              <th scope="col">{{ _('Time remaining') }}</th>
              <th scope="col">{{ _('Description') }}</th>
              <th scope="col" class="text-nowrap">{{ _('Updated at') }}</th>
              {% if can_write %}
              <th scope="col" class="text-start">{{ _('Actions') }}</th>
              {% endif %}
            </tr>
          </thead>
          <tbody id="totp-table-body">
            <tr>
              <td colspan="{{ 7 if can_write else 6 }}" class="text-center py-4 text-muted">
                <i class="bi bi-arrow-repeat me-2"></i>{{ _('Loading data...') }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% if can_write %}
  <div class="totp-create-panel collapsed" id="totp-create-panel" aria-hidden="true">
    <div class="card shadow-sm h-100">
      <div class="card-header totp-card-header">
        <div>
          <h2 class="h5 mb-0">{{ _('Register New TOTP') }}</h2>
          <small class="text-muted">{{ _('Register by scanning a QR code or entering the details manually.') }}</small>
        </div>
        <span class="badge bg-secondary" id="totp-preview-badge">{{ _('Waiting for preview') }}</span>
      </div>
      <div class="card-body">
        <form id="totp-create-form" novalidate>
          <div class="mb-3">
            <label for="totp-account" class="form-label">{{ _('Account') }}</label>
            <input type="text" id="totp-account" name="account" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="totp-issuer" class="form-label">{{ _('Issuer') }}</label>
            <input type="text" id="totp-issuer" name="issuer" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="totp-secret" class="form-label">{{ _('Secret') }}</label>
            <input type="text" id="totp-secret" name="secret" class="form-control" required placeholder="JBSWY3DPEHPK3PXP">
            <div class="form-text">{{ _('Spaces and hyphens are removed automatically (Base32).') }}</div>
          </div>
          <div class="row">
            <div class="col-6 mb-3">
              <label for="totp-digits" class="form-label">{{ _('Digits') }}</label>
              <input type="number" id="totp-digits" name="digits" class="form-control" min="4" max="10" value="6">
            </div>
            <div class="col-6 mb-3">
              <label for="totp-period" class="form-label">{{ _('Period (seconds)') }}</label>
              <input type="number" id="totp-period" name="period" class="form-control" min="15" max="120" value="30">
            </div>
          </div>
          <div class="mb-3">
            <label for="totp-description" class="form-label">{{ _('Description (optional)') }}</label>
            <textarea id="totp-description" name="description" class="form-control" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">{{ _('Read from QR code') }}</label>
            <input type="file" accept="image/*" id="totp-qr-upload" class="form-control">
            <div class="d-flex gap-2 mt-2">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="totp-qr-paste-btn">
                <i class="bi bi-clipboard-plus me-1"></i>{{ _('Paste from clipboard') }}
              </button>
            </div>
            <div class="form-text">{{ _('Reads a QR code from an image in your clipboard.') }}</div>
            <canvas id="totp-qr-canvas" class="qr-canvas-offscreen" aria-hidden="true"></canvas>
            <img id="totp-qr-preview" class="mt-2 rounded shadow-sm d-none qr-preview" alt="QR preview">
          </div>
          <div class="mb-3">
            <label for="totp-otpauth" class="form-label">{{ _('otpauth URI (optional)') }}</label>
            <input type="text" id="totp-otpauth" class="form-control" placeholder="otpauth://totp/Example:alice@example.com?...">
            <div class="form-text">{{ _('Paste the URI and press "Parse URI" to populate the form.') }}</div>
          </div>
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary" id="totp-parse-uri-btn">
              <i class="bi bi-link-45deg me-1"></i>{{ _('Parse URI') }}
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-plus-circle me-1"></i>{{ _('Register') }}
            </button>
          </div>
        </form>
      </div>
      <div class="card-footer">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <small class="text-muted d-block">{{ _('Current preview') }}</small>
            <div
              class="otp-code otp-copyable"
              id="totp-preview-code"
              role="button"
              tabindex="0"
              aria-label="{{ _('Copy one-time code') }}"
              title="{{ _('Click to copy') }}"
            >------</div>
          </div>
          <div class="w-50">
            <div class="progress otp-progress">
              <div class="progress-bar" id="totp-preview-progress" role="progressbar" style="width: 0%"></div>
            </div>
            <small class="text-muted" id="totp-preview-remaining">{{ _('-- seconds remaining') }}</small>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

{% if can_write %}
<!-- 編集モーダル -->
<div class="modal fade" id="totp-edit-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="totp-edit-form">
        <div class="modal-header">
          <h5 class="modal-title">{{ _('Edit TOTP') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="totp-edit-id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="totp-edit-account">{{ _('Account') }}</label>
              <input type="text" class="form-control" id="totp-edit-account" required>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="totp-edit-issuer">{{ _('Issuer') }}</label>
              <input type="text" class="form-control" id="totp-edit-issuer" required>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="totp-edit-digits">{{ _('Digits') }}</label>
              <input type="number" class="form-control" id="totp-edit-digits" min="4" max="10">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="totp-edit-period">{{ _('Period (seconds)') }}</label>
              <input type="number" class="form-control" id="totp-edit-period" min="15" max="120">
            </div>
            <div class="col-12">
              <label class="form-label" for="totp-edit-description">{{ _('Description (optional)') }}</label>
              <textarea class="form-control" id="totp-edit-description" rows="2"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label" for="totp-edit-secret">{{ _('Update secret (optional)') }}</label>
              <input type="text" class="form-control" id="totp-edit-secret" placeholder="{{ _('Leave blank to keep the current secret.') }}">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary">{{ _('Save') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- インポートモーダル -->
<div class="modal fade" id="totp-import-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="totp-import-form">
        <div class="modal-header">
          <h5 class="modal-title">{{ _('Import TOTPs') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small">{{ _('Paste or choose a JSON file. Duplicates will be reviewed before continuing.') }}</p>
          <div class="mb-3">
            <label class="form-label" for="totp-import-file">{{ _('JSON file') }}</label>
            <input type="file" accept="application/json" class="form-control" id="totp-import-file">
          </div>
          <div class="mb-3">
            <label class="form-label" for="totp-import-text">{{ _('Paste JSON directly') }}</label>
            <textarea class="form-control" id="totp-import-text" rows="10" placeholder='[
  {
    "account": "alice@example.com",
    "issuer": "Example",
    "secret": "JBSWY3DPEHPK3PXP"
  }
]'></textarea>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="totp-import-force">
            <label class="form-check-label" for="totp-import-force">{{ _('Overwrite even if duplicates exist') }}</label>
          </div>
          <div class="alert alert-warning d-none mt-3" id="totp-import-conflicts"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
          <button type="submit" class="btn btn-primary">{{ _('Run import') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/otpauth@9.0.1/dist/otpauth.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
  window.totpPermissions = Object.assign({}, window.totpPermissions || {}, {{ {'canWrite': can_write} | tojson | safe }});
</script>
<script>
  window.i18nStrings = Object.assign(window.i18nStrings || {}, {{ {
    'totp.noEntries': _('No TOTP registrations yet.'),
    'totp.copyHint': _('Click to copy'),
    'totp.copyAriaLabel': _('Copy one-time code'),
    'totp.actions.edit': _('Edit'),
    'totp.actions.delete': _('Delete'),
    'totp.copy.success': _('Copied the one-time code.'),
    'totp.copy.error': _('Failed to copy the one-time code.'),
    'totp.remainingSeconds': _('Remaining {seconds} seconds'),
    'totp.preview.active': _('Previewing'),
    'totp.preview.placeholderSeconds': _('-- seconds remaining'),
    'totp.preview.waiting': _('Waiting for preview'),
    'totp.preview.unavailable': _('Preview unavailable'),
    'totp.load.error': _('Failed to load the TOTP list.'),
    'totp.otpauth.invalidFormat': _('The otpauth URI is not valid.'),
    'totp.otpauth.invalidType': _('The otpauth URI is not for TOTP.'),
    'totp.otpauth.missingData': _('The otpauth URI is missing required information.'),
    'totp.create.success': _('Registered the TOTP entry.'),
    'totp.create.error': _('Failed to register the TOTP entry.'),
    'totp.parse.success': _('Extracted information from the URI.'),
    'totp.parse.error': _('Failed to parse the otpauth URI.'),
    'totp.update.success': _('Updated the TOTP entry.'),
    'totp.update.error': _('Failed to update the TOTP entry.'),
    'totp.import.success': _('Imported TOTP entries.'),
    'totp.import.error': _('Failed to import TOTP entries.'),
    'totp.import.duplicatesTitle': _('Duplicate entries detected'),
    'totp.import.duplicatesHint': _('Select "Overwrite even if duplicates exist" and try again.'),
    'totp.import.requireInput': _('Provide JSON text or choose a file.'),
    'totp.file.readError': _('Failed to read the file.'),
    'totp.export.success': _('Downloaded the JSON file.'),
    'totp.export.error': _('Failed to export TOTP entries.'),
    'totp.delete.confirm': _('Delete {issuer} / {account}?'),
    'totp.delete.success': _('Deleted the TOTP entry.'),
    'totp.delete.error': _('Failed to delete the TOTP entry.'),
    'totp.qr.decodeError': _('Failed to decode the QR code.'),
    'totp.qr.unsupportedClipboard': _('This browser does not support reading images from the clipboard.'),
    'totp.qr.noClipboardImage': _('No image found in the clipboard.'),
    'totp.qr.imageLoadError': _('Failed to load the image.'),
    'totp.qr.noCodeDetected': _('Could not detect a QR code.'),
    'totp.qr.readSuccess': _('Read information from the QR code.'),
  } | tojson | safe }});
</script>
<script src="{{ url_for('static', filename='js/totp-manager.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggleButton = document.getElementById('totp-create-toggle');
    const createPanel = document.getElementById('totp-create-panel');
    const layout = document.getElementById('totp-layout');

    if (!toggleButton || !createPanel || !layout) {
      return;
    }

    const icon = toggleButton.querySelector('i');
    const label = toggleButton.querySelector('[data-role="label"]');
    const mediaQuery = window.matchMedia('(max-width: 991.98px)');

    const updateState = (expanded) => {
      createPanel.classList.toggle('collapsed', !expanded);
      layout.classList.toggle('totp-layout-collapsed', !expanded);
      createPanel.setAttribute('aria-hidden', expanded ? 'false' : 'true');
      toggleButton.setAttribute('aria-expanded', String(expanded));
      toggleButton.setAttribute(
        'aria-label',
        expanded
          ? '{{ _('Hide registration form') }}'
          : '{{ _('Show registration form') }}'
      );
      if (icon) {
        icon.className = expanded ? 'bi bi-layout-sidebar-inset' : 'bi bi-layout-sidebar';
      }
      if (label) {
        label.textContent = expanded
          ? '{{ _('Hide registration form') }}'
          : '{{ _('Show registration form') }}';
      }
    };

    toggleButton.addEventListener('click', () => {
      const willExpand = createPanel.classList.contains('collapsed');
      updateState(willExpand);
    });

    const handleMediaChange = (event) => {
      if (event.matches) {
        updateState(true);
      }
    };

    if (typeof mediaQuery.addEventListener === 'function') {
      mediaQuery.addEventListener('change', handleMediaChange);
    } else if (typeof mediaQuery.addListener === 'function') {
      mediaQuery.addListener(handleMediaChange);
    }

    updateState(false);
  });
</script>
{% endblock %}

{% extends 'base.html' %}
{% block title %}Photo View{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
{% endblock %}

{% block content %}
<h1>Photo View Home</h1>

<div class="mb-3">
  <a href="/auth/picker" class="btn btn-success">
    {{ _('Create New Session') }}
  </a>
  <button id="refresh-sessions" class="btn btn-outline-primary ms-2">
    <i class="fas fa-refresh"></i> {{ _('Refresh') }}
  </button>
  
  <!-- 設定とローカルインポートのリンク -->
  <div class="float-end">
    <a href="{{ url_for('photo_view.settings') }}" class="btn btn-outline-secondary me-2">
      <i class="bi bi-gear"></i> {{ _('Settings') }}
    </a>
    {% if current_user.can('admin') %}
    <a href="{{ url_for('photo_view.admin_settings') }}" class="btn btn-outline-warning">
      <i class="bi bi-tools"></i> {{ _('Admin Settings') }}
    </a>
    {% endif %}
  </div>
</div>

<div class="mt-4">
  <h2>{{ _('All Picker Sessions') }}</h2>
  <div id="session-stats" class="mb-3">
    <span id="session-count" class="badge bg-info">{{ _('Loading...') }}</span>
  </div>
  <div id="sessions-list">
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>{{ _('Session ID') }}</th>
            <th>{{ _('Status') }}</th>
            <th>{{ _('Selected Count') }}</th>
            <th>{{ _('File Status') }}</th>
            <th>{{ _('Created At') }}</th>
            <th>{{ _('Last Progress') }}</th>
            <th>{{ _('Actions') }}</th>
          </tr>
        </thead>
        <tbody id="sessions-body">
          <!-- セッションが動的に追加されます -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="loading-indicator" class="text-center" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">{{ _('Loading...') }}</span>
  </div>
  <p class="mt-2">{{ _('Loading more sessions...') }}</p>
</div>

<div id="no-more-data" class="text-center text-muted" style="display: none;">
  <p>{{ _('All sessions loaded') }}</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const sessionsBody = document.getElementById('sessions-body');
  const loadingIndicator = document.getElementById('loading-indicator');
  const noMoreData = document.getElementById('no-more-data');
  const refreshBtn = document.getElementById('refresh-sessions');
  const sessionCount = document.getElementById('session-count');
  
  let infiniteScroll;
  let totalLoaded = 0;

  function formatDateTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleString();
  }

  function formatCounts(counts) {
    if (!counts || Object.keys(counts).length === 0) return '-';
    return Object.entries(counts)
      .map(([status, count]) => `${status}: ${count}`)
      .join(', ');
  }

  function getStatusBadgeClass(status) {
    switch (status) {
      case 'pending': return 'secondary';
      case 'ready': return 'primary';
      case 'processing': return 'warning';
      case 'importing': return 'info';
      case 'imported': return 'success';
      case 'expired': return 'danger';
      case 'error': return 'danger';
      default: return 'secondary';
    }
  }

  function getCsrfTokenFromCookie() {
    const m = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }

  function createSessionRow(session) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${session.sessionId || 'N/A'}</td>
      <td><span class="badge bg-${getStatusBadgeClass(session.status)}">${session.status}</span></td>
      <td>${session.selectedCount || 0}</td>
      <td><small>${formatCounts(session.counts)}</small></td>
      <td><small>${formatDateTime(session.createdAt)}</small></td>
      <td><small>${formatDateTime(session.lastProgressAt)}</small></td>
      <td>
        <a href="/photo-view?session_id=${session.sessionId}" class="btn btn-sm btn-primary">{{ _('View Details') }}</a>
        ${session.status === 'ready' ? `<button class="btn btn-sm btn-success ms-1" onclick="startImport('${session.sessionId}')">{{ _('Start Import') }}</button>` : ''}
      </td>
    `;
    return tr;
  }

  function initializeInfiniteScroll() {
    const paginationClient = new PaginationClient({
      baseUrl: '/api/picker/sessions',
      pageSize: 50, // セッションは1ページ50件程度で十分
      onItemsLoaded: (items, meta) => {
        if (meta.isFirstPage) {
          sessionsBody.innerHTML = '';
          totalLoaded = 0;
        }
        
        items.forEach(session => {
          const row = createSessionRow(session);
          sessionsBody.appendChild(row);
          totalLoaded++;
        });
        
        sessionCount.textContent = `${totalLoaded} ${_('sessions loaded')}`;
      },
      onError: (error) => {
        console.error('Sessions loading error:', error);
        sessionsBody.innerHTML = '<tr><td colspan="7"><div class="alert alert-danger">{{ _("Failed to load sessions.") }}</div></td></tr>';
      }
    });

    infiniteScroll = new InfiniteScrollHelper({
      paginationClient: paginationClient,
      loadingIndicator: loadingIndicator,
      noMoreDataIndicator: noMoreData,
      container: document.body,
      threshold: 200
    });

    infiniteScroll.start();
  }

  window.startImport = async function(sessionId) {
    try {
      const headers = {};
      const csrf = getCsrfTokenFromCookie();
      if (csrf) headers['X-CSRFToken'] = csrf;

      const resp = await fetch(`/api/picker/session/${sessionId}/import`, {
        method: 'POST',
        headers
      });

      if (!resp.ok) {
        const text = await resp.text().catch(() => '');
        console.error('Import start failed:', resp.status, text);
        alert('{{ _("Failed to start import.") }}');
        return;
      }

      alert('{{ _("Import started.") }}');
      // セッション一覧を再読み込み
      refreshSessions();
    } catch (err) {
      console.error(err);
      alert('{{ _("Failed to start import.") }}');
    }
  };

  function refreshSessions() {
    if (infiniteScroll) {
      infiniteScroll.destroy();
    }
    initializeInfiniteScroll();
  }

  // 更新ボタンの処理
  refreshBtn.addEventListener('click', refreshSessions);

  // 初期化
  initializeInfiniteScroll();
  
  // 定期的に更新（5秒ごと）
  setInterval(refreshSessions, 5000);
});
</script>
{% endblock %}
      case 'imported': return 'success';
      case 'expired': return 'danger';
      case 'error': return 'danger';
      default: return 'secondary';
    }
  }

  function getCsrfTokenFromCookie() {
    const m = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }

  window.startImport = async function(sessionId) {
    try {
      const headers = {};
      const csrf = getCsrfTokenFromCookie();
      if (csrf) headers['X-CSRFToken'] = csrf;

      const resp = await fetch(`/api/picker/session/${sessionId}/import`, {
        method: 'POST',
        headers
      });

      if (!resp.ok) {
        const text = await resp.text().catch(() => '');
        console.error('Import start failed:', resp.status, text);
        alert('{{ _("Failed to start import.") }}');
        return;
      }

      alert('{{ _("Import started.") }}');
      // セッション一覧を再読み込み
      loadSessions();
    } catch (err) {
      console.error(err);
      alert('{{ _("Failed to start import.") }}');
    }
  };

  // 初期読み込み
  loadSessions();
  
  // 定期的に更新
  setInterval(loadSessions, 5000);
});
</script>
{% endblock %}

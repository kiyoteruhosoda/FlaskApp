# メール送信モジュール - アーキテクチャ図

## システム全体図

```
┌──────────────────────────────────────────────────────────────┐
│                    Presentation Layer                         │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │   webapp.services.PasswordResetService               │   │
│  │   - パスワードリセット機能                             │   │
│  │   - EmailServiceを使用してメール送信                    │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────────┬───────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│                   Application Layer                           │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │   application.email_service.EmailService             │   │
│  │   + send_email()                                     │   │
│  │   + send_password_reset_email()                      │   │
│  │   + validate_sender_config()                         │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────────┬───────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│                     Domain Layer                              │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │   domain.email_sender.IEmailSender <<interface>>     │   │
│  │   + send(message: EmailMessage) -> bool              │   │
│  │   + validate_config() -> bool                        │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │   domain.email_sender.EmailMessage <<value>>         │   │
│  │   - to: List[str]                                    │   │
│  │   - subject: str                                     │   │
│  │   - body: str                                        │   │
│  │   - html_body: Optional[str]                         │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────────┬───────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│                 Infrastructure Layer                          │
│                                                                │
│  ┌─────────────────────┐  ┌─────────────────────────────┐   │
│  │  SmtpEmailSender    │  │  ConsoleEmailSender         │   │
│  │  (Flask-Mailman使用)    │  │  (コンソール出力)            │   │
│  └─────────────────────┘  └─────────────────────────────┘   │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │   infrastructure.email_sender.EmailSenderFactory     │   │
│  │   + create(provider) -> IEmailSender                 │   │
│  │   - 設定に基づいて適切な実装を生成                      │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

## クラス図

```
┌─────────────────────────────────────┐
│      <<interface>>                  │
│      IEmailSender                   │
├─────────────────────────────────────┤
│ + send(message)                     │
│ + validate_config()                 │
└───────────┬─────────────────────────┘
            │
            │ implements
            │
    ┌───────┴────────┐
    │                │
    ▼                ▼
┌──────────────┐  ┌──────────────────┐
│SmtpEmail     │  │ConsoleEmail      │
│Sender        │  │Sender            │
├──────────────┤  ├──────────────────┤
│- mail        │  │- log_level       │
│- default_    │  │                  │
│  sender      │  │+ send()          │
│              │  │+ validate_       │
│+ send()      │  │  config()        │
│+ validate_   │  └──────────────────┘
│  config()    │
└──────────────┘

┌─────────────────────────────────────┐
│      <<value object>>               │
│      EmailMessage                   │
├─────────────────────────────────────┤
│ + to: List[str]                     │
│ + subject: str                      │
│ + body: str                         │
│ + html_body: Optional[str]          │
│ + from_address: Optional[str]       │
│ + cc: Optional[List[str]]           │
│ + bcc: Optional[List[str]]          │
│ + reply_to: Optional[str]           │
└─────────────────────────────────────┘
```

## シーケンス図: パスワードリセットメール送信

```
┌──────┐      ┌────────────┐     ┌─────────────┐     ┌──────────────┐     ┌────────────┐
│ User │      │ Controller │     │PasswordReset│     │ EmailService │     │IEmailSender│
│      │      │            │     │   Service   │     │              │     │            │
└───┬──┘      └─────┬──────┘     └──────┬──────┘     └──────┬───────┘     └─────┬──────┘
    │               │                   │                   │                   │
    │ パスワード       │                   │                   │                   │
    │ リセット要求     │                   │                   │                   │
    │──────────────>│                   │                   │                   │
    │               │                   │                   │                   │
    │               │ create_reset_     │                   │                   │
    │               │   request()       │                   │                   │
    │               │──────────────────>│                   │                   │
    │               │                   │                   │                   │
    │               │                   │ トークン生成         │                   │
    │               │                   │ DB保存            │                   │
    │               │                   │                   │                   │
    │               │                   │ send_password_    │                   │
    │               │                   │   reset_email()   │                   │
    │               │                   │──────────────────>│                   │
    │               │                   │                   │                   │
    │               │                   │                   │ EmailMessage作成  │
    │               │                   │                   │                   │
    │               │                   │                   │ send(message)    │
    │               │                   │                   │──────────────────>│
    │               │                   │                   │                   │
    │               │                   │                   │                   │ SMTP送信
    │               │                   │                   │                   │ または
    │               │                   │                   │                   │ Console出力
    │               │                   │                   │                   │
    │               │                   │                   │    success       │
    │               │                   │                   │<──────────────────│
    │               │                   │     success       │                   │
    │               │                   │<──────────────────│                   │
    │               │      success      │                   │                   │
    │               │<──────────────────│                   │                   │
    │   成功レスポンス    │                   │                   │                   │
    │<──────────────│                   │                   │                   │
    │               │                   │                   │                   │
```

## データフロー図

```
┌────────────┐
│  .env設定  │
│ MAIL_      │
│ PROVIDER   │
└─────┬──────┘
      │
      ▼
┌─────────────────────────────┐
│ EmailSenderFactory          │
│ - 設定読み込み                │
│ - プロバイダー決定             │
└─────────┬───────────────────┘
          │
          │ creates
          │
    ┌─────┴──────┐
    │            │
    ▼            ▼
┌─────────┐  ┌──────────┐
│ SMTP    │  │ Console  │
│ Sender  │  │ Sender   │
└────┬────┘  └────┬─────┘
     │            │
     │ injected   │
     │            │
     └────┬───────┘
          │
          ▼
    ┌──────────────┐
    │ EmailService │
    │ (Application)│
    └──────┬───────┘
           │
           │ uses
           │
           ▼
    ┌──────────────────┐
    │ PasswordReset    │
    │ Service          │
    │ (Presentation)   │
    └──────────────────┘
```

## 設定による動作切り替え

```
┌──────────────────────────────────────────┐
│         環境設定 (.env)                   │
│                                          │
│  MAIL_PROVIDER=smtp                      │
│  ↓                                       │
│  SmtpEmailSender が使用される              │
│  → Flask-Mailman経由でSMTP送信               │
│                                          │
│  MAIL_PROVIDER=console                   │
│  ↓                                       │
│  ConsoleEmailSender が使用される           │
│  → コンソールに出力（テスト/開発用）           │
└──────────────────────────────────────────┘
```

## テストカバレッジ

```
┌────────────────────────────────────┐
│       Domain Layer Tests           │
│  ✓ EmailMessage 値オブジェクト       │
│    - バリデーション                  │
│    - 不変性                         │
│    - エッジケース                    │
│  Tests: 11/11 passed               │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│   Infrastructure Layer Tests       │
│  ✓ ConsoleEmailSender              │
│    - メール送信                      │
│    - フォーマット                    │
│    - 設定検証                        │
│  Tests: 動作確認済み                 │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│   Application Layer Tests          │
│  ✓ EmailService                    │
│    - 基本送信                        │
│    - HTML送信                       │
│    - CC/BCC                        │
│    - エラーハンドリング               │
│  Tests: 8/8 passed                 │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│   Integration Tests                │
│  ✓ End-to-End テスト                │
│  ✓ Factory パターン                 │
│  ✓ パスワードリセット統合             │
│  Tests: 8/8 passed                 │
└────────────────────────────────────┘

Total: 27+ tests passed
```

## 拡張ポイント

```
新しいメール送信方式を追加する場合:

1. IEmailSender を実装
   ┌─────────────────────┐
   │ ApiEmailSender      │
   │ (例: SendGrid)      │
   └─────────────────────┘

2. Factory に登録
   EmailSenderFactory.create()
   にプロバイダー追加

3. 設定追加
   MAIL_PROVIDER=api
   MAIL_API_KEY=...
```

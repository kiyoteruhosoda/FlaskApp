{% extends "base.html" %}
{% block title %}{{ _('Certificate Groups') }} | {{ super() }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3">{{ _('Certificate Groups') }}</h1>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
    <i class="bi bi-plus-circle me-1"></i>{{ _('Create Group') }}
  </button>
</div>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th scope="col">{{ _('Group Code') }}</th>
        <th scope="col">{{ _('Display Name') }}</th>
        <th scope="col">{{ _('Usage') }}</th>
        <th scope="col">{{ _('Auto Rotate') }}</th>
        <th scope="col">{{ _('Rotation Threshold (days)') }}</th>
        <th scope="col">{{ _('Key Type') }}</th>
        <th scope="col">{{ _('Subject') }}</th>
        <th scope="col">{{ _('Updated At') }}</th>
        <th scope="col" class="text-end">{{ _('Actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% if groups %}
        {% for group in groups %}
        <tr>
          <td class="font-monospace">{{ group.group_code }}</td>
          <td>{{ group.display_name or '-' }}</td>
          <td>{{ group.usage_type.value }}</td>
          <td>
            {% if group.auto_rotate %}
            <span class="badge bg-success">{{ _('Enabled') }}</span>
            {% else %}
            <span class="badge bg-secondary">{{ _('Disabled') }}</span>
            {% endif %}
          </td>
          <td>{{ group.rotation_threshold_days }}</td>
          <td>
            {{ group.key_type }}{% if group.key_size %} {{ group.key_size }}{% endif %}{% if group.key_curve %} / {{ group.key_curve }}{% endif %}
          </td>
          <td>
            {% if group.subject %}
              {% for key, value in group.subject.items() %}
              <span class="badge text-bg-light me-1">{{ key }}={{ value }}</span>
              {% endfor %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td>{{ group.updated_at.strftime('%Y-%m-%d %H:%M:%S') if group.updated_at else '-' }}</td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-primary me-2" href="{{ url_for('certs_ui.group_detail', group_code=group.group_code) }}">
              {{ _('View Certificates') }}
            </a>
            <button class="btn btn-sm btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#editGroupModal" data-group='{{ {
                "groupCode": group.group_code,
                "displayName": group.display_name,
                "usageType": group.usage_type.value,
                "keyType": group.key_type,
                "keyCurve": group.key_curve,
                "keySize": group.key_size,
                "autoRotate": group.auto_rotate,
                "rotationThresholdDays": group.rotation_threshold_days,
                "subject": group.subject
              } | tojson }}'>
              {{ _('Edit') }}
            </button>
            <form class="d-inline" method="post" action="{{ url_for('certs_ui.delete_group', group_code=group.group_code) }}" onsubmit="return confirm('{{ _('Are you sure you want to delete this group?') }}');">
              <button type="submit" class="btn btn-sm btn-outline-danger">{{ _('Delete') }}</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      {% else %}
      <tr>
        <td colspan="9" class="text-center text-muted py-4">{{ _('No certificate groups available.') }}</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true" data-show-on-load="{{ 'true' if show_create_modal else 'false' }}">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{{ url_for('certs_ui.create_group') }}">
        <div class="modal-header">
          <h2 class="modal-title h5" id="createGroupModalLabel">{{ _('Create Certificate Group') }}</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="group_code">{{ _('Group Code') }} <span class="text-danger">*</span></label>
              <input class="form-control" type="text" id="group_code" name="group_code" required value="{{ create_form_values.get('group_code', '') }}">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="display_name">{{ _('Display Name') }}</label>
              <input class="form-control" type="text" id="display_name" name="display_name" value="{{ create_form_values.get('display_name', '') }}">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="usage_type">{{ _('Usage Type') }} <span class="text-danger">*</span></label>
              <select class="form-select" id="usage_type" name="usage_type" required data-initial="{{ create_form_values.get('usage_type', '') }}">
                <option value="">{{ _('Select usage type') }}</option>
                {% for value, label in usage_options %}
                <option value="{{ value }}" {% if create_form_values.get('usage_type') == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="key_type">{{ _('Key Type') }}</label>
              <select class="form-select" id="key_type" name="key_type" data-initial="{{ create_form_values.get('key_type', '') }}" data-placeholder="{{ _('Select key type') }}" data-unspecified="{{ _('Not specified') }}"></select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="key_size">{{ _('Key Size') }}</label>
              <select class="form-select" id="key_size" name="key_size" data-initial="{{ create_form_values.get('key_size', '') }}" data-placeholder="{{ _('Select key size') }}" data-unspecified="{{ _('Not specified') }}"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="key_curve">{{ _('Key Curve') }}</label>
              <select class="form-select" id="key_curve" name="key_curve" data-initial="{{ create_form_values.get('key_curve', '') }}" data-placeholder="{{ _('Select key curve') }}" data-unspecified="{{ _('Not specified') }}"></select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="rotation_threshold_days">{{ _('Rotation Threshold (days)') }} <span class="text-danger">*</span></label>
              <input class="form-control" type="number" id="rotation_threshold_days" name="rotation_threshold_days" value="{{ create_form_values.get('rotation_threshold_days', 30) }}" min="1" required>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="auto_rotate" name="auto_rotate" {% if create_form_values.get('auto_rotate', 'on') == 'on' %}checked{% endif %}>
                <label class="form-check-label" for="auto_rotate">{{ _('Auto Rotate') }}</label>
              </div>
            </div>
          </div>
          <hr>
          <h3 class="h6 mb-1">{{ _('Subject Template') }} <span class="text-danger">*</span></h3>
          <p class="text-muted small mb-3">{{ _('Enter at least one subject attribute using ASCII characters. Country code must be a two-letter ISO 3166-1 alpha-2 value (e.g., JP).') }}</p>
          <div class="row g-3">
            {% for oid, field_name, label in subject_fields %}
            <div class="col-md-6">
              <label class="form-label" for="{{ field_name }}">{{ label }}</label>
              {% if oid == 'C' %}
              <input class="form-control" type="text" id="{{ field_name }}" name="{{ field_name }}" value="{{ create_form_values.get(field_name, '') }}" maxlength="2" pattern="[A-Za-z]{2}" title="{{ _('Enter a two-letter ISO 3166-1 alpha-2 code (e.g., JP).') }}">
              {% else %}
              <input class="form-control" type="text" id="{{ field_name }}" name="{{ field_name }}" value="{{ create_form_values.get(field_name, '') }}">
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary">{{ _('Save Group') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" id="editGroupForm">
        <div class="modal-header">
          <h2 class="modal-title h5" id="editGroupModalLabel">{{ _('Edit Certificate Group') }}</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="edit_group_code">{{ _('Group Code') }} <span class="text-danger">*</span></label>
              <input class="form-control" type="text" id="edit_group_code" name="group_code" readonly>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit_display_name">{{ _('Display Name') }}</label>
              <input class="form-control" type="text" id="edit_display_name" name="display_name">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit_usage_type">{{ _('Usage Type') }} <span class="text-danger">*</span></label>
              <select class="form-select" id="edit_usage_type" name="usage_type" required>
                {% for value, label in usage_options %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="edit_key_type">{{ _('Key Type') }}</label>
              <select class="form-select" id="edit_key_type" name="key_type" data-placeholder="{{ _('Select key type') }}" data-unspecified="{{ _('Not specified') }}"></select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="edit_key_size">{{ _('Key Size') }}</label>
              <select class="form-select" id="edit_key_size" name="key_size" data-placeholder="{{ _('Select key size') }}" data-unspecified="{{ _('Not specified') }}"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit_key_curve">{{ _('Key Curve') }}</label>
              <select class="form-select" id="edit_key_curve" name="key_curve" data-placeholder="{{ _('Select key curve') }}" data-unspecified="{{ _('Not specified') }}"></select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="edit_rotation_threshold_days">{{ _('Rotation Threshold (days)') }} <span class="text-danger">*</span></label>
              <input class="form-control" type="number" id="edit_rotation_threshold_days" name="rotation_threshold_days" min="1" required>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="edit_auto_rotate" name="auto_rotate">
                <label class="form-check-label" for="edit_auto_rotate">{{ _('Auto Rotate') }}</label>
              </div>
            </div>
          </div>
          <hr>
          <h3 class="h6 mb-1">{{ _('Subject Template') }} <span class="text-danger">*</span></h3>
          <p class="text-muted small mb-3">{{ _('Enter at least one subject attribute using ASCII characters. Country code must be a two-letter ISO 3166-1 alpha-2 value (e.g., JP).') }}</p>
          <div class="row g-3">
            {% for oid, field_name, label in subject_fields %}
            <div class="col-md-6">
              <label class="form-label" for="edit_{{ field_name }}">{{ label }}</label>
              {% if oid == 'C' %}
              <input class="form-control" type="text" id="edit_{{ field_name }}" name="{{ field_name }}" maxlength="2" pattern="[A-Za-z]{2}" title="{{ _('Enter a two-letter ISO 3166-1 alpha-2 code (e.g., JP).') }}">
              {% else %}
              <input class="form-control" type="text" id="edit_{{ field_name }}" name="{{ field_name }}">
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary">{{ _('Update Group') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
{% block scripts %}
{{ super() }}
<script>
(function() {
  const KEY_PRESETS = {{ key_presets | tojson }};

  function createKeyFieldController(ids) {
    const usageSelect = document.getElementById(ids.usageId);
    const keyTypeSelect = document.getElementById(ids.keyTypeId);
    const keyCurveSelect = document.getElementById(ids.keyCurveId);
    const keySizeSelect = document.getElementById(ids.keySizeId);

    if (!usageSelect || !keyTypeSelect || !keyCurveSelect || !keySizeSelect) {
      return null;
    }

    const state = {
      usageType: usageSelect.dataset.initial || usageSelect.value || '',
      keyType: keyTypeSelect.dataset.initial || keyTypeSelect.value || '',
      keyCurve: keyCurveSelect.dataset.initial || keyCurveSelect.value || '',
      keySize: keySizeSelect.dataset.initial || keySizeSelect.value || '',
    };

    const placeholders = {
      keyType: keyTypeSelect.dataset.placeholder || '',
      keyCurve: keyCurveSelect.dataset.placeholder || '',
      keySize: keySizeSelect.dataset.placeholder || '',
    };

    const unspecifiedLabels = {
      keyType: keyTypeSelect.dataset.unspecified || '',
      keyCurve: keyCurveSelect.dataset.unspecified || '',
      keySize: keySizeSelect.dataset.unspecified || '',
    };

    function setOptions(select, options, selectedValue, config) {
      const fragment = document.createDocumentFragment();
      const placeholderLabel = (config && config.placeholderLabel) || '';
      const disableIfEmpty = Boolean(config && config.disableIfEmpty);
      if (placeholderLabel) {
        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = placeholderLabel;
        fragment.appendChild(placeholderOption);
      }
      options.forEach((option) => {
        const opt = document.createElement('option');
        opt.value = option.value;
        opt.textContent = option.label;
        fragment.appendChild(opt);
      });
      select.innerHTML = '';
      select.appendChild(fragment);
      const values = options.map((option) => option.value);
      let finalValue = selectedValue;
      if (!values.includes(finalValue)) {
        finalValue = options.length > 0 ? options[0].value : '';
        if (placeholderLabel && !finalValue) {
          finalValue = '';
        }
      }
      select.value = finalValue || '';
      if (disableIfEmpty) {
        select.disabled = options.length === 0;
      } else {
        select.disabled = false;
      }
      return select.value;
    }

    function buildKeyTypeOptions(presets) {
      const seen = new Set();
      const options = [];
      presets.forEach((preset) => {
        if (!preset || !preset.keyType || seen.has(preset.keyType)) {
          return;
        }
        seen.add(preset.keyType);
        options.push({ value: preset.keyType, label: preset.keyType });
      });
      return options;
    }

    function buildKeyCurveOptions(presets) {
      const options = new Map();
      presets.forEach((preset) => {
        const value = preset.keyCurve ? preset.keyCurve : '';
        if (!options.has(value)) {
          const parts = [];
          if (value) {
            parts.push(value);
            if (preset.label) {
              parts.push(preset.label);
            }
          } else if (unspecifiedLabels.keyCurve) {
            parts.push(unspecifiedLabels.keyCurve);
          }
          options.set(value, {
            value,
            label: parts.join(' — ') || value || unspecifiedLabels.keyCurve || '',
          });
        }
      });
      if (!options.size) {
        options.set('', {
          value: '',
          label: unspecifiedLabels.keyCurve || '',
        });
      }
      return Array.from(options.values());
    }

    function buildKeySizeOptions(presets) {
      const options = new Map();
      presets.forEach((preset) => {
        const value = preset.keySize != null ? String(preset.keySize) : '';
        if (!options.has(value)) {
          const parts = [];
          if (value) {
            parts.push(value);
          } else if (unspecifiedLabels.keySize) {
            parts.push(unspecifiedLabels.keySize);
          }
          if (preset.label) {
            parts.push(preset.label);
          }
          options.set(value, {
            value,
            label: parts.join(' — ') || value || unspecifiedLabels.keySize || '',
          });
        }
      });
      if (!options.size) {
        options.set('', {
          value: '',
          label: unspecifiedLabels.keySize || '',
        });
      }
      return Array.from(options.values());
    }

    function refresh() {
      usageSelect.value = state.usageType;
      const presets = KEY_PRESETS[state.usageType] || [];
      const keyTypeOptions = buildKeyTypeOptions(presets);
      if (!state.usageType || keyTypeOptions.length === 0) {
        state.keyType = '';
        state.keyCurve = '';
        state.keySize = '';
        setOptions(keyTypeSelect, [], state.keyType, {
          placeholderLabel: placeholders.keyType,
          disableIfEmpty: true,
        });
        setOptions(keyCurveSelect, [], state.keyCurve, {
          placeholderLabel: placeholders.keyCurve,
          disableIfEmpty: true,
        });
        setOptions(keySizeSelect, [], state.keySize, {
          placeholderLabel: placeholders.keySize,
          disableIfEmpty: true,
        });
        return;
      }

      if (!keyTypeOptions.some((option) => option.value === state.keyType)) {
        state.keyType = keyTypeOptions[0].value;
      }

      state.keyType = setOptions(keyTypeSelect, keyTypeOptions, state.keyType, {
        placeholderLabel: '',
        disableIfEmpty: false,
      });

      const combos = presets.filter((preset) => preset.keyType === state.keyType);
      if (combos.length === 0) {
        state.keyCurve = '';
        state.keySize = '';
        setOptions(keyCurveSelect, [{ value: '', label: unspecifiedLabels.keyCurve || '' }], state.keyCurve, {
          placeholderLabel: '',
          disableIfEmpty: false,
        });
        setOptions(keySizeSelect, [{ value: '', label: unspecifiedLabels.keySize || '' }], state.keySize, {
          placeholderLabel: '',
          disableIfEmpty: false,
        });
        return;
      }

      const normalizedCurve = state.keyCurve || '';
      const normalizedSize = state.keySize || '';
      const hasExactCombo = combos.some(
        (preset) => (preset.keyCurve || '') === normalizedCurve && String(preset.keySize ?? '') === normalizedSize,
      );
      if (!hasExactCombo) {
        const fallback = combos[0];
        state.keyCurve = fallback.keyCurve ? fallback.keyCurve : '';
        state.keySize = fallback.keySize != null ? String(fallback.keySize) : '';
      }

      state.keyCurve = setOptions(keyCurveSelect, buildKeyCurveOptions(combos), state.keyCurve, {
        placeholderLabel: '',
        disableIfEmpty: false,
      });
      state.keySize = setOptions(keySizeSelect, buildKeySizeOptions(combos), state.keySize, {
        placeholderLabel: '',
        disableIfEmpty: false,
      });
    }

    usageSelect.addEventListener('change', () => {
      state.usageType = usageSelect.value;
      state.keyType = '';
      state.keyCurve = '';
      state.keySize = '';
      refresh();
    });

    keyTypeSelect.addEventListener('change', () => {
      state.keyType = keyTypeSelect.value;
      state.keyCurve = '';
      state.keySize = '';
      refresh();
    });

    keyCurveSelect.addEventListener('change', () => {
      state.keyCurve = keyCurveSelect.value;
      refresh();
    });

    keySizeSelect.addEventListener('change', () => {
      state.keySize = keySizeSelect.value;
      refresh();
    });

    refresh();

    return {
      refresh,
      setState(newState) {
        if (!newState) {
          return;
        }
        if (Object.prototype.hasOwnProperty.call(newState, 'usageType')) {
          state.usageType = newState.usageType || '';
        }
        if (Object.prototype.hasOwnProperty.call(newState, 'keyType')) {
          state.keyType = newState.keyType || '';
        }
        if (Object.prototype.hasOwnProperty.call(newState, 'keyCurve')) {
          state.keyCurve = newState.keyCurve || '';
        }
        if (Object.prototype.hasOwnProperty.call(newState, 'keySize')) {
          state.keySize = newState.keySize || '';
        }
        refresh();
      },
    };
  }

  const editFormInitial = {{ edit_form_initial | tojson }};
  const shouldShowEditModal = {{ show_edit_modal | tojson }};

  const createController = createKeyFieldController({
    usageId: 'usage_type',
    keyTypeId: 'key_type',
    keyCurveId: 'key_curve',
    keySizeId: 'key_size',
  });

  const editController = createKeyFieldController({
    usageId: 'edit_usage_type',
    keyTypeId: 'edit_key_type',
    keyCurveId: 'edit_key_curve',
    keySizeId: 'edit_key_size',
  });

  const editFormActionTemplate = `{{ url_for('certs_ui.update_group', group_code='__PLACEHOLDER__') }}`;

  function fillEditForm(data) {
    if (!data) {
      return;
    }
    const form = document.getElementById('editGroupForm');
    if (!form) {
      return;
    }
    const groupCode = data.groupCode || '';
    form.action = editFormActionTemplate.replace('__PLACEHOLDER__', encodeURIComponent(groupCode));

    const codeField = form.querySelector('#edit_group_code');
    if (codeField) {
      codeField.value = groupCode;
    }

    const displayNameField = form.querySelector('#edit_display_name');
    if (displayNameField) {
      displayNameField.value = data.displayName || '';
    }

    const rotationField = form.querySelector('#edit_rotation_threshold_days');
    if (rotationField) {
      const rotationValue = data.rotationThresholdDays;
      if (rotationValue === undefined || rotationValue === null || rotationValue === '') {
        rotationField.value = '';
      } else {
        rotationField.value = String(rotationValue);
      }
    }

    const autoRotateInput = form.querySelector('#edit_auto_rotate');
    if (autoRotateInput) {
      autoRotateInput.checked = Boolean(data.autoRotate);
    }

    const subject = data.subject || {};
    {% for oid, field_name, label in subject_fields %}
    const {{ field_name }}Field = form.querySelector('#edit_{{ field_name }}');
    if ({{ field_name }}Field) {
      {{ field_name }}Field.value = subject['{{ oid }}'] || '';
    }
    {% endfor %}

    const usageTypeValue = data.usageType || '';
    const keyTypeValue = data.keyType || '';
    const keyCurveValue = data.keyCurve || '';
    const keySizeValue = data.keySize != null && data.keySize !== '' ? String(data.keySize) : '';

    if (editController) {
      editController.setState({
        usageType: usageTypeValue,
        keyType: keyTypeValue,
        keyCurve: keyCurveValue,
        keySize: keySizeValue,
      });
    } else {
      const usageSelect = form.querySelector('#edit_usage_type');
      if (usageSelect) {
        usageSelect.value = usageTypeValue;
      }
      const keyTypeSelect = form.querySelector('#edit_key_type');
      if (keyTypeSelect) {
        keyTypeSelect.value = keyTypeValue;
      }
      const keyCurveSelect = form.querySelector('#edit_key_curve');
      if (keyCurveSelect) {
        keyCurveSelect.value = keyCurveValue;
      }
      const keySizeSelect = form.querySelector('#edit_key_size');
      if (keySizeSelect) {
        keySizeSelect.value = keySizeValue;
      }
    }
  }

  const createModalElement = document.getElementById('createGroupModal');
  if (createModalElement && createModalElement.dataset.showOnLoad === 'true' && window.bootstrap) {
    bootstrap.Modal.getOrCreateInstance(createModalElement).show();
  }

  const editGroupModal = document.getElementById('editGroupModal');
  if (editGroupModal) {
    editGroupModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      if (!button) {
        return;
      }
      const groupData = button.getAttribute('data-group');
      if (!groupData) {
        return;
      }
      let parsed;
      try {
        parsed = JSON.parse(groupData);
      } catch (err) {
        console.error('Failed to parse group data', err);
        return;
      }
      fillEditForm(parsed);
    });

    if (shouldShowEditModal && editFormInitial && window.bootstrap) {
      fillEditForm(editFormInitial);
      bootstrap.Modal.getOrCreateInstance(editGroupModal).show();
    }
  }
})();
</script>
{% endblock %}

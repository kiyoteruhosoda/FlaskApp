{% extends "base.html" %}
{% block title %}{{ _('User Management') }}{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
{% endblock %}

{% block content %}
<h2>{{ _('Management') }}</h2>

<!-- Management Navigation Tabs -->
<ul class="nav nav-tabs mb-4">
  {% if current_user.can('user:manage') %}
  <li class="nav-item">
    <a class="nav-link active" href="{{ url_for('admin.user') }}">
      <i class="fas fa-users"></i> {{ _('User Management') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.google_accounts') }}">
      <i class="fab fa-google"></i> {{ _('Google Accounts') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.show_config') }}">
      <i class="fas fa-cogs"></i> {{ _('Config Settings') }}
    </a>
  </li>
  {% endif %}
  {% if current_user.can('role:manage') %}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.roles') }}">
      <i class="fas fa-user-tag"></i> {{ _('Roles') }}
    </a>
  </li>
  {% endif %}
  {% if current_user.can('permission:manage') %}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.permissions') }}">
      <i class="fas fa-shield-alt"></i> {{ _('Permissions') }}
    </a>
  </li>
  {% endif %}
</ul>

<h3>{{ _('User Management') }}</h3>
<div class="mb-3 d-flex justify-content-between align-items-center">
  <div>
    <a href="{{ url_for('admin.user_add') }}" class="btn btn-success">
      <i class="fas fa-user-plus"></i> {{ _('Add User') }}
    </a>
  </div>
  <div class="d-flex align-items-center admin-filter-actions">
    <input type="text" id="search-input" class="form-control form-control-sm admin-filter-input" placeholder="{{ _('Search users...') }}">
    <button id="refresh-btn" class="btn btn-outline-primary btn-sm">
      <i class="fas fa-refresh"></i> {{ _('Refresh') }}
    </button>
  </div>
</div>

<div id="user-stats" class="mb-3">
  <span id="user-count" class="badge bg-info">{{ _('Loading...') }}</span>
</div>

<div class="table-responsive">
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>ID</th>
        <th>{{ _('Email') }}</th>
        <th>{{ _('Status') }}</th>
        <th>{{ _('Roles') }}</th>
        <th>{{ _('Created At') }}</th>
        <th>{{ _('Actions') }}</th>
      </tr>
    </thead>
    <tbody id="users-body">
      <!-- ユーザーが動的に追加されます -->
    </tbody>
  </table>
</div>

<div id="loading-indicator" class="text-center" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">{{ _('Loading...') }}</span>
  </div>
  <p class="mt-2">{{ _('Loading more users...') }}</p>
</div>

<div id="no-more-data" class="text-center text-muted" style="display: none;">
  <p>{{ _('All users loaded') }}</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // 翻訳文字列の定義
  const translations = {
    active: '{{ _("Active") }}',
    inactive: '{{ _("Inactive") }}',
    usersLoaded: '{{ _("users loaded") }}',
    deactivate: '{{ _("deactivate") }}',
    activate: '{{ _("activate") }}',
    areYouSureYouWantTo: '{{ _("Are you sure you want to") }}',
    thisUser: '{{ _("this user?") }}'
  };

  const usersBody = document.getElementById('users-body');
  const loadingIndicator = document.getElementById('loading-indicator');
  const noMoreData = document.getElementById('no-more-data');
  const refreshBtn = document.getElementById('refresh-btn');
  const searchInput = document.getElementById('search-input');
  const userCount = document.getElementById('user-count');
  
  let infiniteScroll;
  let totalLoaded = 0;
  let searchTimeout;

  function formatDateTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleDateString();
  }

  function getCsrfToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    return metaTag ? metaTag.getAttribute('content') : '';
  }

  function createUserRow(user) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${user.id}</td>
      <td>${user.email}</td>
      <td>
        <span class="badge ${user.is_active ? 'bg-success' : 'bg-danger'}">
          ${user.is_active ? translations.active : translations.inactive}
        </span>
      </td>
      <td>
        ${user.roles.map(role => `<span class="badge bg-secondary">${role.name}</span>`).join(' ')}
      </td>
      <td><small>${formatDateTime(user.created_at)}</small></td>
      <td>
        <div class="btn-group btn-group-sm" role="group">
          <button class="btn ${user.is_active ? 'btn-warning' : 'btn-success'} btn-sm" 
                  onclick="toggleUserActive(${user.id}, ${user.is_active})" 
                  title="${user.is_active ? '{{ _("Deactivate User") }}' : '{{ _("Activate User") }}'}">
            <i class="fas ${user.is_active ? 'fa-user-slash' : 'fa-user-check'}"></i>
          </button>
          <button class="btn btn-outline-primary btn-sm" onclick="editUserRoles(${user.id})">
            {{ _('Edit Roles') }}
          </button>
          <button class="btn btn-warning btn-sm" onclick="resetUserTotp(${user.id})" title="{{ _('Reset TOTP') }}">
            <i class="fas fa-key"></i>
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})" title="{{ _('Delete User') }}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    `;
    return tr;
  }

  function initializeInfiniteScroll() {
    const searchQuery = searchInput.value.trim();
    const params = {};
    if (searchQuery) {
      params.search = searchQuery;
    }

    const paginationClient = new PaginationClient({
      baseUrl: '/api/admin/user',
      pageSize: 50,
      parameters: params,
      onItemsLoaded: (items, meta) => {
        if (meta.isFirstPage) {
          usersBody.innerHTML = '';
          totalLoaded = 0;
        }
        
        items.forEach(user => {
          const row = createUserRow(user);
          usersBody.appendChild(row);
          totalLoaded++;
        });
        
        userCount.textContent = `${totalLoaded} ${translations.usersLoaded}`;
      },
      onError: (error) => {
        console.error('Users loading error:', error);
        console.error('Error status:', error.status);
        console.error('Error response:', error.response);
        usersBody.innerHTML = '<tr><td colspan="6"><div class="alert alert-danger">{{ _("Failed to load users.") }}</div></td></tr>';
      }
    });

    infiniteScroll = new InfiniteScrollHelper({
      paginationClient: paginationClient,
      loadingIndicator: loadingIndicator,
      noMoreDataIndicator: noMoreData,
      container: document.body,
      threshold: 200
    });

    infiniteScroll.start();
  }

  function refreshUsers() {
    if (infiniteScroll) {
      infiniteScroll.destroy();
    }
    initializeInfiniteScroll();
  }

  // 検索機能
  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      refreshUsers();
    }, 500); // 500ms のデバウンス
  });

  // 更新ボタンの処理
  refreshBtn.addEventListener('click', refreshUsers);

  // グローバル関数（既存の管理機能との互換性のため）
  window.editUserRoles = function(userId) {
    // ユーザーのロール編集画面にリダイレクト
    window.location.href = `/admin/user/${userId}/edit-roles`;
  };

  window.resetUserTotp = function(userId) {
    if (!confirm('{{ _("Reset TOTP for this user?") }}')) return;
    
    fetch(`/admin/user/${userId}/reset-totp`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      }
    })
    .then(response => {
      if (response.ok) {
        showSuccessToast('{{ _("TOTP reset successfully") }}');
      } else {
        showErrorToast('{{ _("Failed to reset TOTP") }}');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showErrorToast('{{ _("Failed to reset TOTP") }}');
    });
  };

  window.deleteUser = function(userId) {
    if (!confirm('{{ _("Are you sure you want to delete this user?") }}')) return;
    
    fetch(`/admin/user/${userId}/delete`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      }
    })
    .then(response => {
      if (response.ok) {
        showSuccessToast('{{ _("User deleted successfully") }}');
        refreshUsers();
      } else {
        showErrorToast('{{ _("Failed to delete user") }}');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showErrorToast('{{ _("Failed to delete user") }}');
    });
  };

  window.toggleUserActive = function(userId, currentStatus) {
    const action = currentStatus ? translations.deactivate : translations.activate;
    if (!confirm(`${translations.areYouSureYouWantTo} ${action} ${translations.thisUser}`)) return;
    
    fetch(`/api/admin/user/${userId}/toggle-active`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showSuccessToast(data.message);
        refreshUsers();
      } else {
        showErrorToast(data.error || '{{ _("Failed to update user status") }}');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showErrorToast('{{ _("Failed to update user status") }}');
    });
  };

  // 初期化
  initializeInfiniteScroll();
});
</script>
{% endblock %}

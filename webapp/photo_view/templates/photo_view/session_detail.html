{% extends 'base.html' %}
{% block title %}Session Details{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-lg-row gap-2 align-items-lg-center justify-content-lg-between mb-3">
  <div>
    <h1 id="session-title" class="mb-1">{{ _("Session Details") }}</h1>
    <p id="session-subtitle" class="text-muted small mb-0 d-none"></p>
  </div>
  <a href="/photo-view" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-arrow-left"></i> {{ _("Back to Sessions") }}
  </a>
</div>

<div class="mb-3">
  <div class="d-flex flex-wrap gap-2">
    <button id="btn-import-start" class="btn btn-primary" disabled aria-disabled="true">
      {{ _("Start Import") }}
    </button>
    <button id="btn-local-import-stop" class="btn btn-outline-danger d-none" type="button">
      <i class="bi bi-stop-circle"></i> {{ _("Stop Local Import") }}
    </button>
  </div>
  <div id="local-import-status" class="mt-2 small text-muted d-none"></div>
  <div id="session-info" class="text-muted mt-2">
    {{ _("Loading session info...") }}
  </div>
</div>

<div id="import-status" class="mt-3" aria-live="polite"></div>

<div class="mt-4">
  <h2>{{ _("Selected Files") }}</h2>
  <p class="text-muted small mb-2">
    <i class="bi bi-info-circle"></i> {{ _("Failed files will be retried up to three times.") }}
  </p>
  <div id="selection-counts" class="mb-2 text-muted">{{ _("Loading...") }}</div>
  <form id="selection-filter-form" class="row gy-2 gx-2 gx-md-3 align-items-end mb-3">
    <div class="col-12 col-md-4 col-lg-3">
      <label for="selection-status-filter" class="form-label small mb-1">{{ _("Status") }}</label>
      <select id="selection-status-filter" class="form-select form-select-sm">
        <option value="">{{ _("All statuses") }}</option>
        <option value="pending">{{ _("Pending") }}</option>
        <option value="enqueued">{{ _("Enqueued") }}</option>
        <option value="running">{{ _("Running") }}</option>
        <option value="imported">{{ _("Imported") }}</option>
        <option value="failed">{{ _("Failed") }}</option>
        <option value="dup">{{ _("Duplicate") }}</option>
        <option value="skipped">{{ _("Skipped") }}</option>
      </select>
    </div>
    <div class="col-12 col-md-5 col-lg-4">
      <label for="selection-search-input" class="form-label small mb-1">{{ _("Search") }}</label>
      <div class="input-group input-group-sm">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="search"
               id="selection-search-input"
               class="form-control"
               placeholder="{{ _("Search selected files") }}"
               autocomplete="off">
      </div>
    </div>
    <div class="col-12 col-md-3 col-lg-auto d-flex gap-2">
      <button id="selection-filter-apply" class="btn btn-primary btn-sm flex-grow-1 flex-lg-grow-0" type="submit">
        <i class="bi bi-funnel me-1"></i>{{ _("Apply filters") }}
      </button>
      <button id="selection-filter-reset" class="btn btn-outline-secondary btn-sm flex-grow-1 flex-lg-grow-0" type="button">
        {{ _("Reset filters") }}
      </button>
    </div>
  </form>
  <div class="table-responsive">
    <table class="table table-sm">
      <thead>
        <tr>
          <th>{{ _("File") }}</th>
          <th>{{ _("Status") }}</th>
          <th>{{ _("Attempts") }}</th>
          <th>{{ _("Error") }}</th>
        </tr>
      </thead>
      <tbody id="selection-body">
        <!-- アイテムが動的に追加されます -->
      </tbody>
    </table>
  </div>
  <div id="selection-pagination" class="d-flex flex-column flex-md-row gap-2 align-items-md-center justify-content-md-between mt-2 d-none">
    <div id="selection-pagination-status" class="small text-muted"></div>
    <div class="d-flex align-items-center gap-2">
      <button id="selection-pagination-load" type="button" class="btn btn-outline-primary btn-sm">
        <span class="spinner-border spinner-border-sm align-text-bottom me-1 d-none" id="selection-pagination-spinner" role="status" aria-hidden="true"></span>
        {{ _("Load more") }}
      </button>
    </div>
  </div>
</div>

<div id="local-import-logs-section" class="mt-4 d-none">
  <h2>{{ _("Import Logs") }}</h2>
  <p class="text-muted small mb-2">
    <i class="bi bi-info-circle"></i> {{ _("ZIP extraction and file processing logs appear here while local import runs.") }}
  </p>
  <div class="table-responsive">
    <table class="table table-sm mb-0">
      <thead>
        <tr>
          <th style="width: 18%">{{ _("Time") }}</th>
          <th style="width: 18%">{{ _("Event") }}</th>
          <th style="width: 14%">{{ _("Status") }}</th>
          <th style="width: 12%">{{ _("Level") }}</th>
          <th>{{ _("Message") }}</th>
        </tr>
      </thead>
      <tbody id="local-import-log-body">
        <tr id="local-import-log-empty">
          <td colspan="5" class="text-center text-muted py-3">{{ _("No logs yet.") }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div id="server-data" 
     data-picker-session-id="{{ picker_session_id or '' }}" 
     style="display: none;"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  function escapeHtml(value) {
    if (value === null || value === undefined) {
      return '';
    }
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function resolveSessionId() {
    const params = new URLSearchParams(window.location.search);
    const fromQuery = params.get('session_id');
    if (fromQuery) return fromQuery;
    const serverDataEl = document.getElementById('server-data');
    const fromServer = serverDataEl.getAttribute('data-picker-session-id');
    return fromServer || '';
  }

  const pickerSessionId = resolveSessionId();
  if (!pickerSessionId) {
    window.location.href = '/photo-view';
    return;
  }

  if (/^\d+$/.test(pickerSessionId)) {
    console.warn('Numeric session ID detected, redirecting to sessions list');
    window.location.href = '/photo-view';
    return;
  }

  const importBtn = document.getElementById('btn-import-start');
  const stopLocalImportBtn = document.getElementById('btn-local-import-stop');
  const statusEl = document.getElementById('import-status');
  const selectionBody = document.getElementById('selection-body');
  const countsEl = document.getElementById('selection-counts');
  const sessionInfoEl = document.getElementById('session-info');
  const sessionTitleEl = document.getElementById('session-title');
  const sessionSubtitleEl = document.getElementById('session-subtitle');
  const localImportStatusEl = document.getElementById('local-import-status');
  const logSection = document.getElementById('local-import-logs-section');
  const logBody = document.getElementById('local-import-log-body');
  const selectionFilterForm = document.getElementById('selection-filter-form');
  const selectionStatusFilter = document.getElementById('selection-status-filter');
  const selectionSearchInput = document.getElementById('selection-search-input');
  const selectionFilterApplyBtn = document.getElementById('selection-filter-apply');
  const selectionFilterResetBtn = document.getElementById('selection-filter-reset');
  const selectionPaginationEl = document.getElementById('selection-pagination');
  const selectionPaginationStatusEl = document.getElementById('selection-pagination-status');
  const selectionPaginationButton = document.getElementById('selection-pagination-load');
  const selectionPaginationSpinner = document.getElementById('selection-pagination-spinner');
  const viewErrorDetailsLabel = '{{ _("View error details") }}';

  const selectionStatusLabels = {
    pending: '{{ _("Pending") }}',
    enqueued: '{{ _("Enqueued") }}',
    running: '{{ _("Running") }}',
    imported: '{{ _("Imported") }}',
    failed: '{{ _("Failed") }}',
    dup: '{{ _("Duplicate") }}',
    skipped: '{{ _("Skipped") }}'
  };

  const sessionStatusLabels = {
    pending: '{{ _("Pending") }}',
    ready: '{{ _("Ready") }}',
    expanding: '{{ _("Expanding") }}',
    processing: '{{ _("Processing") }}',
    enqueued: '{{ _("Enqueued") }}',
    importing: '{{ _("Importing") }}',
    imported: '{{ _("Imported") }}',
    canceled: '{{ _("Canceled") }}',
    expired: '{{ _("Expired") }}',
    error: '{{ _("Error") }}',
    failed: '{{ _("Failed") }}'
  };

  const sessionStageLabels = {
    expanding: '{{ _("Expanding") }}',
    processing: '{{ _("Processing") }}',
    importing: '{{ _("Importing") }}'
  };

  const noLogsMessage = '{{ _("No logs yet.") }}';

  const localImportRunningMessage = '{{ _("Local import is running. You can stop it if needed.") }}';
  const localImportCancelingMessage = '{{ _("Canceling local import...") }}';
  const localImportCanceledMessage = '{{ _("Local import was canceled.") }}';
  const localImportStopFailedMessage = '{{ _("Failed to stop local import.") }}';
  const localImportCancelConfirmMessage = '{{ _("Are you sure you want to cancel the local import?") }}';

  function getStatusBadgeClass(status) {
    switch (status) {
      case 'pending': return 'secondary';
      case 'enqueued': return 'info';
      case 'running': return 'warning';
      case 'imported': return 'success';
      case 'failed': return 'danger';
      case 'dup': return 'light text-dark border border-secondary-subtle';
      default: return 'secondary';
    }
  }

  function getSessionBadgeClass(status) {
    switch (status) {
      case 'pending': return 'secondary';
      case 'ready': return 'primary';
      case 'expanding': return 'warning';
      case 'processing': return 'warning';
      case 'importing': return 'info';
      case 'imported': return 'success';
      case 'expired': return 'danger';
      case 'error':
      case 'failed':
        return 'danger';
      default:
        return 'secondary';
    }
  }

  function getLevelBadgeClass(level) {
    switch ((level || '').toUpperCase()) {
      case 'ERROR':
      case 'CRITICAL':
        return 'danger';
      case 'WARNING':
        return 'warning';
      case 'INFO':
        return 'info';
      case 'DEBUG':
        return 'secondary';
      default:
        return 'secondary';
    }
  }

  function getStatusBadgeClass(status) {
    switch ((status || '').toLowerCase()) {
      case 'success':
      case 'completed':
      case 'extracted':
      case 'imported':
        return 'success';
      case 'processing':
      case 'running':
      case 'scanning':
      case 'queued':
        return 'primary';
      case 'copied':
      case 'cleaned':
      case 'duplicate':
      case 'skipped':
      case 'detected':
        return 'secondary';
      case 'warning':
      case 'retrying':
      case 'empty':
        return 'warning';
      case 'failed':
      case 'error':
      case 'missing':
      case 'unsupported':
        return 'danger';
      case 'canceled':
        return 'dark';
      default:
        return 'secondary';
    }
  }

  function formatLogDetails(details) {
    if (!details || typeof details !== 'object') {
      return '';
    }

    const entries = Object.entries(details)
      .map(([key, value]) => {
        if (value === null || value === undefined || value === '') {
          return null;
        }
        let normalized = value;
        if (typeof normalized === 'object') {
          try {
            normalized = JSON.stringify(normalized);
          } catch (err) {
            normalized = String(normalized);
          }
        }
        return `${escapeHtml(key)}=${escapeHtml(String(normalized))}`;
      })
      .filter(Boolean);

    return entries.join(', ');
  }

  function renderLocalImportLogs(logs = [], showSection = isLocalImport) {
    if (!logSection || !logBody) {
      return;
    }

    if (!showSection) {
      logSection.classList.add('d-none');
      logBody.innerHTML = '';
      return;
    }

    logSection.classList.remove('d-none');
    logBody.innerHTML = '';

    if (!logs || logs.length === 0) {
      const emptyRow = document.createElement('tr');
      emptyRow.id = 'local-import-log-empty';
      emptyRow.innerHTML = `<td colspan="5" class="text-center text-muted py-3">${escapeHtml(noLogsMessage)}</td>`;
      logBody.appendChild(emptyRow);
      return;
    }

    logs.forEach((log) => {
      const row = document.createElement('tr');
      const level = (log.level || '').toUpperCase();
      const badgeClass = getLevelBadgeClass(level);
      const statusText = (log.status || '').toString();
      const statusBadgeClass = getStatusBadgeClass(statusText);
      const detailsText = formatLogDetails(log.details);

      const messageHtml = [
        escapeHtml(log.message || ''),
        detailsText ? `<div class="text-muted small">${detailsText}</div>` : ''
      ].join('');

      row.innerHTML = `
        <td>${escapeHtml(formatPreciseDateTime(log.createdAt))}</td>
        <td>${log.event ? `<code>${escapeHtml(log.event)}</code>` : '-'}</td>
        <td>${statusText ? `<span class="badge bg-${statusBadgeClass}">${escapeHtml(statusText)}</span>` : '-'}</td>
        <td>${level ? `<span class="badge bg-${badgeClass}">${escapeHtml(level)}</span>` : '-'}</td>
        <td>${messageHtml}</td>
      `;

      logBody.appendChild(row);
    });
  }

  let paginationClient;
  let isLocalImport = false;
  let latestStatus = 'unknown';
  let isRefreshing = false;
  let currentCounts = {};
  let displayedSelectionCount = 0;
  const selectionFilterState = {
    status: '',
    search: '',
  };

  function sleep(ms) {
    return new Promise((resolve) => {
      window.setTimeout(resolve, ms);
    });
  }

  function buildSelectionRequestParams() {
    const params = {};
    if (selectionFilterState.status) {
      params.status = selectionFilterState.status;
    }
    if (selectionFilterState.search) {
      params.search = selectionFilterState.search;
    }
    return params;
  }

  function updateSelectionFilterStateFromInputs() {
    const rawStatus = selectionStatusFilter ? selectionStatusFilter.value : '';
    selectionFilterState.status = (rawStatus || '').trim().toLowerCase();

    if (selectionSearchInput) {
      selectionFilterState.search = selectionSearchInput.value.trim();
    } else {
      selectionFilterState.search = '';
    }
  }

  function resetSelectionFilterInputs() {
    if (selectionStatusFilter) {
      selectionStatusFilter.value = '';
    }
    if (selectionSearchInput) {
      selectionSearchInput.value = '';
    }
    selectionFilterState.status = '';
    selectionFilterState.search = '';
  }

  async function reloadSelectionsWithFilters() {
    updateSelectionFilterStateFromInputs();
    if (paginationClient) {
      paginationClient.defaultParams = buildSelectionRequestParams();
    }

    if (selectionFilterApplyBtn) {
      selectionFilterApplyBtn.disabled = true;
      selectionFilterApplyBtn.setAttribute('aria-busy', 'true');
    }

    try {
      let attempts = 0;
      while (isRefreshing && attempts < 40) {
        // eslint-disable-next-line no-await-in-loop
        await sleep(50);
        attempts += 1;
      }

      if (isRefreshing) {
        window.setTimeout(() => {
          refreshSelections();
        }, 0);
        return;
      }

      await refreshSelections();
    } finally {
      if (selectionFilterApplyBtn) {
        selectionFilterApplyBtn.disabled = false;
        selectionFilterApplyBtn.removeAttribute('aria-busy');
      }
    }
  }

  function formatDateTime(isoString) {
    if (!isoString) return '-';
    const helper = window.appTime;
    if (helper && typeof helper.formatDateTime === 'function') {
      const formatted = helper.formatDateTime(isoString);
      if (formatted) {
        return formatted;
      }
    }
    try {
      const date = new Date(isoString);
      return Number.isNaN(date.getTime()) ? '-' : date.toLocaleString();
    } catch (e) {
      return isoString;
    }
  }

  function formatPreciseDateTime(isoString) {
    if (!isoString) {
      return '-';
    }

    const options = {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      fractionalSecondDigits: 3,
      hour12: false,
    };

    const helper = window.appTime;
    if (helper && typeof helper.formatDateTime === 'function') {
      try {
        const formatted = helper.formatDateTime(isoString, options);
        if (formatted) {
          return formatted;
        }
      } catch (error) {
        console.warn('Failed to format precise datetime via appTime', error);
      }
    }

    try {
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) {
        return '-';
      }
      if (typeof Intl !== 'undefined' && typeof Intl.DateTimeFormat === 'function') {
        try {
          return new Intl.DateTimeFormat(undefined, options).format(date);
        } catch (error) {
          console.warn('Intl precise formatting failed', error);
        }
      }
      return date.toISOString();
    } catch (error) {
      return isoString;
    }
  }

  function formatCounts(counts) {
    if (!counts || Object.keys(counts).length === 0) {
      return '';
    }
    return Object.entries(counts)
      .map(([status, count]) => `${selectionStatusLabels[status] || status}: ${count}`)
      .join(', ');
  }

  function totalFromCounts(counts = {}) {
    return Object.values(counts).reduce((total, value) => total + (Number(value) || 0), 0);
  }

  function duplicateCount(counts = {}) {
    return Number(counts?.dup || 0);
  }

  function hasOnlyDuplicates(counts = {}) {
    let dupTotal = 0;
    let otherTotal = 0;

    Object.entries(counts).forEach(([status, count]) => {
      const numericCount = Number(count) || 0;
      if (status === 'dup') {
        dupTotal += numericCount;
      } else if (numericCount > 0) {
        otherTotal += numericCount;
      }
    });

    return dupTotal > 0 && otherTotal === 0;
  }

  function determineDisplayStatus(sessionData) {
    const baseStatus = sessionData?.status || 'pending';
    if (['processing', 'importing', 'error', 'failed'].includes(baseStatus) && hasOnlyDuplicates(sessionData?.counts || {})) {
      return 'imported';
    }
    return baseStatus;
  }

  function deriveSelectedCount(sessionData) {
    const countsTotal = totalFromCounts(sessionData?.counts || {});
    if (countsTotal > 0) {
      return countsTotal;
    }
    const selected = sessionData?.selectedCount;
    if (typeof selected === 'number' && selected > 0) {
      return selected;
    }
    return selected || 0;
  }

  function createSelectionRow(selection) {
    const tr = document.createElement('tr');
    const displayName = selection.filename || selection.googleMediaId || 'N/A';
    const safeDisplayName = escapeHtml(displayName);
    const canDisplayLink = selection.mediaId && ['imported', 'dup'].includes(selection.status);
    const fileCellContent = canDisplayLink
      ? `<a href="/photo-view/media/${selection.mediaId}" class="text-decoration-none">${safeDisplayName}</a>`
      : safeDisplayName;
    const errorMessageHtml = selection.error
      ? `<div class="text-danger small">${escapeHtml(selection.error)}</div>`
      : '<span class="text-muted small">-</span>';
    const errorLinkHtml = selection.errorDetailsUrl
      ? `<div><a href="${escapeHtml(selection.errorDetailsUrl)}" class="small link-danger link-offset-2">${escapeHtml(viewErrorDetailsLabel)}</a></div>`
      : '';
    tr.innerHTML = `
      <td>${fileCellContent}</td>
      <td>
        <span class="badge bg-${getStatusBadgeClass(selection.status)}">
          ${selectionStatusLabels[selection.status] || selection.status}
        </span>
      </td>
      <td>${selection.attempts}</td>
      <td>${errorMessageHtml}${errorLinkHtml}</td>
    `;
    return tr;
  }

  function updateSelectionPagination(meta = {}) {
    if (!selectionPaginationEl || !selectionPaginationButton || !selectionPaginationStatusEl) {
      return;
    }

    const total = typeof meta.total === 'number' ? meta.total : meta.totalCount;
    const hasNext = Boolean(meta.hasNext);
    const hasItems = displayedSelectionCount > 0;

    if (!hasItems && !hasNext) {
      selectionPaginationEl.classList.add('d-none');
      selectionPaginationStatusEl.textContent = '';
      return;
    }

    selectionPaginationEl.classList.remove('d-none');

    if (typeof total === 'number' && !Number.isNaN(total) && total >= 0) {
      const formattedCurrent = displayedSelectionCount.toLocaleString();
      const formattedTotal = total.toLocaleString();
      selectionPaginationStatusEl.textContent = `{{ _("Showing") }} ${formattedCurrent} / ${formattedTotal}`;
    } else {
      selectionPaginationStatusEl.textContent = `{{ _("Showing") }} ${displayedSelectionCount.toLocaleString()}`;
    }

    selectionPaginationButton.disabled = !hasNext;
    selectionPaginationButton.classList.toggle('disabled', !hasNext);
    selectionPaginationButton.classList.toggle('d-none', !hasNext);
    if (!hasNext && selectionPaginationSpinner) {
      selectionPaginationSpinner.classList.add('d-none');
    }
  }

  function setSelectionPaginationLoading(isLoading) {
    if (!selectionPaginationButton || !selectionPaginationSpinner) {
      return;
    }
    if (isLoading) {
      selectionPaginationSpinner.classList.remove('d-none');
      selectionPaginationButton.disabled = true;
      selectionPaginationButton.classList.add('disabled');
    } else {
      selectionPaginationSpinner.classList.add('d-none');
    }
  }

  function buildEmptyMessage(sessionStatus) {
    if (sessionStatus === 'processing') {
      return '<i class="bi bi-clock"></i> Celery処理待ち中...';
    }
    if (sessionStatus === 'ready') {
      return '<i class="bi bi-info-circle"></i> 対象ファイルがありません';
    }
    if (sessionStatus === 'imported') {
      return '<i class="bi bi-check-circle"></i> 処理完了（対象ファイル: 0件）';
    }
    if (sessionStatus === 'error') {
      return '<i class="bi bi-exclamation-triangle text-danger"></i> 処理エラー';
    }
    return '<i class="bi bi-info-circle"></i> 対象ファイルがありません';
  }

  function updateCountsDisplay(counts, sessionStatus) {
    if (counts && Object.keys(counts).length > 0) {
      if (hasOnlyDuplicates(counts)) {
        const dupTotal = duplicateCount(counts);
        const duplicateLabel = selectionStatusLabels.dup || 'Duplicate';
        countsEl.textContent = `${duplicateLabel}: ${dupTotal}`;
      } else {
        countsEl.textContent = formatCounts(counts);
      }
      return;
    }

    if (sessionStatus === 'processing') {
      countsEl.textContent = 'ステータス: 処理待ち';
    } else if (sessionStatus === 'ready') {
      countsEl.textContent = '選択されたファイル: 0件';
    } else if (sessionStatus === 'imported') {
      countsEl.textContent = '処理完了: 0件';
    } else if (sessionStatus === 'error') {
      countsEl.textContent = 'ステータス: エラー';
    } else {
      countsEl.textContent = '選択されたファイル: 0件';
    }
  }

  function updateImportButtonState(sessionData) {
    if (!sessionData) return;
    if (sessionData.isLocalImport) {
      importBtn.style.display = 'none';
      importBtn.disabled = true;
      importBtn.classList.add('disabled');
      importBtn.setAttribute('aria-disabled', 'true');
      return;
    }

    importBtn.style.display = '';
    const canImport = sessionData.status === 'ready';
    importBtn.disabled = !canImport;
    importBtn.classList.toggle('disabled', !canImport);
    importBtn.setAttribute('aria-disabled', (!canImport).toString());
  }

  function updateLocalImportControls(sessionData) {
    if (!stopLocalImportBtn || !localImportStatusEl) {
      return;
    }

    stopLocalImportBtn.classList.add('d-none');
    stopLocalImportBtn.disabled = true;
    stopLocalImportBtn.setAttribute('aria-disabled', 'true');
    localImportStatusEl.classList.add('d-none');
    localImportStatusEl.classList.remove('text-warning', 'text-danger', 'text-success');
    localImportStatusEl.classList.add('text-muted');
    localImportStatusEl.textContent = '';

    if (!sessionData || !sessionData.isLocalImport) {
      return;
    }

    const cancellableStatuses = ['expanding', 'processing', 'importing', 'enqueued'];
    const stats = sessionData.stats || {};
    const cancelRequested = Boolean(stats.cancel_requested);
    const displayStatus = sessionData.status;

    localImportStatusEl.classList.remove('d-none');

    if (displayStatus === 'canceled') {
      localImportStatusEl.textContent = localImportCanceledMessage;
      localImportStatusEl.classList.remove('text-muted');
      localImportStatusEl.classList.add('text-danger');
      return;
    }

    if (cancelRequested) {
      localImportStatusEl.textContent = localImportCancelingMessage;
      localImportStatusEl.classList.remove('text-muted');
      localImportStatusEl.classList.add('text-warning');
      return;
    }

    if (cancellableStatuses.includes(displayStatus)) {
      localImportStatusEl.textContent = localImportRunningMessage;
      stopLocalImportBtn.classList.remove('d-none');
      stopLocalImportBtn.disabled = false;
      stopLocalImportBtn.setAttribute('aria-disabled', 'false');
      return;
    }

    localImportStatusEl.textContent = '{{ _("Local import session runs automatically.") }}';
  }

  function updateSessionInfo(sessionData) {
    if (!sessionData) {
      return;
    }

    if (sessionTitleEl) {
      sessionTitleEl.textContent = sessionData.isLocalImport
        ? '{{ _("Local Import Session") }}'
        : '{{ _("Session Details") }}';
    }

    if (sessionSubtitleEl) {
      const subtitleParts = [];
      if (sessionData.sessionId) {
        subtitleParts.push(sessionData.sessionId);
      }
      if (!sessionData.isLocalImport && sessionData.accountEmail) {
        subtitleParts.push(sessionData.accountEmail);
      }
      sessionSubtitleEl.textContent = subtitleParts.join(' • ');
      sessionSubtitleEl.classList.toggle('d-none', subtitleParts.length === 0);
    }

    const stats = sessionData.stats || {};
    const accountLabel = sessionData.isLocalImport
      ? '{{ _("Local Import") }}'
      : (sessionData.accountEmail || '-');
    const selectedCount = deriveSelectedCount(sessionData);
    const countsSummary = formatCounts(sessionData.counts) || '-';
    const createdAt = formatDateTime(sessionData.createdAt);
    const lastProgress = formatDateTime(sessionData.lastProgressAt);
    const statusLabel = sessionStatusLabels[sessionData.status] || sessionData.status || '-';
    const statusBadge = `<span class="badge bg-${getSessionBadgeClass(sessionData.status)}">${statusLabel}</span>`;

    const infoParts = [];
    infoParts.push(`<div><strong>{{ _("Status") }}:</strong> ${statusBadge}</div>`);

    if (sessionData.isLocalImport) {
      const stageValue = stats.stage;
      if (typeof stageValue === 'string' && stageValue.trim().length > 0) {
        const normalizedStage = stageValue.trim().toLowerCase();
        const stageLabel = sessionStageLabels[normalizedStage] || sessionStatusLabels[normalizedStage] || stageValue;
        infoParts.push(`<div><strong>{{ _("Current Stage") }}:</strong> ${escapeHtml(stageLabel)}</div>`);
      }
    }

    infoParts.push(`<div><strong>{{ _("Target Account") }}:</strong> ${accountLabel}</div>`);
    infoParts.push(`<div><strong>{{ _("Selected Files") }}:</strong> ${selectedCount}</div>`);
    infoParts.push(`<div><strong>{{ _("File Status") }}:</strong> ${countsSummary}</div>`);
    infoParts.push(`<div><strong>{{ _("Created At") }}:</strong> ${createdAt}</div>`);
    infoParts.push(`<div><strong>{{ _("Last Progress") }}:</strong> ${lastProgress}</div>`);

    if (sessionData.isLocalImport) {
      if (sessionData.status === 'canceled') {
        infoParts.push(`<div class="mt-2 text-muted"><i class="bi bi-x-circle"></i> {{ _("Local import was canceled.") }}</div>`);
      } else if (stats.cancel_requested) {
        infoParts.push(`<div class="mt-2 text-warning"><i class="bi bi-hourglass-split"></i> {{ _("Canceling local import...") }}</div>`);
      } else {
        infoParts.push(`<div class="mt-2 text-muted"><i class="bi bi-info-circle"></i> {{ _("Local Import Session. Import runs automatically.") }}</div>`);
      }
    } else if (sessionData.status !== 'ready') {
      infoParts.push(`<div class="mt-2 text-warning"><i class="bi bi-exclamation-triangle"></i> {{ _("Import can only be started when the session status is ready.") }}</div>`);
    }

    sessionInfoEl.innerHTML = infoParts.join('');
    updateLocalImportControls(sessionData);
  }

  async function withBusy(btn, fn) {
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> {{ _("Working...") }}';
    btn.disabled = true;
    btn.setAttribute('aria-busy', 'true');
    try {
      return await fn();
    } finally {
      btn.innerHTML = originalHtml;
      btn.disabled = false;
      btn.removeAttribute('aria-busy');
    }
  }

  async function fetchSessionStatus() {
    try {
      const resp = await window.apiClient.get(`/api/picker/session/${encodeURIComponent(pickerSessionId)}`);
      if (resp.status === 404) {
        window.location.href = '/photo-view';
        return null;
      }
      if (resp.status === 401 || resp.status === 302) {
        window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname + window.location.search);
        return null;
      }
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}`);
      }

      const data = await resp.json();
      data.counts = data.counts || {};
      data.status = determineDisplayStatus(data);
      isLocalImport = Boolean(data.isLocalImport);
      updateImportButtonState(data);
      updateSessionInfo(data);
      return data;
    } catch (error) {
      console.warn('Failed to fetch session status:', error);
      return null;
    }
  }

  async function fetchSessionLogs() {
    if (!pickerSessionId) {
      return;
    }

    if (!isLocalImport) {
      renderLocalImportLogs([], false);
      return;
    }

    try {
      const resp = await window.apiClient.get(`/api/picker/session/${encodeURIComponent(pickerSessionId)}/logs?limit=50`);
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}`);
      }

      const payload = await resp.json().catch(() => ({}));
      renderLocalImportLogs(payload.logs || [], true);
    } catch (error) {
      console.warn('Failed to fetch session logs:', error);
    }
  }

  async function stopLocalImportSession() {
    if (!pickerSessionId || !stopLocalImportBtn) {
      return;
    }

    await withBusy(stopLocalImportBtn, async () => {
      try {
        const resp = await window.apiClient.post(`/api/sync/local-import/${encodeURIComponent(pickerSessionId)}/stop`);

        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          console.error('Failed to stop local import:', resp.status, text);
          statusEl.textContent = localImportStopFailedMessage;
          showErrorToast(localImportStopFailedMessage);
          return;
        }

        const payload = await resp.json().catch(() => ({}));
        const message = (payload && payload.message) ? payload.message : localImportCanceledMessage;
        statusEl.textContent = message;
        showInfoToast(message, 4000);
        await fetchSessionStatus();
        await refreshSelections();
      } catch (error) {
        console.error('Stop local import failed:', error);
        statusEl.textContent = localImportStopFailedMessage;
        showErrorToast(localImportStopFailedMessage);
      }
    });
  }

  async function refreshSelections() {
    if (isRefreshing) {
      return;
    }
    isRefreshing = true;
    const currentFilterParams = buildSelectionRequestParams();
    try {
      const sessionData = await fetchSessionStatus();
      latestStatus = sessionData?.status || latestStatus;
      currentCounts = sessionData?.counts || currentCounts || {};
      updateCountsDisplay(currentCounts, latestStatus);

      if (sessionData && sessionData.isLocalImport) {
        await fetchSessionLogs();
      } else {
        renderLocalImportLogs([], false);
      }

      if (!paginationClient) {
        paginationClient = new PaginationClient({
          baseUrl: `/api/picker/session/${encodeURIComponent(pickerSessionId)}/selections`,
          pageSize: 200,
          autoLoad: false,
          parameters: currentFilterParams,
          onItemsLoaded: (items, meta) => {
            if (meta.currentPage === 1) {
              selectionBody.innerHTML = '';
              displayedSelectionCount = 0;
            }

            if (items.length === 0 && meta.currentPage === 1) {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td colspan="4" class="text-center text-muted py-4">
                  ${buildEmptyMessage(latestStatus)}
                </td>
              `;
              selectionBody.appendChild(tr);
              updateSelectionPagination({ hasNext: false, total: 0 });
            } else {
              items.forEach(selection => {
                const row = createSelectionRow(selection);
                selectionBody.appendChild(row);
              });
              displayedSelectionCount += items.length;
            }

            updateSelectionPagination({
              hasNext: meta.hasNext,
              total: meta.total,
              totalCount: meta.total,
            });
          },
          onError: (error) => {
            console.error('Selection loading error:', error);
          },
          onLoadingStateChange: (state) => {
            setSelectionPaginationLoading(state);
          },
        });
        paginationClient.defaultParams = currentFilterParams;
        if (selectionPaginationButton) {
          selectionPaginationButton.addEventListener('click', () => {
            if (paginationClient) {
              paginationClient.loadNext();
            }
          });
        }
      } else {
        paginationClient.defaultParams = currentFilterParams;
      }

      const loadedPagesBeforeRefresh = paginationClient
        ? Math.max(0, paginationClient.currentPage - 1)
        : 0;

      await paginationClient.loadFirst();

      if (paginationClient && loadedPagesBeforeRefresh > 1) {
        const additionalPagesToReload = loadedPagesBeforeRefresh - 1;
        for (let pageIndex = 0; pageIndex < additionalPagesToReload; pageIndex += 1) {
          if (!paginationClient.hasNext) {
            break;
          }
          // 既に読み込んでいるページ数を維持するため、順次再取得する
          // setIntervalによる定期リフレッシュ時に「さらに読み込む」で追加表示した行が
          // 消えてしまう問題を防ぐ。
          // eslint-disable-next-line no-await-in-loop
          await paginationClient.loadNext();
        }
      }
    } catch (err) {
      console.error(err);
    } finally {
      isRefreshing = false;
    }
  }

  if (stopLocalImportBtn) {
    stopLocalImportBtn.addEventListener('click', () => {
      if (!window.confirm(localImportCancelConfirmMessage)) {
        return;
      }

      stopLocalImportSession();
    });
  }

  if (selectionFilterForm) {
    selectionFilterForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      await reloadSelectionsWithFilters();
    });
  }

  if (selectionFilterResetBtn) {
    selectionFilterResetBtn.addEventListener('click', async () => {
      resetSelectionFilterInputs();
      await reloadSelectionsWithFilters();
    });
  }

  importBtn.addEventListener('click', async () => {
    if (!pickerSessionId) return;

    if (importBtn.disabled) {
      if (isLocalImport) {
        statusEl.textContent = 'ローカルインポートセッションでは手動インポートできません。';
      } else {
        statusEl.textContent = '{{ _("Import is not available for the current status.") }}';
      }
      return;
    }

    await withBusy(importBtn, async () => {
      try {
        const resp = await window.apiClient.post(`/api/picker/session/${encodeURIComponent(pickerSessionId)}/import`);

        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          console.error('Import start failed:', resp.status, text);
          statusEl.textContent = '{{ _("Failed to start import.") }}';
          showErrorToast('{{ _("Failed to start import.") }}');
          return;
        }

        statusEl.textContent = '{{ _("Import started.") }}';
        showSuccessToast('{{ _("Import started.") }}');
        refreshSelections();
      } catch (err) {
        console.error(err);
        statusEl.textContent = '{{ _("Failed to start import.") }}';
        showErrorToast('{{ _("Failed to start import.") }}');
      }
    });
  });

  setInterval(refreshSelections, 3000);
  refreshSelections();
});
</script>
{% endblock %}
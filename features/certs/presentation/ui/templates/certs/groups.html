{% extends "base.html" %}
{% block title %}{{ _('Certificate Groups') }} | {{ super() }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3">{{ _('Certificate Groups') }}</h1>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
    <i class="bi bi-plus-circle me-1"></i>{{ _('Create Group') }}
  </button>
</div>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th scope="col">{{ _('Group Code') }}</th>
        <th scope="col">{{ _('Display Name') }}</th>
        <th scope="col">{{ _('Usage') }}</th>
        <th scope="col">{{ _('Auto Rotate') }}</th>
        <th scope="col">{{ _('Rotation Threshold (days)') }}</th>
        <th scope="col">{{ _('Key Type') }}</th>
        <th scope="col">{{ _('Subject') }}</th>
        <th scope="col">{{ _('Updated At') }} <small class="text-muted">UTC</small></th>
        <th scope="col" class="text-end">{{ _('Actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% if groups %}
        {% for group in groups %}
        <tr>
          <td class="font-monospace">{{ group.group_code }}</td>
          <td>{{ group.display_name or '-' }}</td>
          <td>{{ group.usage_type.value }}</td>
          <td>
            {% if group.auto_rotate %}
            <span class="badge bg-success">{{ _('Enabled') }}</span>
            {% else %}
            <span class="badge bg-secondary">{{ _('Disabled') }}</span>
            {% endif %}
          </td>
          <td>{{ group.rotation_threshold_days }}</td>
          <td>
            {{ group.key_type }}{% if group.key_size %} {{ group.key_size }}{% endif %}{% if group.key_curve %} / {{ group.key_curve }}{% endif %}
          </td>
          <td>
            {% if group.subject %}
              {% for key, value in group.subject.items() %}
              <span class="badge text-bg-light me-1">{{ key }}={{ value }}</span>
              {% endfor %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td>{{ group.updated_at.strftime('%Y-%m-%d %H:%M:%S') if group.updated_at else '-' }}</td>
          <td class="text-end">
            <div class="d-flex justify-content-end flex-wrap gap-2 certificate-group-actions">
              <a class="btn btn-outline-primary btn-sm" href="{{ url_for('certs_ui.group_detail', group_code=group.group_code) }}">
                {{ _('View Certificates') }}
              </a>
              <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editGroupModal" data-group='{{ {
                  "groupCode": group.group_code,
                  "displayName": group.display_name,
                  "usageType": group.usage_type.value,
                  "keyType": group.key_type,
                  "keyCurve": group.key_curve,
                  "keySize": group.key_size,
                  "autoRotate": group.auto_rotate,
                  "rotationThresholdDays": group.rotation_threshold_days,
                  "subject": group.subject
                } | tojson }}'>
                {{ _('Edit') }}
              </button>
              <form class="certificate-group-actions__form" method="post" action="{{ url_for('certs_ui.delete_group', group_code=group.group_code) }}" onsubmit="return confirm('{{ _('Are you sure you want to delete this group?') }}');">
                <button type="submit" class="btn btn-outline-danger btn-sm">{{ _('Delete') }}</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      {% else %}
      <tr>
        <td colspan="9" class="text-center text-muted py-4">{{ _('No certificate groups available.') }}</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true" data-show-on-load="{{ 'true' if show_create_modal else 'false' }}">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{{ url_for('certs_ui.create_group') }}">
        <div class="modal-header">
          <h2 class="modal-title h5" id="createGroupModalLabel">{{ _('Create Certificate Group') }}</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
        </div>
        <div class="modal-body">
          {% set errors = create_form_errors | default([]) %}
          {% if errors %}
          <div class="alert alert-danger" role="alert">
            <ul class="mb-0">
              {% for message in errors %}
              <li>{{ message }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="group_code">{{ _('Group Code') }} <span class="text-danger">*</span></label>
              <input
                class="form-control"
                type="text"
                id="group_code"
                name="group_code"
                required
                pattern="[a-z0-9_-]+"
                title="{{ _('Group code must contain only lowercase letters, numbers, hyphen, or underscore.') }}"
                autocapitalize="none"
                autocomplete="off"
                value="{{ create_form_values.get('group_code', '') }}"
              >
              <p class="form-text text-muted small mb-0">{{ _('Group code must contain only lowercase letters, numbers, hyphen, or underscore.') }}</p>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="display_name">{{ _('Display Name') }}</label>
              <input class="form-control" type="text" id="display_name" name="display_name" value="{{ create_form_values.get('display_name', '') }}">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="usage_type">{{ _('Usage Type') }} <span class="text-danger">*</span></label>
              <select class="form-select" id="usage_type" name="usage_type" required data-initial="{{ create_form_values.get('usage_type', '') }}">
                {% for value, label in usage_options %}
                <option value="{{ value }}" {% if create_form_values.get('usage_type') == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="key_preset">{{ _('Key Parameters') }} <span class="text-danger">*</span></label>
              {% set custom_label_template = _('Custom configuration (%(details)s)', details='%(details)s') %}
              {% set custom_label_fallback = custom_label_template | replace('%(details)s', '-') %}
              <select
                class="form-select"
                id="key_preset"
                name="key_preset"
                required
                data-initial="{{ create_form_values.get('key_preset', '') }}"
                data-placeholder="{{ _('Select key parameters') }}"
                data-custom-label="{{ custom_label_fallback }}"
                data-custom-label-template="{{ custom_label_template }}"
              ></select>
              <input type="hidden" id="key_type" name="key_type" value="{{ create_form_values.get('key_type', '') }}">
              <input type="hidden" id="key_curve" name="key_curve" value="{{ create_form_values.get('key_curve', '') }}">
              <input type="hidden" id="key_size" name="key_size" value="{{ create_form_values.get('key_size', '') }}">
            </div>
            <div class="col-md-3">
              <label class="form-label" for="rotation_threshold_days">{{ _('Rotation Threshold (days)') }} <span class="text-danger">*</span></label>
              <input class="form-control" type="number" id="rotation_threshold_days" name="rotation_threshold_days" value="{{ create_form_values.get('rotation_threshold_days', 30) }}" min="1" required>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="auto_rotate" name="auto_rotate" {% if create_form_values.get('auto_rotate', 'on') == 'on' %}checked{% endif %}>
                <label class="form-check-label" for="auto_rotate">{{ _('Auto Rotate') }}</label>
              </div>
            </div>
          </div>
          <hr>
          <h3 class="h6 mb-1">{{ _('Subject Template') }}</h3>
          <div class="row g-3">
            {% for oid, field_name, label, required in subject_fields %}
            <div class="col-md-6">
              <label class="form-label" for="{{ field_name }}">
                {{ label }}
                {% if required %}
                <span class="badge text-bg-danger align-middle ms-1">{{ _('Required') }}</span>
                {% else %}
                <span class="badge text-bg-secondary align-middle ms-1">{{ _('Optional') }}</span>
                {% endif %}
              </label>
              {% if oid == 'C' %}
              <input
                class="form-control"
                type="text"
                id="{{ field_name }}"
                name="{{ field_name }}"
                value="{{ create_form_values.get(field_name, '') }}"
                maxlength="2"
                pattern="[A-Za-z]{2}"
                title="{{ _('Enter a two-letter ISO 3166-1 alpha-2 code (e.g., JP).') }}"
                {% if required %}required{% endif %}
                data-required-message="{{ _('%(label)s is required.', label=label) }}"
              >
              <div class="form-text text-muted small">{{ _('Fill in all required subject attributes using ASCII characters. Country code must be a two-letter ISO 3166-1 alpha-2 value (e.g., JP).') }}</div>
              {% else %}
              <input
                class="form-control"
                type="text"
                id="{{ field_name }}"
                name="{{ field_name }}"
                value="{{ create_form_values.get(field_name, '') }}"
                {% if required %}required{% endif %}
                data-required-message="{{ _('%(label)s is required.', label=label) }}"
              >
              {% endif %}
            </div>
            {% endfor %}
          </div>
          <p class="text-danger small mt-2 d-none" data-subject-error>{{ _('Please fill in all required subject attributes.') }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary">{{ _('Save Group') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" id="editGroupForm">
        <div class="modal-header">
          <h2 class="modal-title h5" id="editGroupModalLabel">{{ _('Edit Certificate Group') }}</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
        </div>
        <div class="modal-body">
          {% set edit_errors = edit_form_errors | default([]) %}
          {% if edit_errors %}
          <div class="alert alert-danger" role="alert">
            <ul class="mb-0">
              {% for message in edit_errors %}
              <li>{{ message }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="edit_group_code">{{ _('Group Code') }} <span class="text-danger">*</span></label>
              <input class="form-control" type="text" id="edit_group_code" name="group_code" readonly>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit_display_name">{{ _('Display Name') }}</label>
              <input class="form-control" type="text" id="edit_display_name" name="display_name">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit_usage_type">{{ _('Usage Type') }} <span class="text-danger">*</span></label>
              <select class="form-select" id="edit_usage_type" name="usage_type" required>
                {% for value, label in usage_options %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit_key_preset">{{ _('Key Parameters') }} <span class="text-danger">*</span></label>
              {% set edit_custom_label_template = _('Custom configuration (%(details)s)', details='%(details)s') %}
              {% set edit_custom_label_fallback = edit_custom_label_template | replace('%(details)s', '-') %}
              <select
                class="form-select"
                id="edit_key_preset"
                name="key_preset"
                required
                data-placeholder="{{ _('Select key parameters') }}"
                data-custom-label="{{ edit_custom_label_fallback }}"
                data-custom-label-template="{{ edit_custom_label_template }}"
              ></select>
              <input type="hidden" id="edit_key_type" name="key_type">
              <input type="hidden" id="edit_key_curve" name="key_curve">
              <input type="hidden" id="edit_key_size" name="key_size">
            </div>
            <div class="col-md-3">
              <label class="form-label" for="edit_rotation_threshold_days">{{ _('Rotation Threshold (days)') }} <span class="text-danger">*</span></label>
              <input class="form-control" type="number" id="edit_rotation_threshold_days" name="rotation_threshold_days" min="1" required>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="edit_auto_rotate" name="auto_rotate">
                <label class="form-check-label" for="edit_auto_rotate">{{ _('Auto Rotate') }}</label>
              </div>
            </div>
          </div>
          <hr>
          <h3 class="h6 mb-1">{{ _('Subject Template') }}</h3>
          <div class="row g-3">
            {% for oid, field_name, label, required in subject_fields %}
            <div class="col-md-6">
              <label class="form-label" for="edit_{{ field_name }}">
                {{ label }}
                {% if required %}
                <span class="badge text-bg-danger align-middle ms-1">{{ _('Required') }}</span>
                {% else %}
                <span class="badge text-bg-secondary align-middle ms-1">{{ _('Optional') }}</span>
                {% endif %}
              </label>
              {% if oid == 'C' %}
              <input
                class="form-control"
                type="text"
                id="edit_{{ field_name }}"
                name="{{ field_name }}"
                maxlength="2"
                pattern="[A-Za-z]{2}"
                title="{{ _('Enter a two-letter ISO 3166-1 alpha-2 code (e.g., JP).') }}"
                {% if required %}required{% endif %}
                data-required-message="{{ _('%(label)s is required.', label=label) }}"
              >
              <div class="form-text text-muted small">{{ _('Fill in all required subject attributes using ASCII characters. Country code must be a two-letter ISO 3166-1 alpha-2 value (e.g., JP).') }}</div>
              {% else %}
              <input
                class="form-control"
                type="text"
                id="edit_{{ field_name }}"
                name="{{ field_name }}"
                {% if required %}required{% endif %}
                data-required-message="{{ _('%(label)s is required.', label=label) }}"
              >
              {% endif %}
            </div>
            {% endfor %}
          </div>
          <p class="text-danger small mt-2 d-none" data-subject-error>{{ _('Please fill in all required subject attributes.') }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary">{{ _('Update Group') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
{% block extra_scripts %}
{{ super() }}
<script>
(function() {
  const KEY_PRESETS = {{ key_presets | tojson }};

  function describePreset(keyType, keySize, keyCurve) {
    const parts = [];
    if (keyType) {
      parts.push(keyType);
    }
    if (keySize) {
      parts.push(keySize);
    }
    if (keyCurve) {
      parts.push(keyCurve);
    }
    return parts.join(' / ');
  }

  function serializeCombination(keyType, keySize, keyCurve) {
    const normalizedType = keyType || '';
    const normalizedSize = keySize != null && keySize !== '' ? String(keySize) : '';
    const normalizedCurve = keyCurve || '';
    return [normalizedType, normalizedSize, normalizedCurve].join('|');
  }

  function createKeyPresetController(ids) {
    const usageSelect = document.getElementById(ids.usageId);
    const presetSelect = document.getElementById(ids.presetId);
    const keyTypeInput = document.getElementById(ids.keyTypeId);
    const keyCurveInput = document.getElementById(ids.keyCurveId);
    const keySizeInput = document.getElementById(ids.keySizeId);

    if (!usageSelect || !presetSelect || !keyTypeInput || !keyCurveInput || !keySizeInput) {
      return null;
    }

    const state = {
      usageType: usageSelect.dataset.initial || usageSelect.value || '',
      presetValue: presetSelect.dataset.initial || presetSelect.value || '',
      keyType: keyTypeInput.value || '',
      keyCurve: keyCurveInput.value || '',
      keySize: keySizeInput.value || '',
    };

    const placeholderLabel = presetSelect.dataset.placeholder || '';
    const customLabelTemplate = presetSelect.dataset.customLabelTemplate || '';
    const customLabelFallback = presetSelect.dataset.customLabel || '';

    function createOption(value, label, data) {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = label;
      option.dataset.keyType = data.keyType || '';
      option.dataset.keyCurve = data.keyCurve || '';
      option.dataset.keySize = data.keySize || '';
      return option;
    }

    function applyOption(option) {
      if (!option) {
        keyTypeInput.value = '';
        keyCurveInput.value = '';
        keySizeInput.value = '';
        state.keyType = '';
        state.keyCurve = '';
        state.keySize = '';
        state.presetValue = '';
        return;
      }

      const selectedKeyType = option.dataset.keyType || '';
      const selectedKeyCurve = option.dataset.keyCurve || '';
      const selectedKeySize = option.dataset.keySize || '';

      keyTypeInput.value = selectedKeyType;
      keyCurveInput.value = selectedKeyCurve;
      keySizeInput.value = selectedKeySize;

      state.keyType = selectedKeyType;
      state.keyCurve = selectedKeyCurve;
      state.keySize = selectedKeySize;
      state.presetValue = option.value || '';
    }

    function buildCustomLabel(details) {
      if (customLabelTemplate) {
        if (customLabelTemplate.includes('%(details)s')) {
          return customLabelTemplate.replace('%(details)s', details || '-');
        }
        return customLabelTemplate;
      }
      if (customLabelFallback) {
        if (customLabelFallback.includes('%(details)s')) {
          return customLabelFallback.replace('%(details)s', details || '-');
        }
        return customLabelFallback;
      }
      return details || '';
    }

    function refresh() {
      usageSelect.value = state.usageType;
      const presets = Array.isArray(KEY_PRESETS[state.usageType]) ? KEY_PRESETS[state.usageType] : [];

      const fragment = document.createDocumentFragment();
      const optionValues = [];

      presets.forEach((preset) => {
        if (!preset) {
          return;
        }
        const keyType = preset.keyType || '';
        const keyCurve = preset.keyCurve || '';
        const keySize = preset.keySize != null && preset.keySize !== '' ? String(preset.keySize) : '';
        const value = serializeCombination(keyType, keySize, keyCurve);
        optionValues.push(value);
        const label = preset.label || describePreset(keyType, keySize, keyCurve) || value;
        fragment.appendChild(
          createOption(value, label, {
            keyType,
            keyCurve,
            keySize,
          })
        );
      });

      const stateValue = serializeCombination(state.keyType, state.keySize, state.keyCurve);
      const hasStateCombination = Boolean(state.keyType || state.keyCurve || state.keySize);
      if (hasStateCombination && !optionValues.includes(stateValue)) {
        optionValues.push(stateValue);
        const details = describePreset(state.keyType, state.keySize, state.keyCurve) || stateValue;
        fragment.appendChild(
          createOption(
            stateValue,
            buildCustomLabel(details),
            {
              keyType: state.keyType || '',
              keyCurve: state.keyCurve || '',
              keySize: state.keySize || '',
            }
          )
        );
      }

      presetSelect.innerHTML = '';
      presetSelect.appendChild(fragment);

      let finalValue = '';
      if (state.presetValue && optionValues.includes(state.presetValue)) {
        finalValue = state.presetValue;
      } else if (stateValue && optionValues.includes(stateValue)) {
        finalValue = stateValue;
      } else if (optionValues.length > 0) {
        finalValue = optionValues[0];
      }

      if (placeholderLabel && !finalValue) {
        presetSelect.value = '';
        applyOption(null);
      } else {
        presetSelect.value = finalValue;
        const selectedOption = Array.from(presetSelect.options).find((option) => option.value === finalValue);
        applyOption(selectedOption || null);
      }

      presetSelect.disabled = optionValues.length === 0;
    }

    usageSelect.addEventListener('change', () => {
      state.usageType = usageSelect.value || '';
      state.presetValue = '';
      state.keyType = '';
      state.keyCurve = '';
      state.keySize = '';
      refresh();
    });

    presetSelect.addEventListener('change', () => {
      state.presetValue = presetSelect.value || '';
      const selectedOption = presetSelect.options[presetSelect.selectedIndex] || null;
      applyOption(selectedOption);
    });

    refresh();

    return {
      refresh,
      setState(newState) {
        if (!newState) {
          return;
        }
        if (Object.prototype.hasOwnProperty.call(newState, 'usageType')) {
          state.usageType = newState.usageType || '';
        }
        if (Object.prototype.hasOwnProperty.call(newState, 'presetValue')) {
          state.presetValue = newState.presetValue || '';
        }
        if (Object.prototype.hasOwnProperty.call(newState, 'keyType')) {
          state.keyType = newState.keyType || '';
        }
        if (Object.prototype.hasOwnProperty.call(newState, 'keyCurve')) {
          state.keyCurve = newState.keyCurve || '';
        }
        if (Object.prototype.hasOwnProperty.call(newState, 'keySize')) {
          state.keySize = newState.keySize || '';
        }
        refresh();
      },
    };
  }

  const editFormInitial = {{ edit_form_initial | tojson }};
  const shouldShowEditModal = {{ show_edit_modal | tojson }};

  const createController = createKeyPresetController({
    usageId: 'usage_type',
    presetId: 'key_preset',
    keyTypeId: 'key_type',
    keyCurveId: 'key_curve',
    keySizeId: 'key_size',
  });

  const editController = createKeyPresetController({
    usageId: 'edit_usage_type',
    presetId: 'edit_key_preset',
    keyTypeId: 'edit_key_type',
    keyCurveId: 'edit_key_curve',
    keySizeId: 'edit_key_size',
  });

  const editFormActionTemplate = `{{ url_for('certs_ui.update_group', group_code='__PLACEHOLDER__') }}`;

  const subjectFieldNames = {{ subject_fields | map(attribute=1) | list | tojson }};
  const requiredSubjectFieldNames = {{ required_subject_field_names | tojson }};
  const subjectRequiredMessage = {{ _('Please fill in all required subject attributes.') | tojson }};

  function setupSubjectValidation(form) {
    if (!form) {
      return null;
    }

    const inputs = subjectFieldNames
      .map((name) => form.querySelector(`[name="${name}"]`))
      .filter((input) => Boolean(input));

    if (!inputs.length) {
      return null;
    }

    const requiredInputs = inputs.filter((input) => requiredSubjectFieldNames.includes(input.name));
    const errorMessage = form.querySelector('[data-subject-error]');
    let attempted = false;

    function updateState() {
      let valid = true;

      requiredInputs.forEach((input) => {
        const hasValue = input.value.trim() !== '';
        if (!hasValue) {
          valid = false;
          const message = input.dataset.requiredMessage || subjectRequiredMessage;
          input.setCustomValidity(message);
          if (attempted) {
            input.classList.add('is-invalid');
          } else {
            input.classList.remove('is-invalid');
          }
        } else {
          input.setCustomValidity('');
          input.classList.remove('is-invalid');
        }
      });

      if (errorMessage) {
        if (!valid && attempted) {
          errorMessage.classList.remove('d-none');
        } else {
          errorMessage.classList.add('d-none');
        }
      }

      return valid;
    }

    function handleInput(event) {
      if (!attempted) {
        event.target.classList.remove('is-invalid');
        event.target.setCustomValidity('');
      }
      updateState();
    }

    inputs.forEach((input) => {
      input.addEventListener('input', handleInput);
      input.addEventListener('change', handleInput);
    });

    function handleSubmit(event) {
      attempted = true;
      if (updateState()) {
        return;
      }
      event.preventDefault();
      event.stopImmediatePropagation();
      const firstInvalid = requiredInputs.find((input) => input.value.trim() === '');
      if (firstInvalid) {
        firstInvalid.reportValidity();
        firstInvalid.focus({ preventScroll: true });
      }
    }

    form.addEventListener('submit', handleSubmit, true);

    function reset() {
      attempted = false;
      inputs.forEach((input) => {
        input.classList.remove('is-invalid');
        if (requiredSubjectFieldNames.includes(input.name) && input.value.trim() === '') {
          const message = input.dataset.requiredMessage || subjectRequiredMessage;
          input.setCustomValidity(message);
        } else {
          input.setCustomValidity('');
        }
      });
      updateState();
    }

    reset();

    return {
      reset,
      update: updateState,
    };
  }

  const createForm = document.querySelector('#createGroupModal form');
  const editForm = document.getElementById('editGroupForm');

  const createSubjectValidation = setupSubjectValidation(createForm);
  const editSubjectValidation = setupSubjectValidation(editForm);

  function fillEditForm(data) {
    if (!data) {
      return;
    }
    const form = document.getElementById('editGroupForm');
    if (!form) {
      return;
    }
    const groupCode = data.groupCode || '';
    form.action = editFormActionTemplate.replace('__PLACEHOLDER__', encodeURIComponent(groupCode));

    const codeField = form.querySelector('#edit_group_code');
    if (codeField) {
      codeField.value = groupCode;
    }

    const displayNameField = form.querySelector('#edit_display_name');
    if (displayNameField) {
      displayNameField.value = data.displayName || '';
    }

    const rotationField = form.querySelector('#edit_rotation_threshold_days');
    if (rotationField) {
      const rotationValue = data.rotationThresholdDays;
      if (rotationValue === undefined || rotationValue === null || rotationValue === '') {
        rotationField.value = '';
      } else {
        rotationField.value = String(rotationValue);
      }
    }

    const autoRotateInput = form.querySelector('#edit_auto_rotate');
    if (autoRotateInput) {
      autoRotateInput.checked = Boolean(data.autoRotate);
    }

    const subject = data.subject || {};
    {% for oid, field_name, _label, _required in subject_fields %}
    const {{ field_name }}Field = form.querySelector('#edit_{{ field_name }}');
    if ({{ field_name }}Field) {
      {{ field_name }}Field.value = subject['{{ oid }}'] || '';
      {{ field_name }}Field.dispatchEvent(new Event('input', { bubbles: true }));
    }
    {% endfor %}

    const usageTypeValue = data.usageType || '';
    const keyTypeValue = data.keyType ? String(data.keyType).toUpperCase() : '';
    const keyCurveValue = data.keyCurve || '';
    const keySizeValue = data.keySize != null && data.keySize !== '' ? String(data.keySize) : '';

    if (editController) {
      editController.setState({
        usageType: usageTypeValue,
        keyType: keyTypeValue,
        keyCurve: keyCurveValue,
        keySize: keySizeValue,
      });
    } else {
      const usageSelect = form.querySelector('#edit_usage_type');
      if (usageSelect) {
        usageSelect.value = usageTypeValue;
      }
      const presetSelect = form.querySelector('#edit_key_preset');
      const keyTypeInput = form.querySelector('#edit_key_type');
      const keyCurveInput = form.querySelector('#edit_key_curve');
      const keySizeInput = form.querySelector('#edit_key_size');
      if (keyTypeInput) {
        keyTypeInput.value = keyTypeValue;
      }
      if (keyCurveInput) {
        keyCurveInput.value = keyCurveValue;
      }
      if (keySizeInput) {
        keySizeInput.value = keySizeValue;
      }
      if (presetSelect) {
        const combinationValue = serializeCombination(keyTypeValue, keySizeValue, keyCurveValue);
        const matchingOption = Array.from(presetSelect.options).find((option) => option.value === combinationValue);
        if (matchingOption) {
          presetSelect.value = matchingOption.value;
        } else if (presetSelect.dataset && presetSelect.dataset.placeholder) {
          presetSelect.value = '';
        }
      }
    }

    if (editSubjectValidation) {
      editSubjectValidation.reset();
    }
  }

  const createModalElement = document.getElementById('createGroupModal');
  if (createModalElement && createModalElement.dataset.showOnLoad === 'true' && window.bootstrap) {
    bootstrap.Modal.getOrCreateInstance(createModalElement).show();
  }

  const editGroupModal = document.getElementById('editGroupModal');
  if (editGroupModal) {
    editGroupModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      if (!button) {
        return;
      }
      const groupData = button.getAttribute('data-group');
      if (!groupData) {
        return;
      }
      let parsed;
      try {
        parsed = JSON.parse(groupData);
      } catch (err) {
        console.error('Failed to parse group data', err);
        return;
      }
      fillEditForm(parsed);
    });

    if (shouldShowEditModal && editFormInitial && window.bootstrap) {
      fillEditForm(editFormInitial);
      bootstrap.Modal.getOrCreateInstance(editGroupModal).show();
    }
  }
})();
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}{{ _('Generate Certificate') }} | {{ super() }}{% endblock %}
{% block content %}
<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between mb-4">
  <h1 class="h3 mb-3 mb-md-0">{{ _('Generate Certificate') }}</h1>
  <a class="btn btn-outline-secondary" href="{{ url_for('certs_ui.index') }}">{{ _('Back to List') }}</a>
</div>
<div class="row g-4">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header">{{ _('Input Form') }}</div>
      <div class="card-body">
        <form method="post">
          <div class="mb-3">
            <label class="form-label">Common Name (CN)</label>
            <input type="text" class="form-control" name="subject_cn" value="{{ (form_data or {}).get('subject_cn', '') }}" required>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Organization (O)</label>
              <input type="text" class="form-control" name="subject_o" value="{{ (form_data or {}).get('subject_o', '') }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Organizational Unit (OU)</label>
              <input type="text" class="form-control" name="subject_ou" value="{{ (form_data or {}).get('subject_ou', '') }}">
            </div>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <label class="form-label">Country (C)</label>
              <input type="text" class="form-control" name="subject_c" value="{{ (form_data or {}).get('subject_c', '') }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">State/Province (ST)</label>
              <input type="text" class="form-control" name="subject_st" value="{{ (form_data or {}).get('subject_st', '') }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Locality (L)</label>
              <input type="text" class="form-control" name="subject_l" value="{{ (form_data or {}).get('subject_l', '') }}">
            </div>
          </div>
          <div class="mb-3 mt-3">
            <label class="form-label">{{ _('Email Address') }}</label>
            <input type="email" class="form-control" name="subject_email" value="{{ (form_data or {}).get('subject_email', '') }}">
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">{{ _('Usage') }}</label>
              <select class="form-select" name="usage_type">
                {% for value, label in usage_options %}
                <option value="{{ value }}" {% if (form_data or {}).get('usage_type', 'server_signing') == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Validity (days)') }}</label>
              <input type="number" class="form-control" name="days" min="1" value="{{ (form_data or {}).get('days', '365') }}">
            </div>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-6">
              <label class="form-label">{{ _('Key Type') }}</label>
              <select class="form-select" name="key_type">
                <option value="RSA" {% if (form_data or {}).get('key_type', 'RSA') == 'RSA' %}selected{% endif %}>RSA</option>
                <option value="EC" {% if (form_data or {}).get('key_type') == 'EC' %}selected{% endif %}>EC (P-256)</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('RSA Key Size') }}</label>
              <input type="number" class="form-control" name="key_bits" min="2048" step="1024" value="{{ (form_data or {}).get('key_bits', '2048') }}">
            </div>
          </div>
          <div class="mb-3 mt-3">
            <label class="form-label">{{ _('Key Usage') }}</label>
            <div class="row row-cols-1 row-cols-sm-2 g-2">
              {% set selected_key_usage = (form_data or {}).getlist('key_usage') if form_data else [] %}
              {% for value, label in key_usage_choices %}
              <div class="col">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="key_usage" value="{{ value }}" id="ku-{{ loop.index }}" {% if value in selected_key_usage %}checked{% endif %}>
                  <label class="form-check-label" for="ku-{{ loop.index }}">{{ label }}</label>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="is_ca" name="is_ca" {% if (form_data or {}).get('is_ca') %}checked{% endif %}>
            <label class="form-check-label" for="is_ca">{{ _('Mark as CA certificate') }}</label>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">{{ _('Generate') }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card shadow-sm mb-4">
      <div class="card-header">{{ _('Private Key / Public Key') }}</div>
      <div class="card-body">
        {% if generated_material %}
        <h6>{{ _('Private Key') }}</h6>
        <pre class="bg-light p-2 rounded small">{{ generated_material.private_key_pem }}</pre>
        <h6>{{ _('Public Key') }}</h6>
        <pre class="bg-light p-2 rounded small">{{ generated_material.public_key_pem }}</pre>
        {% else %}
        <p class="text-muted mb-0">{{ _('Generation results will appear here.') }}</p>
        {% endif %}
      </div>
    </div>
    <div class="card shadow-sm">
      <div class="card-header">{{ _('Certificate / JWKS') }}</div>
      <div class="card-body">
        {% if certificate_pem %}
        <h6>{{ _('Certificate (PEM)') }}</h6>
        <pre class="bg-light p-2 rounded small">{{ certificate_pem }}</pre>
        <h6>{{ _('JWK') }}</h6>
        <pre class="bg-light p-2 rounded small">{{ jwk_json }}</pre>
        <div class="mt-3">
          <a class="btn btn-outline-primary" href="{{ url_for('certs_ui.detail', kid=kid) }}">{{ _('View Details') }}</a>
        </div>
        {% else %}
        <p class="text-muted mb-0">{{ _('Certificate details will be shown after generation.') }}</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

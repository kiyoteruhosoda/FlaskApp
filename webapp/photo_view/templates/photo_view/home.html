{% extends 'base.html' %}
{% block title %}Photo View{% endblock %}
{% block content %}
<h1>Photo View Home</h1>

<div class="mb-3">
  <a href="/auth/picker" class="btn btn-success">
    {{ _('Create New Session') }}
  </a>
</div>

<div class="mt-4">
  <h2>{{ _('All Picker Sessions') }}</h2>
  <div id="sessions-list"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const sessionsListEl = document.getElementById('sessions-list');

  function formatDateTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleString();
  }

  function formatCounts(counts) {
    if (!counts || Object.keys(counts).length === 0) return '-';
    return Object.entries(counts)
      .map(([status, count]) => `${status}: ${count}`)
      .join(', ');
  }

  async function loadSessions() {
    try {
      const resp = await fetch('/api/picker/sessions');
      if (!resp.ok) {
        console.error('Failed to load sessions:', resp.status);
        sessionsListEl.innerHTML = '<div class="alert alert-danger">{{ _("Failed to load sessions.") }}</div>';
        return;
      }

      const data = await resp.json();
      
      if (!data.sessions || data.sessions.length === 0) {
        sessionsListEl.innerHTML = '<div class="alert alert-info">{{ _("No sessions found.") }}</div>';
        return;
      }

      let html = `
        <table class="table table-striped">
          <thead>
            <tr>
              <th>{{ _('Session ID') }}</th>
              <th>{{ _('Status') }}</th>
              <th>{{ _('Selected Count') }}</th>
              <th>{{ _('File Status') }}</th>
              <th>{{ _('Created At') }}</th>
              <th>{{ _('Last Progress') }}</th>
              <th>{{ _('Actions') }}</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.sessions.forEach(session => {
        html += `
          <tr>
            <td>${session.sessionId || 'N/A'}</td>
            <td><span class="badge bg-${getStatusBadgeClass(session.status)}">${session.status}</span></td>
            <td>${session.selectedCount || 0}</td>
            <td>${formatCounts(session.counts)}</td>
            <td>${formatDateTime(session.createdAt)}</td>
            <td>${formatDateTime(session.lastProgressAt)}</td>
            <td>
              <a href="/photo-view?session_id=${session.id}" class="btn btn-sm btn-primary">{{ _('View Details') }}</a>
              ${session.status === 'ready' ? `<button class="btn btn-sm btn-success ms-1" onclick="startImport(${session.id})">{{ _('Start Import') }}</button>` : ''}
            </td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      sessionsListEl.innerHTML = html;
    } catch (err) {
      console.error('Error loading sessions:', err);
      sessionsListEl.innerHTML = '<div class="alert alert-danger">{{ _("Error loading sessions.") }}</div>';
    }
  }

  function getStatusBadgeClass(status) {
    switch (status) {
      case 'pending': return 'secondary';
      case 'ready': return 'primary';
      case 'processing': return 'warning';
      case 'importing': return 'info';
      case 'imported': return 'success';
      case 'expired': return 'danger';
      case 'error': return 'danger';
      default: return 'secondary';
    }
  }

  function getCsrfTokenFromCookie() {
    const m = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }

  window.startImport = async function(sessionId) {
    try {
      const headers = {};
      const csrf = getCsrfTokenFromCookie();
      if (csrf) headers['X-CSRFToken'] = csrf;

      const resp = await fetch(`/api/picker/session/${sessionId}/import`, {
        method: 'POST',
        headers
      });

      if (!resp.ok) {
        const text = await resp.text().catch(() => '');
        console.error('Import start failed:', resp.status, text);
        alert('{{ _("Failed to start import.") }}');
        return;
      }

      alert('{{ _("Import started.") }}');
      // セッション一覧を再読み込み
      loadSessions();
    } catch (err) {
      console.error(err);
      alert('{{ _("Failed to start import.") }}');
    }
  };

  // 初期読み込み
  loadSessions();
  
  // 定期的に更新
  setInterval(loadSessions, 5000);
});
</script>
{% endblock %}

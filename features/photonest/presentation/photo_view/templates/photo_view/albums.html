{% extends 'base.html' %}
{% from 'photo_view/_album_form.html' import render_album_form %}
{% block title %}{{ _('Albums') }}{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/filter-state.js') }}"></script>
<script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
<style>
  .album-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 24px;
    padding: 10px 0 30px;
  }

  .album-card {
    position: relative;
    border-radius: 14px;
    overflow: hidden;
    background: #fff;
    box-shadow: 0 4px 20px rgba(15, 23, 42, 0.12);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
  }

  .album-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);
  }

  .album-grid.reorder-active {
    user-select: none;
  }

  .album-grid.reorder-active .album-card {
    cursor: grab;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.18);
    transform: none;
  }

  .album-grid.reorder-active .album-card:hover {
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.24);
  }

  .album-grid.reorder-active .album-card.dragging {
    opacity: 0.82;
    transform: scale(0.98);
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.24);
    cursor: grabbing;
  }

  .album-card.reorder-enabled::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 14px;
    box-shadow: inset 0 0 0 2px rgba(148, 163, 184, 0.35);
    pointer-events: none;
  }

  .album-card.reorder-enabled {
    cursor: grab;
  }

  .album-card.reorder-enabled:active {
    cursor: grabbing;
  }

  .album-card.reorder-enabled:hover {
    transform: none;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
  }

  .album-reorder-controls {
    position: absolute;
    top: 12px;
    left: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(15, 23, 42, 0.78);
    border-radius: 999px;
    padding: 6px 12px;
    color: #e2e8f0;
    z-index: 4;
    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.25);
  }

  .album-reorder-controls .album-order-index {
    font-weight: 600;
    font-size: 0.85rem;
    min-width: 24px;
    text-align: center;
  }

  .album-reorder-handle {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: rgba(148, 163, 184, 0.25);
    color: #e2e8f0;
    cursor: grab;
    transition: background 0.15s ease, color 0.15s ease;
  }

  .album-reorder-handle:focus {
    outline: 2px solid rgba(148, 163, 184, 0.55);
    outline-offset: 2px;
  }

  .album-reorder-handle:hover {
    background: rgba(148, 163, 184, 0.4);
    color: #ffffff;
  }

  .album-reorder-handle:active {
    cursor: grabbing;
  }

  .album-reorder-controls.d-none {
    display: none !important;
  }

  .album-grid.reorder-active .album-actions {
    display: none;
  }

  .album-actions {
    position: absolute;
    top: 12px;
    right: 12px;
    display: flex;
    gap: 8px;
    z-index: 3;
  }

  .album-actions .btn {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    border-radius: 999px;
    padding: 6px 10px;
  }

  .album-cover {
    position: relative;
    height: 210px;
    background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
    overflow: hidden;
  }

  .album-cover.album-cover--empty {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
  }

  .album-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .album-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(15, 23, 42, 0.1) 0%, rgba(15, 23, 42, 0.65) 100%);
    color: #f8fafc;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 16px;
    gap: 6px;
  }

  .album-overlay .badge {
    background: rgba(15, 23, 42, 0.55);
    border: none;
    padding: 6px 12px;
    font-weight: 500;
    letter-spacing: 0.02em;
  }

  .album-info {
    padding: 18px 18px 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .album-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin: 0;
    color: #1e293b;
  }

  .album-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    font-size: 0.9rem;
    color: #64748b;
  }

  .album-description {
    font-size: 0.9rem;
    color: #475569;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .loading-spinner {
    text-align: center;
    padding: 40px 0;
  }

  .no-albums {
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
  }

  .no-albums .icon {
    font-size: 4rem;
    margin-bottom: 18px;
    opacity: 0.35;
  }

  .album-media-panel,
  .album-form-panel {
    border-radius: 16px;
    border: 1px solid rgba(148, 163, 184, 0.25);
    box-shadow: 0 12px 32px rgba(15, 23, 42, 0.12);
  }

  .album-media-scroll {
    max-height: 62vh;
    overflow-y: auto;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.2);
    background: #f8fafc;
    padding: 12px;
  }

  .album-media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
  }

  .album-media-tile {
    position: relative;
    border: none;
    border-radius: 12px;
    overflow: hidden;
    padding: 0;
    background: #0f172a;
    cursor: pointer;
    transition: transform 0.12s ease, box-shadow 0.12s ease;
  }

  .album-media-tile:hover {
    transform: translateY(-3px);
    box-shadow: 0 14px 32px rgba(15, 23, 42, 0.35);
  }

  .album-media-tile.selected {
    outline: 3px solid #22d3ee;
    outline-offset: 0;
    box-shadow: 0 0 0 4px rgba(34, 211, 238, 0.35);
  }

  .album-media-thumb {
    position: relative;
    width: 100%;
    padding-bottom: 70%;
    overflow: hidden;
    background-size: cover;
    background-position: center;
    background-color: #1e293b;
  }

  .album-media-thumb.is-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 28px;
    height: 28px;
    margin: -14px 0 0 -14px;
    border-radius: 50%;
    border: 3px solid rgba(148, 163, 184, 0.35);
    border-top-color: rgba(148, 163, 184, 0.85);
    animation: album-thumb-spin 0.8s linear infinite;
  }

  .album-media-thumb.is-error {
    background-color: rgba(220, 38, 38, 0.65);
  }

  .album-media-thumb.is-error::after {
    content: '!';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-weight: 600;
    font-size: 1rem;
    color: #fee2e2;
  }

  @keyframes album-thumb-spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .album-media-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    padding: 10px;
    background: linear-gradient(180deg, rgba(15, 23, 42, 0.1) 0%, rgba(15, 23, 42, 0.75) 100%);
    color: #f8fafc;
    font-size: 1.1rem;
  }

  .album-media-tile.selected .album-media-overlay {
    background: linear-gradient(180deg, rgba(6, 182, 212, 0.2) 0%, rgba(6, 182, 212, 0.8) 100%);
  }

  .album-media-meta {
    position: absolute;
    left: 10px;
    bottom: 10px;
    right: 10px;
    color: #e2e8f0;
    font-size: 0.8rem;
    text-shadow: 0 1px 2px rgba(15, 23, 42, 0.6);
  }

  .album-media-meta span {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .album-media-layout {
    display: block;
  }

  .album-cover-preview {
    border: 1px dashed rgba(148, 163, 184, 0.6);
    border-radius: 14px;
    padding: 10px;
    background: #f8fafc;
    min-height: 140px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .album-cover-preview img {
    max-width: 100%;
    max-height: 220px;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.22);
  }

  .album-cover-placeholder {
    text-align: center;
    color: #94a3b8;
    font-size: 0.9rem;
  }

  .tag-filter-box {
    position: relative;
    border: 1px solid rgba(148, 163, 184, 0.6);
    border-radius: 12px;
    padding: 8px 10px;
    background: #fff;
    min-height: 46px;
  }

  .tag-chip-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .album-editor-header {
    max-width: 1200px;
    margin: 0 auto 1.5rem;
  }

  .album-editor-page.modal {
    position: static;
    display: block;
    background: transparent;
  }

  .album-editor-page .modal-dialog {
    margin: 0 auto;
    max-width: 1200px;
  }

  .album-editor-page .modal-content {
    border: none;
    border-radius: 18px;
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.18);
  }

  .album-editor-page .modal-body {
    padding: 2rem;
  }

  .album-editor-page .modal-header,
  .album-editor-page .modal-footer {
    padding: 1.5rem 2rem;
  }

  .album-editor-page .album-media-panel,
  .album-editor-page .album-form-panel {
    box-shadow: none;
    border: 1px solid rgba(148, 163, 184, 0.2);
  }

  .tag-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(59, 130, 246, 0.1);
    color: #1d4ed8;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 0.8rem;
  }

  .tag-chip button {
    border: none;
    background: transparent;
    color: inherit;
    cursor: pointer;
  }

  .tag-filter-input {
    border: none;
    outline: none;
    flex: 1;
    min-width: 160px;
  }

  .tag-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid rgba(148, 163, 184, 0.6);
    border-radius: 0 0 12px 12px;
    box-shadow: 0 12px 28px rgba(15, 23, 42, 0.18);
    z-index: 30;
    max-height: 220px;
    overflow-y: auto;
    display: none;
  }

  .tag-suggestions.visible {
    display: block;
  }

  .tag-suggestion-item {
    padding: 10px 14px;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .tag-suggestion-item:hover {
    background: rgba(59, 130, 246, 0.08);
  }

  .album-media-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }

  .album-media-toolbar .btn-group {
    flex-wrap: wrap;
  }

  @media (max-width: 992px) {
    .album-media-scroll {
      max-height: 50vh;
    }
  }

  @media (max-width: 576px) {
    .album-grid {
      grid-template-columns: 1fr;
    }

    .album-media-toolbar {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
{% endblock %}

{% block content %}
{% set is_editor_view = editor_view|default(False) %}
{% set editor_album_id = editor_album_id|default(None) %}
{% set editor_success_url = editor_success_url|default(url_for('photo_view.albums')) %}
{% set editor_cancel_url = editor_cancel_url|default(url_for('photo_view.albums')) %}
{% set is_edit_mode = is_editor_view and editor_album_id is not none %}
{% set editor_heading = _('Edit Album') if is_edit_mode else _('Create Album') %}
{% set editor_description = _('Update the album details and media selection.') if is_edit_mode else _('Select media and configure details to build a new album.') %}
{% set editor_back_label = _('Back to album') if is_edit_mode else _('Back to albums') %}
{% if is_editor_view %}
  <div class="album-editor-header d-flex flex-wrap justify-content-between align-items-start gap-3">
    <div>
      <h1 class="mb-1">{{ editor_heading }}</h1>
      <p class="text-muted mb-0">{{ editor_description }}</p>
    </div>
    <a href="{{ editor_cancel_url }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>{{ editor_back_label }}
    </a>
  </div>
{% else %}
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
    <h1 class="mb-0">{{ _('Albums') }}</h1>
    <div class="d-flex flex-wrap gap-2">
      <a id="create-album-btn" class="btn btn-primary" href="{{ url_for('photo_view.album_create') }}">
        <i class="bi bi-plus-circle me-1"></i>{{ _('New Album') }}
      </a>
      <select id="sort-order" class="form-select form-select-sm" style="width: auto;">
        <option value="desc">{{ _('Newest First') }}</option>
        <option value="asc">{{ _('Oldest First') }}</option>
        <option value="custom">{{ _('Custom Order') }}</option>
      </select>
      <button id="refresh-btn" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-arrow-repeat me-1"></i>{{ _('Refresh') }}
      </button>
      <button id="reorder-toggle" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-up-down me-1"></i>{{ _('Reorder') }}
      </button>
      <button id="reorder-save" class="btn btn-success btn-sm d-none">
        <i class="bi bi-check-lg me-1"></i>{{ _('Save Order') }}
      </button>
      <button id="reorder-cancel" class="btn btn-outline-secondary btn-sm d-none">
        <i class="bi bi-x-lg me-1"></i>{{ _('Cancel') }}
      </button>
    </div>
  </div>

  <div id="album-stats" class="mb-3">
    <span id="album-count" class="badge bg-info text-dark">{{ _('Loading...') }}</span>
  </div>

  <div id="reorder-hint" class="alert alert-info d-none" role="status"></div>

  <div id="albums-grid" class="album-grid"></div>

  <div id="loading-indicator" class="loading-spinner" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">{{ _('Loading...') }}</span>
    </div>
    <p class="mt-2 text-muted">{{ _('Loading more albums...') }}</p>
  </div>

  <div id="no-more-data" class="text-center text-muted" style="display: none;">
    <p>{{ _('All albums loaded') }}</p>
  </div>

  <div id="no-albums" class="no-albums" style="display: none;">
    <div class="icon">📁</div>
    <h3>{{ _('No Albums Found') }}</h3>
    <p>{{ _('Create your first album by selecting media from your library.') }}</p>
    <a class="btn btn-primary" id="empty-create-btn" href="{{ url_for('photo_view.album_create') }}">
      <i class="bi bi-plus-circle me-1"></i>{{ _('Create an album') }}
    </a>
  </div>

{% endif %}

{% if is_editor_view %}
  <div class="album-editor-page modal d-block show" id="albumModal" tabindex="-1" aria-labelledby="albumModalLabel" data-editor-mode="page" data-success-url="{{ editor_success_url }}" data-album-id="{{ editor_album_id if editor_album_id is not none else '' }}">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        {{ render_album_form(True, editor_cancel_url) }}
      </div>
    </div>
  </div>
{% else %}
  <div class="modal fade" id="albumModal" tabindex="-1" aria-labelledby="albumModalLabel" aria-hidden="true" data-editor-mode="modal" data-success-url="">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        {{ render_album_form(False) }}
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const albumsGrid = document.getElementById('albums-grid');
  const loadingIndicator = document.getElementById('loading-indicator');
  const noMoreData = document.getElementById('no-more-data');
  const noAlbums = document.getElementById('no-albums');
  const sortOrder = document.getElementById('sort-order');
  const refreshBtn = document.getElementById('refresh-btn');
  const albumCountBadge = document.getElementById('album-count');
  const reorderToggleBtn = document.getElementById('reorder-toggle');
  const reorderSaveBtn = document.getElementById('reorder-save');
  const reorderCancelBtn = document.getElementById('reorder-cancel');
  const reorderHint = document.getElementById('reorder-hint');

  const albumModalElement = document.getElementById('albumModal');
  const editorView = albumModalElement?.dataset.editorMode === 'page';
  const successRedirectUrl = albumModalElement?.dataset.successUrl || '/photo_view/albums';
  const editorAlbumIdRaw = albumModalElement?.dataset.albumId || '';
  const editorAlbumId = Number.parseInt(editorAlbumIdRaw, 10);
  const albumModal = albumModalElement
    ? editorView
      ? {
          show() {
            albumModalElement.classList.add('show');
            albumModalElement.style.display = 'block';
          },
          hide() {},
        }
      : new bootstrap.Modal(albumModalElement)
    : null;
  const albumForm = document.getElementById('album-form');
  const albumModalLabel = document.getElementById('albumModalLabel');
  const albumFormStatus = document.getElementById('album-form-status');
  const saveAlbumBtn = document.getElementById('save-album-btn');
  const saveLabelCreate = saveAlbumBtn.querySelector('.save-label-create');
  const saveLabelUpdate = saveAlbumBtn.querySelector('.save-label-update');
  const albumNameInput = document.getElementById('album-name');
  const albumDescriptionInput = document.getElementById('album-description');
  const albumVisibilitySelect = document.getElementById('album-visibility');
  const albumCoverSelect = document.getElementById('album-cover-select');
  const albumCoverPreviewImage = document.getElementById('album-cover-preview-image');
  const albumCoverPlaceholder = document.getElementById('album-cover-placeholder');
  const selectedMediaList = document.getElementById('selected-media-list');
  const selectedMediaCount = document.getElementById('selected-media-count');
  const tagFilterInput = document.getElementById('album-tag-filter-input');
  const tagSuggestions = document.getElementById('album-tag-suggestions');
  const selectedTagsContainer = document.getElementById('album-selected-tags');
  const tagFilterBox = document.getElementById('album-tag-filter-box');
  const filterAfterInput = document.getElementById('album-filter-after');
  const filterBeforeInput = document.getElementById('album-filter-before');
  const mediaTypeInputs = document.querySelectorAll('input[name="album-media-type"]');
  const selectionFilterInputs = document.querySelectorAll('input[name="album-selection-filter"]');
  const selectionFilterAllInput = document.getElementById('album-selection-all');
  const applyFilterBtn = document.getElementById('apply-media-filter');
  const resetFilterBtn = document.getElementById('album-reset-filters');
  const selectAllVisibleBtn = document.getElementById('album-select-all-visible');
  const deselectAllVisibleBtn = document.getElementById('album-deselect-all-visible');
  const albumMediaGrid = document.getElementById('album-media-grid');
  const albumMediaScroll = document.getElementById('album-media-scroll');
  const albumMediaLoading = document.getElementById('album-media-loading');
  const albumMediaEmpty = document.getElementById('album-media-empty');
  const albumMediaEnd = document.getElementById('album-media-end');
  const defaultMediaEmptyMessage = albumMediaEmpty ? albumMediaEmpty.textContent : '';
  const filterStateApi = window.filterState || null;
  const ALBUM_FILTER_SECTION = 'albums';
  const ALBUM_SORT_VALUES = new Set(['desc', 'asc', 'custom']);
  const DEFAULT_ALBUM_SORT = 'desc';

  function applyAlbumFiltersFromState(state) {
    if (!sortOrder || editorView) {
      return;
    }

    const filters = state && typeof state === 'object' ? state : {};
    const candidate = typeof filters.order === 'string' ? filters.order : '';
    const normalized = ALBUM_SORT_VALUES.has(candidate) ? candidate : DEFAULT_ALBUM_SORT;
    sortOrder.value = normalized;
  }

  function buildAlbumFilterSnapshot() {
    if (!sortOrder || editorView) {
      return null;
    }

    const value = sortOrder.value || DEFAULT_ALBUM_SORT;
    if (!ALBUM_SORT_VALUES.has(value) || value === DEFAULT_ALBUM_SORT) {
      return null;
    }

    return { order: value };
  }

  function syncAlbumFiltersToHash() {
    if (!filterStateApi || typeof filterStateApi.writeSection !== 'function') {
      return;
    }

    const snapshot = buildAlbumFilterSnapshot();
    if (snapshot) {
      filterStateApi.writeSection(ALBUM_FILTER_SECTION, snapshot);
    } else {
      filterStateApi.writeSection(ALBUM_FILTER_SECTION, null);
    }
  }

  const strings = {
    albumCreated: "{{ _('Album created successfully.')|escapejs }}",
    albumUpdated: "{{ _('Album updated successfully.')|escapejs }}",
    loadAlbumError: "{{ _('Unable to load album details.')|escapejs }}",
    filterApplyError: "{{ _('Failed to load media for the selected filters.')|escapejs }}",
    nameRequired: "{{ _('Album title is required.')|escapejs }}",
    noSelection: "{{ _('No media selected')|escapejs }}",
    noUnselectedMatches: "{{ _('No unselected media matches the current filters.')|escapejs }}",
    selectedMediaEmpty: "{{ _('Selected media will appear here once added.')|escapejs }}",
    selectedCountSingular: "{{ ngettext('%(count)s media selected', '%(count)s media selected', 1, count='%(count)s')|escapejs }}",
    selectedCountPlural: "{{ ngettext('%(count)s media selected', '%(count)s media selected', 2, count='%(count)s')|escapejs }}",
    albumsLoadedSingular: "{{ ngettext('%(count)s album loaded', '%(count)s albums loaded', 1, count='%(count)s')|escapejs }}",
    albumsLoadedPlural: "{{ ngettext('%(count)s album loaded', '%(count)s albums loaded', 2, count='%(count)s')|escapejs }}",
    mediaCountSingular: "{{ ngettext('%(count)s photo', '%(count)s photos', 1, count='%(count)s')|escapejs }}",
    mediaCountPlural: "{{ ngettext('%(count)s photo', '%(count)s photos', 2, count='%(count)s')|escapejs }}",
    coverAuto: "{{ _('Auto (use first media)')|escapejs }}",
    coverPlaceholder: "{{ _('No media selected for cover.')|escapejs }}",
    removeMediaLabel: "{{ _('Remove from album')|escapejs }}",
    untitledMedia: "{{ _('Untitled media')|escapejs }}",
    untitledAlbum: "{{ _('Untitled Album')|escapejs }}",
    visibilityLabels: {
      public: "{{ _('Public')|escapejs }}",
      private: "{{ _('Private')|escapejs }}",
      unlisted: "{{ _('Unlisted')|escapejs }}",
    },
    createdLabel: "{{ _('Created')|escapejs }}",
    updatedLabel: "{{ _('Updated')|escapejs }}",
    photosLabel: "{{ _('photos')|escapejs }}",
    startSlideshow: "{{ _('Start Slideshow')|escapejs }}",
    customOrderLabel: "{{ _('Custom Order')|escapejs }}",
    reorderHint: "{{ _('Drag and drop albums to change the order, then choose "Save Order".')|escapejs }}",
    reorderLoading: "{{ _('Loading all albums for reordering...')|escapejs }}",
    reorderLoadError: "{{ _('Unable to prepare albums for reordering.')|escapejs }}",
    reorderSaved: "{{ _('Album order updated.')|escapejs }}",
    reorderSaveError: "{{ _('Failed to update album order.')|escapejs }}",
    reorderSaving: "{{ _('Saving album order...')|escapejs }}",
    reorderHandle: "{{ _('Drag to reorder')|escapejs }}",
  };

  const DEFAULT_MAX_CONCURRENT_MEDIA_LOADS = 4;

  function createLimitedConcurrencyQueue(options = {}) {
    const normalized = Math.max(1, Number(options.concurrency) || DEFAULT_MAX_CONCURRENT_MEDIA_LOADS);
    const pending = [];
    let activeCount = 0;

    const runNext = () => {
      if (activeCount >= normalized) {
        return;
      }
      const next = pending.shift();
      if (!next) {
        return;
      }
      activeCount += 1;
      const { task, resolve, reject } = next;
      Promise.resolve()
        .then(task)
        .then(resolve)
        .catch((error) => {
          console.error('Media load task failed', error);
          reject?.(error);
        })
        .finally(() => {
          activeCount = Math.max(0, activeCount - 1);
          runNext();
        });
    };

    return {
      enqueue(task) {
        let resolveFn;
        let rejectFn;
        const promise = new Promise((resolve, reject) => {
          resolveFn = resolve;
          rejectFn = reject;
        });
        pending.push({ task, resolve: resolveFn, reject: rejectFn });
        runNext();
        return promise;
      },
      clear(filterFn) {
        if (typeof filterFn === 'function') {
          for (let i = pending.length - 1; i >= 0; i -= 1) {
            if (filterFn(pending[i])) {
              pending.splice(i, 1);
            }
          }
        } else {
          pending.length = 0;
        }
      },
    };
  }

  function createThumbnailLoader(options = {}) {
    const queue = createLimitedConcurrencyQueue({ concurrency: options.concurrency });

    return {
      load(element, url) {
        if (!element || !url) {
          return Promise.resolve();
        }

        if (
          element.dataset.thumbnailRequestedUrl === url &&
          element.dataset.thumbnailLoaded === 'true'
        ) {
          element.classList.remove('is-loading');
          element.classList.remove('is-error');
          element.style.backgroundImage = `url("${url}")`;
          return Promise.resolve();
        }

        element.dataset.thumbnailRequestedUrl = url;
        element.dataset.thumbnailLoaded = 'false';
        element.classList.remove('is-error');
        element.classList.add('is-loading');
        element.style.backgroundImage = '';

        return queue
          .enqueue(
            () =>
              new Promise((resolve) => {
                const image = new Image();
                image.decoding = 'async';
                image.onload = () => {
                  if (element.isConnected && element.dataset.thumbnailRequestedUrl === url) {
                    element.style.backgroundImage = `url("${url}")`;
                    element.dataset.thumbnailLoaded = 'true';
                  }
                  element.classList.remove('is-loading');
                  element.classList.remove('is-error');
                  resolve();
                };
                image.onerror = () => {
                  if (element.isConnected && element.dataset.thumbnailRequestedUrl === url) {
                    element.classList.add('is-error');
                    element.style.backgroundImage = '';
                  }
                  element.classList.remove('is-loading');
                  resolve();
                };
                image.src = url;
              })
          )
          .catch((error) => {
            console.error('Thumbnail load failed', error);
          });
      },
      reset() {
        queue.clear();
      },
    };
  }

  function resolveMediaThumbnailUrl(media) {
    if (!media) {
      return null;
    }
    if (typeof media.thumbnailUrl === 'string' && media.thumbnailUrl) {
      return media.thumbnailUrl;
    }
    if (typeof media.thumbnail_url === 'string' && media.thumbnail_url) {
      return media.thumbnail_url;
    }
    if (media.id !== null && media.id !== undefined) {
      return `/api/media/${media.id}/thumbnail?size=256`;
    }
    return null;
  }

  const maxConcurrentMediaLoads = (() => {
    const raw = albumMediaGrid?.dataset?.maxConcurrentLoads;
    const parsed = Number.parseInt(raw || '', 10);
    if (Number.isFinite(parsed) && parsed > 0) {
      return parsed;
    }
    return DEFAULT_MAX_CONCURRENT_MEDIA_LOADS;
  })();

  const mediaThumbnailLoader = createThumbnailLoader({ concurrency: maxConcurrentMediaLoads });

  const albumState = {
    mode: 'create',
    editingId: null,
    selectedMedia: new Map(),
    mediaCache: new Map(),
    coverMediaId: null,
    selectionFilter: 'all',
    tagFilters: [],
    mediaPagination: null,
    mediaInfiniteScroll: null,
    tagSuggestionTimer: null,
  };

  const defaultCoverDataUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcw48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM2NjdlZWEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM3NjRiYTIiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2cpIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5OCPC90ZXh0Pjwvc3ZnPg==';

  const apiClient = new APIClient();

  let reorderMode = false;
  let reorderDirty = false;
  let albumsInitialLoadPromise = null;
  let draggingAlbumCard = null;
  let draggingAlbumStartIndex = -1;
  let draggingAlbumHasMoved = false;
  let isDragReordering = false;

  function adjustMediaScrollHeight() {
    if (!albumModalElement || !albumModalElement.classList.contains('show')) {
      return;
    }

    if (!albumMediaScroll) {
      return;
    }

    const modalBody = albumModalElement.querySelector('.modal-body');
    if (!modalBody) {
      return;
    }

    const modalBodyStyles = window.getComputedStyle(modalBody);
    const paddingBottom = parseFloat(modalBodyStyles.paddingBottom || '0');
    const modalBodyRect = modalBody.getBoundingClientRect();
    const scrollRect = albumMediaScroll.getBoundingClientRect();
    const offsetWithinBody = scrollRect.top - modalBodyRect.top;
    const available = modalBody.clientHeight - offsetWithinBody - paddingBottom - 12;

    if (!Number.isFinite(available)) {
      return;
    }

    const nextHeight = Math.floor(available);

    if (nextHeight <= 0) {
      albumMediaScroll.style.maxHeight = '180px';
      return;
    }

    albumMediaScroll.style.maxHeight = `${nextHeight}px`;
  }

  function scheduleMediaScrollAdjustment() {
    window.requestAnimationFrame(adjustMediaScrollHeight);
  }

  function escapeHtml(text) {
    if (text === null || text === undefined) {
      return '';
    }
    return text
      .toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function formatDate(isoString) {
    if (!isoString) return '';
    const helper = window.appTime;
    if (helper && typeof helper.formatDate === 'function') {
      const formatted = helper.formatDate(isoString, { dateStyle: 'medium' });
      if (formatted) {
        return formatted;
      }
    }
    const date = new Date(isoString);
    if (Number.isNaN(date.getTime())) return '';
    return date.toLocaleDateString();
  }

  function formatDateTime(isoString) {
    if (!isoString) return '';
    const helper = window.appTime;
    if (helper && typeof helper.formatDateTime === 'function') {
      const formatted = helper.formatDateTime(isoString, {
        dateStyle: 'medium',
        timeStyle: 'short',
      });
      if (formatted) {
        return formatted;
      }
    }
    const date = new Date(isoString);
    if (Number.isNaN(date.getTime())) return '';
    return date.toLocaleDateString();
  }

  function formatMediaDateTime(isoString, fallbackLabel = '') {
    if (!isoString) {
      return fallbackLabel;
    }

    const helper = window.appTime;
    const parseFn = helper && typeof helper.parseDate === 'function' ? helper.parseDate : (value) => {
      const parsed = new Date(value);
      return Number.isNaN(parsed.getTime()) ? null : parsed;
    };

    const date = parseFn(isoString);
    if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
      return fallbackLabel;
    }

    try {
      const formatter = new Intl.DateTimeFormat(helper?.locale || undefined, {
        timeZone: helper?.timezone || undefined,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
      });
      const parts = formatter.formatToParts(date);
      const pick = (type) => parts.find((part) => part.type === type)?.value || '';
      const year = pick('year');
      const month = pick('month');
      const day = pick('day');
      const hour = pick('hour');
      const minute = pick('minute');
      if (year && month && day && hour && minute) {
        return `${year}-${month}-${day} ${hour}:${minute}`;
      }
      const formatted = formatter.format(date);
      if (formatted) {
        return formatted.replace(/[\u202F\u2009]/g, ' ').replace(',', '').trim();
      }
    } catch (error) {
      console.warn('formatMediaDateTime failed', error);
    }

    const pad = (value) => value.toString().padStart(2, '0');
    const year = date.getFullYear();
    const month = pad(date.getMonth() + 1);
    const day = pad(date.getDate());
    const hour = pad(date.getHours());
    const minute = pad(date.getMinutes());
    return `${year}-${month}-${day} ${hour}:${minute}`;
  }

  function formatCount(templateSingular, templatePlural, count) {
    const template = count === 1 ? templateSingular : templatePlural;
    return template.replace('%(count)s', count.toString());
  }

  function updateAlbumCount(total) {
    if (!albumCountBadge) {
      return;
    }
    albumCountBadge.textContent = formatCount(strings.albumsLoadedSingular, strings.albumsLoadedPlural, total);
  }

  function formatMediaCount(count) {
    return formatCount(strings.mediaCountSingular, strings.mediaCountPlural, count);
  }

  function updateMediaEmptyMessage() {
    if (!albumMediaEmpty) {
      return;
    }

    if (albumState.selectionFilter === 'selected') {
      albumMediaEmpty.textContent = strings.noSelection;
    } else if (albumState.selectionFilter === 'unselected') {
      albumMediaEmpty.textContent = strings.noUnselectedMatches;
    } else {
      albumMediaEmpty.textContent = defaultMediaEmptyMessage;
    }
  }

  function serializeMediaForState(media) {
    if (!media) {
      return null;
    }
    return {
      id: Number(media.id),
      filename: media.filename || media.name || null,
      shotAt: media.shot_at || media.shotAt || null,
      thumbnailUrl: media.thumbnailUrl || `/api/media/${media.id}/thumbnail?size=256`,
    };
  }

  function updateCoverPreview() {
    const entries = Array.from(albumState.selectedMedia.entries());
    const effectiveId = albumState.coverMediaId || (entries.length > 0 ? entries[0][0] : null);

    if (!effectiveId) {
      albumCoverPreviewImage.classList.add('d-none');
      albumCoverPreviewImage.src = '';
      albumCoverPlaceholder.classList.remove('d-none');
      albumCoverPlaceholder.textContent = strings.coverPlaceholder;
      return;
    }

    const media = albumState.selectedMedia.get(effectiveId);
    albumCoverPlaceholder.classList.add('d-none');
    albumCoverPreviewImage.src = media?.thumbnailUrl || defaultCoverDataUrl;
    albumCoverPreviewImage.classList.remove('d-none');
  }

  function updateCoverOptions() {
    albumCoverSelect.innerHTML = '';
    const entries = Array.from(albumState.selectedMedia.entries());
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = entries.length > 0 ? strings.coverAuto : strings.coverPlaceholder;
    albumCoverSelect.appendChild(placeholder);

    entries.forEach(([id, media]) => {
      const option = document.createElement('option');
      option.value = id.toString();
      option.textContent = formatMediaDateTime(media.shotAt, `${strings.untitledMedia} #${id}`);
      albumCoverSelect.appendChild(option);
    });

    if (albumState.coverMediaId && albumState.selectedMedia.has(albumState.coverMediaId)) {
      albumCoverSelect.value = albumState.coverMediaId.toString();
    } else {
      albumCoverSelect.value = '';
    }

    updateCoverPreview();
  }

  function renderSelectedMedia() {
    const entries = Array.from(albumState.selectedMedia.entries());
    if (selectedMediaCount) {
      selectedMediaCount.textContent = entries.length
        ? formatCount(strings.selectedCountSingular, strings.selectedCountPlural, entries.length)
        : strings.noSelection;
    }

    if (selectedMediaList) {
      selectedMediaList.innerHTML = '';
      if (entries.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'selected-media-empty';
        emptyState.textContent = strings.selectedMediaEmpty;
        selectedMediaList.appendChild(emptyState);
      } else {
        entries.forEach(([id, media], index) => {
          const item = document.createElement('div');
          item.className = 'selected-media-item';
          item.dataset.mediaId = id.toString();
          item.draggable = true;

          const dragHandle = document.createElement('span');
          dragHandle.className = 'selected-media-handle';
          dragHandle.innerHTML = '<i class="bi bi-grip-vertical"></i>';

          const orderBadge = document.createElement('span');
          orderBadge.className = 'selected-media-index';
          orderBadge.textContent = (index + 1).toString();

          const thumb = document.createElement('div');
          thumb.className = 'selected-media-thumb';
          thumb.style.backgroundImage = `url('${media.thumbnailUrl || defaultCoverDataUrl}')`;

          const meta = document.createElement('div');
          meta.className = 'selected-media-meta';
          const title = document.createElement('div');
          title.className = 'selected-media-title';
          title.textContent = formatMediaDateTime(media.shotAt, `${strings.untitledMedia} #${id}`);
          meta.appendChild(title);
          if (media.filename) {
            const filename = document.createElement('div');
            filename.className = 'selected-media-filename';
            filename.textContent = media.filename;
            meta.appendChild(filename);
          }

          const actions = document.createElement('div');
          actions.className = 'selected-media-actions';

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'btn btn-outline-danger btn-sm selected-media-remove';
          removeBtn.dataset.selectedMediaAction = 'remove';
          removeBtn.dataset.mediaId = id.toString();
          removeBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
          removeBtn.setAttribute('aria-label', `${strings.removeMediaLabel} #${id}`);

          actions.appendChild(removeBtn);

          item.appendChild(dragHandle);
          item.appendChild(orderBadge);
          item.appendChild(thumb);
          item.appendChild(meta);
          item.appendChild(actions);

          attachSelectedMediaDragEvents(item);

          selectedMediaList.appendChild(item);
        });
      }
    }

    updateCoverOptions();
    scheduleMediaScrollAdjustment();
  }

  function attachSelectedMediaDragEvents(item) {
    item.addEventListener('dragstart', handleSelectedMediaDragStart);
    item.addEventListener('dragend', handleSelectedMediaDragEnd);
  }

  function handleSelectedMediaDragStart(event) {
    const target = event.currentTarget;
    if (!target) {
      return;
    }
    isDragReordering = true;
    target.classList.add('dragging');
    if (event.dataTransfer) {
      event.dataTransfer.effectAllowed = 'move';
      const mediaId = target.dataset.mediaId || '';
      event.dataTransfer.setData('text/plain', mediaId);
    }
  }

  function handleSelectedMediaDragEnd(event) {
    const target = event.currentTarget;
    if (target) {
      target.classList.remove('dragging');
    }
    if (selectedMediaList) {
      selectedMediaList.classList.remove('drag-over');
    }
    if (isDragReordering) {
      syncSelectedMediaOrderFromDom();
      renderSelectedMedia();
      if (albumState.selectionFilter === 'selected') {
        renderSelectedOnlyView();
      }
      isDragReordering = false;
    }
  }

  function handleSelectedMediaDragOver(event) {
    if (!selectedMediaList) {
      return;
    }
    event.preventDefault();
    if (event.dataTransfer) {
      event.dataTransfer.dropEffect = 'move';
    }
    const draggingItem = selectedMediaList.querySelector('.selected-media-item.dragging');
    if (!draggingItem) {
      return;
    }
    selectedMediaList.classList.add('drag-over');
    const afterElement = getDragAfterElement(selectedMediaList, event.clientY);
    if (!afterElement) {
      selectedMediaList.appendChild(draggingItem);
    } else if (afterElement !== draggingItem) {
      selectedMediaList.insertBefore(draggingItem, afterElement);
    }
  }

  function handleSelectedMediaDrop(event) {
    if (!selectedMediaList) {
      return;
    }
    event.preventDefault();
    selectedMediaList.classList.remove('drag-over');
    if (!isDragReordering) {
      return;
    }
    syncSelectedMediaOrderFromDom();
    renderSelectedMedia();
    if (albumState.selectionFilter === 'selected') {
      renderSelectedOnlyView();
    }
    isDragReordering = false;
  }

  function handleSelectedMediaDragLeave(event) {
    if (!selectedMediaList) {
      return;
    }
    const related = event.relatedTarget;
    if (!related || !selectedMediaList.contains(related)) {
      selectedMediaList.classList.remove('drag-over');
    }
  }

  function getDragAfterElement(container, y) {
    const elements = Array.from(container.querySelectorAll('.selected-media-item:not(.dragging)'));
    return elements.reduce(
      (closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        }
        return closest;
      },
      { offset: Number.NEGATIVE_INFINITY, element: null }
    ).element;
  }

  function syncSelectedMediaOrderFromDom() {
    if (!selectedMediaList) {
      return;
    }
    const items = selectedMediaList.querySelectorAll('.selected-media-item');
    if (!items.length) {
      return;
    }
    const orderedEntries = [];
    items.forEach((element) => {
      const id = Number(element.dataset.mediaId);
      if (!Number.isFinite(id)) {
        return;
      }
      const media = albumState.selectedMedia.get(id);
      if (media) {
        orderedEntries.push([id, media]);
      }
    });
    if (orderedEntries.length === albumState.selectedMedia.size) {
      albumState.selectedMedia = new Map(orderedEntries);
    }
  }

  function removeSelectedMedia(mediaId) {
    if (!albumState.selectedMedia.has(mediaId)) {
      return;
    }
    albumState.selectedMedia.delete(mediaId);
    if (albumState.coverMediaId === mediaId) {
      albumState.coverMediaId = null;
    }
    renderSelectedMedia();
    updateMediaTileSelectionState();
    if (albumState.selectionFilter !== 'all') {
      reloadMediaLibrary();
    }
  }

  function renderSelectedOnlyView() {
    if (!albumMediaGrid) {
      return;
    }

    albumState.mediaInfiniteScroll?.stop();
    albumState.mediaPagination?.reset?.();
    mediaThumbnailLoader.reset();
    albumMediaGrid.innerHTML = '';
    albumState.mediaCache.clear();
    albumMediaLoading?.classList.add('d-none');
    albumMediaEnd?.classList.add('d-none');

    updateMediaEmptyMessage();

    const items = Array.from(albumState.selectedMedia.values());

    if (items.length === 0) {
      albumMediaEmpty?.classList.remove('d-none');
      scheduleMediaScrollAdjustment();
      return;
    }

    albumMediaEmpty?.classList.add('d-none');

    items.forEach((media) => {
      if (media && typeof media.id === 'number') {
        albumState.mediaCache.set(media.id, media);
      }
      const tile = buildMediaTile(media);
      albumMediaGrid.appendChild(tile);
    });

    updateMediaTileSelectionState();
    scheduleMediaScrollAdjustment();
  }

  function renderMediaGridFromPagination(meta) {
    if (!albumMediaGrid || !albumState.mediaPagination) {
      return;
    }

    const allItems = albumState.mediaPagination.items || [];
    allItems.forEach((item) => {
      if (item && typeof item.id !== 'undefined') {
        albumState.mediaCache.set(Number(item.id), item);
      }
    });

    updateMediaEmptyMessage();

    let itemsToRender = allItems;
    if (albumState.selectionFilter === 'unselected') {
      itemsToRender = allItems.filter((item) => !albumState.selectedMedia.has(Number(item.id)));
    }

    mediaThumbnailLoader.reset();
    albumMediaGrid.innerHTML = '';

    itemsToRender.forEach((item) => {
      const tile = buildMediaTile(item);
      albumMediaGrid.appendChild(tile);
    });

    if (itemsToRender.length === 0) {
      if (albumState.selectionFilter === 'unselected' && albumState.mediaPagination.hasNext) {
        albumMediaEmpty?.classList.add('d-none');
        window.setTimeout(() => {
          if (albumState.selectionFilter === 'unselected') {
            albumState.mediaPagination.loadNext();
          }
        }, 0);
      } else if (albumMediaEmpty) {
        albumMediaEmpty.classList.remove('d-none');
      }
    } else {
      albumMediaEmpty?.classList.add('d-none');
    }

    if (!meta.hasNext && itemsToRender.length > 0) {
      albumMediaEnd.classList.remove('d-none');
    } else {
      albumMediaEnd.classList.add('d-none');
    }

    updateMediaTileSelectionState();
    scheduleMediaScrollAdjustment();
  }

  function updateMediaTileSelectionState() {
    const tiles = albumMediaGrid.querySelectorAll('.album-media-tile');
    tiles.forEach((tile) => {
      const mediaId = Number(tile.dataset.mediaId);
      const isSelected = albumState.selectedMedia.has(mediaId);
      tile.classList.toggle('selected', isSelected);
      const icon = tile.querySelector('.album-media-overlay i');
      if (icon) {
        icon.className = `bi ${isSelected ? 'bi-check-circle-fill' : 'bi-plus-circle'}`;
      }
    });
  }

  function toggleMediaSelection(media) {
    const normalized = serializeMediaForState(media);
    if (!normalized) return;

    const { id } = normalized;
    if (albumState.selectedMedia.has(id)) {
      albumState.selectedMedia.delete(id);
      if (albumState.coverMediaId === id) {
        albumState.coverMediaId = null;
      }
    } else {
      albumState.selectedMedia.set(id, normalized);
    }

    renderSelectedMedia();
    updateMediaTileSelectionState();
    if (albumState.selectionFilter !== 'all') {
      reloadMediaLibrary();
    }
  }

  function buildMediaTile(media) {
    const id = Number(media?.id);
    const hasValidId = Number.isFinite(id);
    const tile = document.createElement('button');
    tile.type = 'button';
    tile.className = 'album-media-tile';
    if (hasValidId) {
      tile.dataset.mediaId = id.toString();
    } else {
      tile.disabled = true;
    }

    const thumb = document.createElement('div');
    thumb.className = 'album-media-thumb';
    const thumbnailUrl = resolveMediaThumbnailUrl(media);
    if (thumbnailUrl) {
      thumb.dataset.thumbnailUrl = thumbnailUrl;
      mediaThumbnailLoader.load(thumb, thumbnailUrl);
    } else {
      thumb.classList.add('is-error');
    }

    const overlay = document.createElement('div');
    overlay.className = 'album-media-overlay';
    overlay.innerHTML = '<i class="bi bi-plus-circle"></i>';

    const meta = document.createElement('div');
    meta.className = 'album-media-meta';
    const nameSpan = document.createElement('span');
    nameSpan.textContent = formatMediaDateTime(
      media.shot_at || media.shotAt,
      `${strings.untitledMedia} #${hasValidId ? id : (media?.id ?? '?')}`
    );
    meta.appendChild(nameSpan);

    tile.appendChild(thumb);
    tile.appendChild(overlay);
    tile.appendChild(meta);

    if (hasValidId) {
      tile.addEventListener('click', (event) => {
        event.preventDefault();
        toggleMediaSelection(media);
      });
    }

    return tile;
  }

  function resetFilters() {
    tagFilterInput.value = '';
    albumState.tagFilters = [];
    filterAfterInput.value = '';
    filterBeforeInput.value = '';
    document.getElementById('album-type-all').checked = true;
    if (selectionFilterAllInput) {
      selectionFilterAllInput.checked = true;
    }
    albumState.selectionFilter = 'all';
    renderSelectedTags();
  }

  function buildMediaQueryParams() {
    const params = {
      order: 'desc',
    };

    const selectedType = Array.from(mediaTypeInputs).find((input) => input.checked);
    if (selectedType && selectedType.value) {
      params.type = selectedType.value;
    }

    if (albumState.tagFilters.length > 0) {
      params.tags = albumState.tagFilters.map((tag) => tag.id).join(',');
    }

    if (filterAfterInput.value) {
      params.after = `${filterAfterInput.value}T00:00:00Z`;
    }

    if (filterBeforeInput.value) {
      params.before = `${filterBeforeInput.value}T23:59:59Z`;
    }

    return params;
  }

  function ensureMediaBrowserInitialized() {
    if (albumState.mediaPagination) {
      return;
    }

    albumState.mediaPagination = new PaginationClient({
      baseUrl: '/api/media',
      pageSize: 60,
      autoLoad: false,
      parameters: buildMediaQueryParams(),
      onItemsLoaded: (items, meta) => {
        if (albumState.selectionFilter === 'selected') {
          return;
        }

        if (meta.isFirstPage) {
          albumState.mediaCache.clear();
        }

        renderMediaGridFromPagination(meta);
      },
      onError: (error) => {
        console.error('Media load error', error);
        showErrorToast(strings.filterApplyError);
      },
    });

    albumState.mediaInfiniteScroll = new InfiniteScrollHelper({
      paginationClient: albumState.mediaPagination,
      container: albumMediaScroll,
      loadingIndicator: albumMediaLoading,
      noMoreDataIndicator: albumMediaEnd,
      threshold: 320,
    });
  }

  async function reloadMediaLibrary() {
    ensureMediaBrowserInitialized();
    const params = buildMediaQueryParams();

    if (albumState.mediaPagination) {
      albumState.mediaPagination.defaultParams = params;
    }

    updateMediaEmptyMessage();

    if (albumState.selectionFilter === 'selected') {
      renderSelectedOnlyView();
      return;
    }

    albumMediaEnd.classList.add('d-none');
    albumMediaEmpty?.classList.add('d-none');
    try {
      await albumState.mediaInfiniteScroll.start(params);
      scheduleMediaScrollAdjustment();
    } catch (error) {
      console.error('Failed to reload media library', error);
      showErrorToast(strings.filterApplyError);
    }
  }

  function renderSelectedTags() {
    selectedTagsContainer.innerHTML = '';
    if (albumState.tagFilters.length === 0) {
      scheduleMediaScrollAdjustment();
      return;
    }

    albumState.tagFilters.forEach((tag) => {
      const chip = document.createElement('span');
      chip.className = 'tag-chip';
      chip.textContent = tag.name;
      const button = document.createElement('button');
      button.type = 'button';
      button.innerHTML = '&times;';
      button.setAttribute('aria-label', `${strings.removeMediaLabel} ${tag.name}`);
      button.addEventListener('click', () => {
        albumState.tagFilters = albumState.tagFilters.filter((item) => item.id !== tag.id);
        renderSelectedTags();
      });
      chip.appendChild(button);
      selectedTagsContainer.appendChild(chip);
    });

    scheduleMediaScrollAdjustment();
  }

  function hideTagSuggestions() {
    tagSuggestions.classList.remove('visible');
    tagSuggestions.innerHTML = '';
  }

  function showTagSuggestions(items) {
    if (!items || items.length === 0) {
      hideTagSuggestions();
      return;
    }

    tagSuggestions.innerHTML = '';
    items.forEach((tag) => {
      const option = document.createElement('div');
      option.className = 'tag-suggestion-item';
      option.dataset.tagId = tag.id;
      option.textContent = tag.name;
      option.addEventListener('click', () => {
        addTagFilter(tag);
        hideTagSuggestions();
      });
      tagSuggestions.appendChild(option);
    });

    tagSuggestions.classList.add('visible');
  }

  async function fetchTagSuggestions(query) {
    const response = await apiClient.get(`/api/tags?q=${encodeURIComponent(query)}&limit=20`);
    if (!response.ok) {
      throw new Error('Failed to fetch tags');
    }
    const data = await response.json();
    return data.items || [];
  }

  function scheduleTagSuggestionFetch(value) {
    if (albumState.tagSuggestionTimer) {
      clearTimeout(albumState.tagSuggestionTimer);
    }
    if (!value) {
      hideTagSuggestions();
      return;
    }

    albumState.tagSuggestionTimer = setTimeout(async () => {
      try {
        const suggestions = await fetchTagSuggestions(value);
        const available = suggestions.filter(
          (item) => !albumState.tagFilters.some((tag) => tag.id === item.id)
        );
        showTagSuggestions(available);
      } catch (error) {
        console.error('Tag suggestion fetch failed', error);
      }
    }, 220);
  }

  function addTagFilter(tag) {
    if (!albumState.tagFilters.some((item) => item.id === tag.id)) {
      albumState.tagFilters.push(tag);
      renderSelectedTags();
    }
    tagFilterInput.value = '';
  }

  function resetAlbumForm() {
    albumForm.reset();
    albumState.selectedMedia = new Map();
    albumState.coverMediaId = null;
    albumState.selectionFilter = 'all';
    albumState.tagFilters = [];
    albumState.mediaCache.clear();
    mediaThumbnailLoader.reset();
    albumMediaGrid.innerHTML = '';
    albumMediaEmpty.classList.add('d-none');
    albumMediaEnd.classList.add('d-none');
    if (selectionFilterAllInput) {
      selectionFilterAllInput.checked = true;
    }
    renderSelectedTags();
    renderSelectedMedia();
    updateCoverOptions();
    albumFormStatus.textContent = '';
    updateMediaEmptyMessage();
    scheduleMediaScrollAdjustment();
  }

  function openAlbumModal(mode, albumData = null) {
    albumState.mode = mode;
    albumState.editingId = albumData?.id || null;
    resetAlbumForm();

    if (mode === 'create') {
      albumModalLabel.textContent = "{{ _('Create Album')|escapejs }}";
      saveLabelCreate.classList.remove('d-none');
      saveLabelUpdate.classList.add('d-none');
      albumVisibilitySelect.value = 'private';
    } else {
      albumModalLabel.textContent = "{{ _('Edit Album')|escapejs }}";
      saveLabelCreate.classList.add('d-none');
      saveLabelUpdate.classList.remove('d-none');
    }

    if (albumData) {
      albumNameInput.value = albumData.title || '';
      albumDescriptionInput.value = albumData.description || '';
      albumVisibilitySelect.value = albumData.visibility || 'private';
      albumState.coverMediaId = albumData.coverMediaId || albumData.coverImageId || null;

      if (Array.isArray(albumData.media)) {
        albumData.media.forEach((item) => {
          const normalized = serializeMediaForState({
            id: item.id,
            filename: item.filename,
            shot_at: item.shotAt,
            thumbnailUrl: item.thumbnailUrl,
          });
          if (normalized) {
            albumState.selectedMedia.set(normalized.id, normalized);
          }
        });
      }

      renderSelectedMedia();
    }

    ensureMediaBrowserInitialized();
    reloadMediaLibrary();
    albumModal.show();
    scheduleMediaScrollAdjustment();
    setTimeout(() => {
      albumNameInput.focus();
      scheduleMediaScrollAdjustment();
    }, 200);
  }

  async function loadAlbumForEdit(albumId) {
    try {
      const response = await apiClient.get(`/api/albums/${albumId}`);
      if (!response.ok) {
        throw new Error('Failed to load album detail');
      }
      const data = await response.json();
      if (!data.album) {
        throw new Error('Album detail missing');
      }
      openAlbumModal('edit', data.album);
    } catch (error) {
      console.error('Failed to load album', error);
      showErrorToast(strings.loadAlbumError);
    }
  }

  async function saveAlbum(event) {
    event.preventDefault();

    const title = albumNameInput.value.trim();
    if (!title) {
      showWarningToast(strings.nameRequired);
      albumNameInput.focus();
      return;
    }

    const payload = {
      name: title,
      description: albumDescriptionInput.value.trim(),
      visibility: albumVisibilitySelect.value,
      mediaIds: Array.from(albumState.selectedMedia.keys()),
      coverMediaId: albumCoverSelect.value ? Number(albumCoverSelect.value) : null,
    };

    const isEdit = albumState.mode === 'edit' && albumState.editingId;
    const url = isEdit ? `/api/albums/${albumState.editingId}` : '/api/albums';
    const method = isEdit ? 'put' : 'post';

    saveAlbumBtn.disabled = true;
    saveAlbumBtn.classList.add('disabled');
    albumFormStatus.textContent = "{{ _('Saving...')|escapejs }}";

    try {
      const response = await apiClient[method](url, payload);
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.message || 'Save failed');
      }

      if (isEdit) {
        showSuccessToast(strings.albumUpdated);
      } else {
        showSuccessToast(strings.albumCreated);
      }

      if (editorView) {
        window.location.href = successRedirectUrl;
      } else {
        albumModal.hide();
        reloadAlbums();
      }
    } catch (error) {
      console.error('Failed to save album', error);
      showErrorToast(error.message || 'Save failed');
    } finally {
      saveAlbumBtn.disabled = false;
      saveAlbumBtn.classList.remove('disabled');
      albumFormStatus.textContent = '';
    }
  }

  function openAlbumSlideshow(albumId, options = {}) {
    if (!Number.isFinite(albumId)) {
      return;
    }

    const url = new URL(`/photo_view/albums/${albumId}/slideshow`, window.location.origin);
    const params = new URLSearchParams();

    const startIndex = Number(options.startIndex);
    if (Number.isInteger(startIndex) && startIndex >= 0) {
      params.set('start', startIndex.toString());
    }

    if (options.autoplay === false) {
      params.set('autoplay', '0');
    }

    if ([...params.keys()].length > 0) {
      url.search = params.toString();
    }

    window.location.href = url.toString();
  }

  function showReorderHint(message, type = 'info') {
    if (!reorderHint) {
      return;
    }
    reorderHint.textContent = message;
    reorderHint.classList.remove('d-none', 'alert-info', 'alert-warning', 'alert-danger', 'alert-success');
    reorderHint.classList.add(`alert-${type}`);
  }

  function hideReorderHint() {
    if (!reorderHint) {
      return;
    }
    reorderHint.classList.add('d-none');
    reorderHint.textContent = '';
    reorderHint.classList.remove('alert-warning', 'alert-danger', 'alert-success');
    reorderHint.classList.add('alert-info');
  }

  function setCardReorderState(card, enabled) {
    if (!card) {
      return;
    }
    const controls = card.querySelector('.album-reorder-controls');
    const handle = card.querySelector('.album-reorder-handle');
    if (enabled) {
      card.classList.add('reorder-enabled');
      if (controls) {
        controls.classList.remove('d-none');
        controls.setAttribute('aria-hidden', 'false');
      }
      if (handle) {
        handle.setAttribute('draggable', 'true');
        handle.setAttribute('tabindex', '0');
        handle.setAttribute('aria-hidden', 'false');
      }
    } else {
      card.classList.remove('reorder-enabled');
      card.classList.remove('dragging');
      if (controls) {
        controls.classList.add('d-none');
        controls.setAttribute('aria-hidden', 'true');
      }
      if (handle) {
        handle.removeAttribute('draggable');
        handle.setAttribute('tabindex', '-1');
        handle.setAttribute('aria-hidden', 'true');
      }
    }
  }

  function updateReorderSaveState() {
    if (reorderSaveBtn) {
      reorderSaveBtn.disabled = !reorderMode || !reorderDirty;
    }
    if (reorderCancelBtn) {
      reorderCancelBtn.disabled = false;
    }
  }

  function updateAlbumOrderIndicators() {
    if (!albumsGrid) {
      return;
    }
    const cards = Array.from(albumsGrid.querySelectorAll('.album-card'));
    cards.forEach((card, index) => {
      const indicator = card.querySelector('.album-order-index');
      if (indicator) {
        indicator.textContent = (index + 1).toString();
      }
    });
  }

  function markReorderDirty() {
    if (!reorderMode) {
      return;
    }
    reorderDirty = true;
    updateReorderSaveState();
  }

  function getAlbumCardIndex(card) {
    if (!albumsGrid || !card) {
      return -1;
    }
    return Array.from(albumsGrid.querySelectorAll('.album-card')).indexOf(card);
  }

  function resetAlbumDragState(options = {}) {
    const { markDirty = true } = options;
    if (!draggingAlbumCard) {
      draggingAlbumHasMoved = false;
      draggingAlbumStartIndex = -1;
      return;
    }

    const card = draggingAlbumCard;
    card.classList.remove('dragging');

    const currentIndex = getAlbumCardIndex(card);
    const moved = draggingAlbumHasMoved && currentIndex !== -1 && currentIndex !== draggingAlbumStartIndex;

    draggingAlbumCard = null;
    draggingAlbumStartIndex = -1;
    draggingAlbumHasMoved = false;

    updateAlbumOrderIndicators();

    if (markDirty && moved) {
      markReorderDirty();
    }
  }

  function finalizeAlbumDrag() {
    resetAlbumDragState({ markDirty: true });
  }

  function cancelAlbumDrag() {
    resetAlbumDragState({ markDirty: false });
  }

  function handleAlbumDragStart(event) {
    if (!reorderMode) {
      event.preventDefault();
      return;
    }

    const handle = event.currentTarget;
    const card = handle?.closest('.album-card');
    if (!card || !albumsGrid) {
      event.preventDefault();
      return;
    }

    draggingAlbumCard = card;
    draggingAlbumStartIndex = getAlbumCardIndex(card);
    draggingAlbumHasMoved = false;

    card.classList.add('dragging');

    if (event.dataTransfer) {
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', card.dataset.albumId || '');
      const rect = card.getBoundingClientRect();
      const offsetX = event.clientX - rect.left;
      const offsetY = event.clientY - rect.top;
      if (event.dataTransfer.setDragImage) {
        event.dataTransfer.setDragImage(card, offsetX, offsetY);
      }
    }

    event.stopPropagation();
  }

  function handleAlbumDragOver(event) {
    if (!reorderMode || !draggingAlbumCard || !albumsGrid) {
      return;
    }

    const targetCard = event.currentTarget;
    if (!targetCard || targetCard === draggingAlbumCard || !targetCard.classList.contains('album-card')) {
      return;
    }

    event.preventDefault();
    if (event.dataTransfer) {
      event.dataTransfer.dropEffect = 'move';
    }

    const rect = targetCard.getBoundingClientRect();
    const shouldInsertBefore = event.clientY < rect.top + rect.height / 2;
    const referenceNode = shouldInsertBefore ? targetCard : targetCard.nextElementSibling;

    if (referenceNode === draggingAlbumCard) {
      return;
    }

    albumsGrid.insertBefore(draggingAlbumCard, referenceNode);
    draggingAlbumHasMoved = true;
    updateAlbumOrderIndicators();
  }

  function handleAlbumsGridDragOver(event) {
    if (!reorderMode || !draggingAlbumCard || !albumsGrid) {
      return;
    }

    const targetCard = event.target.closest('.album-card');
    if (targetCard) {
      return;
    }

    event.preventDefault();
    if (event.dataTransfer) {
      event.dataTransfer.dropEffect = 'move';
    }

    const lastCard = albumsGrid.querySelector('.album-card:last-of-type');
    if (!lastCard) {
      return;
    }

    if (lastCard !== draggingAlbumCard) {
      albumsGrid.appendChild(draggingAlbumCard);
      draggingAlbumHasMoved = true;
      updateAlbumOrderIndicators();
    }
  }

  function handleAlbumDrop(event) {
    if (!reorderMode || !draggingAlbumCard) {
      return;
    }

    event.preventDefault();
    finalizeAlbumDrag();
  }

  function handleAlbumDragEnd(event) {
    if (!draggingAlbumCard) {
      return;
    }

    event.preventDefault();
    finalizeAlbumDrag();
  }

  function collectCurrentAlbumOrder() {
    if (!albumsGrid) {
      return [];
    }
    return Array.from(albumsGrid.querySelectorAll('.album-card'))
      .map((card) => Number(card.dataset.albumId))
      .filter((id) => Number.isInteger(id));
  }

  async function ensureAllAlbumsLoaded() {
    if (!albumsInfiniteScroll) {
      return;
    }
    if (albumsInitialLoadPromise) {
      try {
        await albumsInitialLoadPromise;
      } catch (error) {
        console.error('Initial albums load failed', error);
      }
    }
    while (albumsInfiniteScroll.pagination?.hasNext) {
      await albumsInfiniteScroll.pagination.loadNext();
    }
  }

  function applyReorderState(enabled) {
    reorderMode = enabled;
    if (!albumsGrid) {
      return;
    }

    const cards = albumsGrid.querySelectorAll('.album-card');
    cards.forEach((card) => setCardReorderState(card, enabled));

    if (enabled) {
      albumsGrid.classList.add('reorder-active');
      if (reorderToggleBtn) {
        reorderToggleBtn.classList.add('d-none');
      }
      if (reorderSaveBtn) {
        reorderSaveBtn.classList.remove('d-none');
      }
      if (reorderCancelBtn) {
        reorderCancelBtn.classList.remove('d-none');
      }
      if (sortOrder) {
        sortOrder.disabled = true;
      }
      if (albumsInfiniteScroll) {
        albumsInfiniteScroll.stop();
      }
    } else {
      albumsGrid.classList.remove('reorder-active');
      if (reorderToggleBtn) {
        reorderToggleBtn.classList.remove('d-none');
        reorderToggleBtn.disabled = false;
      }
      if (reorderSaveBtn) {
        reorderSaveBtn.classList.add('d-none');
        reorderSaveBtn.disabled = true;
      }
      if (reorderCancelBtn) {
        reorderCancelBtn.classList.add('d-none');
        reorderCancelBtn.disabled = false;
      }
      if (sortOrder) {
        sortOrder.disabled = false;
      }
    }

    updateReorderSaveState();
  }

  async function enterReorderMode() {
    if (reorderMode || !albumsGrid) {
      return;
    }

    if (reorderToggleBtn) {
      reorderToggleBtn.disabled = true;
    }

    if (sortOrder && sortOrder.value !== 'custom') {
      sortOrder.value = 'custom';
      syncAlbumFiltersToHash();
    }

    showReorderHint(strings.reorderLoading, 'warning');

    try {
      await ensureAllAlbumsLoaded();
      reorderDirty = false;
      applyReorderState(true);
      updateAlbumOrderIndicators();
      showReorderHint(strings.reorderHint, 'info');
    } catch (error) {
      console.error('Failed to enter album reorder mode', error);
      showErrorToast(strings.reorderLoadError);
      hideReorderHint();
      applyReorderState(false);
    } finally {
      if (reorderToggleBtn) {
        reorderToggleBtn.disabled = false;
      }
    }
  }

  function exitReorderMode(options = {}) {
    const { keepHint = false } = options;
    cancelAlbumDrag();
    reorderDirty = false;
    applyReorderState(false);
    if (keepHint) {
      if (reorderHint) {
        reorderHint.classList.remove('alert-warning', 'alert-danger', 'alert-success');
        reorderHint.classList.add('alert-info');
      }
    } else {
      hideReorderHint();
    }
  }

  async function saveAlbumOrder() {
    if (!reorderMode) {
      return;
    }

    const orderedIds = collectCurrentAlbumOrder();
    if (!orderedIds.length) {
      showErrorToast(strings.reorderSaveError);
      return;
    }

    if (reorderSaveBtn) {
      reorderSaveBtn.disabled = true;
    }
    if (reorderCancelBtn) {
      reorderCancelBtn.disabled = true;
    }

    showReorderHint(strings.reorderSaving, 'warning');

    try {
      const response = await apiClient.put('/api/albums/order', { albumIds: orderedIds });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        const message = data?.message || `HTTP ${response.status}`;
        throw new Error(message);
      }
      showSuccessToast(strings.reorderSaved);
      exitReorderMode();
      reloadAlbums();
    } catch (error) {
      console.error('Failed to save album order', error);
      showErrorToast(strings.reorderSaveError);
      updateReorderSaveState();
      showReorderHint(strings.reorderHint, 'info');
    }
  }

  function createAlbumCard(album) {
    const card = document.createElement('div');
    card.className = 'album-card';
    card.dataset.albumId = album.id;

    const coverUrl = album.coverImageId
      ? `/api/media/${album.coverImageId}/thumbnail?size=512`
      : null;
    const coverClass = coverUrl ? '' : ' album-cover--empty';

    const visibilityLabel = strings.visibilityLabels[album.visibility] || album.visibility;

    card.innerHTML = `
      <div class="album-reorder-controls d-none" aria-hidden="true">
        <span class="album-order-index">1</span>
        <div class="album-reorder-handle" role="button" tabindex="-1" aria-label="${strings.reorderHandle}">
          <i class="bi bi-grip-vertical" aria-hidden="true"></i>
        </div>
      </div>
      <div class="album-actions">
        <button type="button" class="btn btn-light btn-sm" data-album-action="slideshow" data-album-id="${album.id}" title="${strings.startSlideshow}">
          <i class="bi bi-play-fill"></i>
        </button>
      </div>
      <div class="album-cover${coverClass}">
        ${coverUrl ? `<img src="${coverUrl}" alt="${escapeHtml(album.title || 'Album')}" loading="lazy">` : ''}
        <div class="album-overlay">
          <span class="badge">${visibilityLabel}</span>
          <div class="d-flex justify-content-between align-items-center">
            <span>${formatMediaCount(album.mediaCount || 0)}</span>
            <small>${formatDateTime(album.createdAt)}</small>
          </div>
        </div>
      </div>
      <div class="album-info">
        <h5 class="album-title">${escapeHtml(album.title || "{{ _('Untitled Album')|escapejs }}")}</h5>
        <div class="album-meta">
          <span>${strings.createdLabel} ${formatDateTime(album.createdAt)}</span>
          ${album.lastModified ? `<span>${strings.updatedLabel} ${formatDateTime(album.lastModified)}</span>` : ''}
        </div>
        ${album.description ? `<p class="album-description">${escapeHtml(album.description)}</p>` : ''}
      </div>
    `;

    card.addEventListener('click', (event) => {
      if (reorderMode) {
        event.preventDefault();
        return;
      }
      const actionButton = event.target.closest('[data-album-action]');
      if (actionButton) {
        event.preventDefault();
        event.stopPropagation();
        const albumId = Number(actionButton.dataset.albumId);
        if (!Number.isFinite(albumId)) {
          return;
        }
        if (actionButton.dataset.albumAction === 'slideshow') {
          openAlbumSlideshow(albumId);
        }
        return;
      }
      window.location.href = `/photo_view/albums/${album.id}`;
    });

    const slideshowButton = card.querySelector('button[data-album-action="slideshow"]');
    if (slideshowButton) {
      slideshowButton.addEventListener('click', (event) => {
        if (reorderMode) {
          event.preventDefault();
          event.stopPropagation();
          return;
        }
        event.preventDefault();
        event.stopPropagation();
        const albumId = Number(slideshowButton.dataset.albumId);
        if (Number.isFinite(albumId)) {
          openAlbumSlideshow(albumId);
        }
      });
    }

    const reorderHandle = card.querySelector('.album-reorder-handle');
    if (reorderHandle) {
      reorderHandle.addEventListener('dragstart', handleAlbumDragStart);
      reorderHandle.addEventListener('dragend', handleAlbumDragEnd);
      reorderHandle.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
      });
      reorderHandle.addEventListener('keydown', (event) => {
        if (event.key === ' ' || event.key === 'Enter') {
          event.preventDefault();
        }
      });
    }

    card.addEventListener('dragover', handleAlbumDragOver);
    card.addEventListener('drop', handleAlbumDrop);

    setCardReorderState(card, reorderMode);

    return card;
  }

  let albumsInfiniteScroll;
  let totalLoaded = 0;

  function initializeAlbumsScroll() {
    if (albumsInfiniteScroll) {
      albumsInfiniteScroll.destroy();
    }

    const paginationClient = new PaginationClient({
      baseUrl: '/api/albums',
      pageSize: 24,
      autoLoad: false,
      parameters: {
        order: sortOrder.value,
      },
      onItemsLoaded: (items, meta) => {
        if (meta.isFirstPage) {
          albumsGrid.innerHTML = '';
          totalLoaded = 0;
          noAlbums.style.display = 'none';
        }

        if (items.length === 0 && meta.isFirstPage) {
          noAlbums.style.display = 'block';
          updateAlbumCount(0);
          return;
        }

        items.forEach((album) => {
          const card = createAlbumCard(album);
          albumsGrid.appendChild(card);
          totalLoaded += 1;
        });

        updateAlbumCount(totalLoaded);
      },
      onError: (error) => {
        console.error('Albums loading error:', error);
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger';
        alert.textContent = "{{ _('Failed to load albums. Please try again.')|escapejs }}";
        albumsGrid.appendChild(alert);
      },
    });

    albumsInfiniteScroll = new InfiniteScrollHelper({
      paginationClient,
      container: document.body,
      loadingIndicator,
      noMoreDataIndicator: noMoreData,
      threshold: 200,
    });

    albumsInitialLoadPromise = albumsInfiniteScroll.start({ order: sortOrder.value });
    return albumsInitialLoadPromise;
  }

  function reloadAlbums() {
    if (editorView) {
      return;
    }
    syncAlbumFiltersToHash();
    if (reorderMode) {
      exitReorderMode();
    } else {
      hideReorderHint();
    }
    initializeAlbumsScroll();
  }

  if (albumsGrid) {
    albumsGrid.addEventListener('dragover', handleAlbumsGridDragOver);
    albumsGrid.addEventListener('drop', handleAlbumDrop);
  }

  if (sortOrder) {
    sortOrder.addEventListener('change', () => {
      syncAlbumFiltersToHash();
      reloadAlbums();
    });
  }

  if (refreshBtn) {
    refreshBtn.addEventListener('click', () => {
      syncAlbumFiltersToHash();
      reloadAlbums();
    });
  }

  if (reorderToggleBtn) {
    reorderToggleBtn.addEventListener('click', () => {
      enterReorderMode();
    });
  }

  if (reorderCancelBtn) {
    reorderCancelBtn.addEventListener('click', () => {
      exitReorderMode();
      reloadAlbums();
    });
  }

  if (reorderSaveBtn) {
    reorderSaveBtn.addEventListener('click', () => {
      saveAlbumOrder();
    });
  }

  updateReorderSaveState();

  albumForm.addEventListener('submit', saveAlbum);

  albumCoverSelect.addEventListener('change', () => {
    albumState.coverMediaId = albumCoverSelect.value ? Number(albumCoverSelect.value) : null;
    updateCoverPreview();
  });

  selectAllVisibleBtn.addEventListener('click', () => {
    const tiles = albumMediaGrid.querySelectorAll('.album-media-tile');
    tiles.forEach((tile) => {
      const mediaId = Number(tile.dataset.mediaId);
      const media = albumState.mediaCache.get(mediaId) || { id: mediaId };
      albumState.selectedMedia.set(mediaId, serializeMediaForState(media));
    });
    renderSelectedMedia();
    updateMediaTileSelectionState();
    if (albumState.selectionFilter !== 'all') {
      reloadMediaLibrary();
    }
  });

  deselectAllVisibleBtn.addEventListener('click', () => {
    const tiles = albumMediaGrid.querySelectorAll('.album-media-tile');
    tiles.forEach((tile) => {
      const mediaId = Number(tile.dataset.mediaId);
      albumState.selectedMedia.delete(mediaId);
    });
    if (!albumState.selectedMedia.has(albumState.coverMediaId)) {
      albumState.coverMediaId = null;
    }
    renderSelectedMedia();
    updateMediaTileSelectionState();
    if (albumState.selectionFilter !== 'all') {
      reloadMediaLibrary();
    }
  });

  if (selectedMediaList) {
    selectedMediaList.addEventListener('click', (event) => {
      const actionButton = event.target.closest('[data-selected-media-action]');
      if (!actionButton) {
        return;
      }
      event.preventDefault();
      const mediaId = Number(actionButton.dataset.mediaId);
      if (!Number.isFinite(mediaId)) {
        return;
      }
      if (actionButton.dataset.selectedMediaAction === 'remove') {
        removeSelectedMedia(mediaId);
      }
    });
    selectedMediaList.addEventListener('dragover', handleSelectedMediaDragOver);
    selectedMediaList.addEventListener('drop', handleSelectedMediaDrop);
    selectedMediaList.addEventListener('dragleave', handleSelectedMediaDragLeave);
  }

  Array.from(selectionFilterInputs).forEach((input) => {
    input.addEventListener('change', () => {
      if (!input.checked) {
        return;
      }
      albumState.selectionFilter = input.value;
      updateMediaEmptyMessage();
      reloadMediaLibrary();
    });
  });

  applyFilterBtn.addEventListener('click', reloadMediaLibrary);
  resetFilterBtn.addEventListener('click', () => {
    resetFilters();
    reloadMediaLibrary();
  });

  tagFilterInput.addEventListener('input', (event) => {
    scheduleTagSuggestionFetch(event.target.value.trim());
  });

  tagFilterInput.addEventListener('keydown', (event) => {
    if (event.key === 'Backspace' && !tagFilterInput.value && albumState.tagFilters.length > 0) {
      albumState.tagFilters.pop();
      renderSelectedTags();
    }
  });

  document.addEventListener('click', (event) => {
    if (!tagFilterBox.contains(event.target)) {
      hideTagSuggestions();
    }
  });

  if (albumsGrid) {
    albumsGrid.addEventListener('click', (event) => {
      const button = event.target.closest('[data-album-action]');
      if (!button) return;
      event.preventDefault();
    });
  }

  if (albumModalElement && !editorView) {
    albumModalElement.addEventListener('hidden.bs.modal', () => {
      resetAlbumForm();
      if (albumMediaScroll) {
        albumMediaScroll.style.maxHeight = '';
      }
    });

    albumModalElement.addEventListener('shown.bs.modal', () => {
      scheduleMediaScrollAdjustment();
      setTimeout(adjustMediaScrollHeight, 150);
    });
  } else if (albumModalElement && editorView) {
    scheduleMediaScrollAdjustment();
    setTimeout(adjustMediaScrollHeight, 150);
  }

  if (albumModalElement) {
    window.addEventListener('resize', scheduleMediaScrollAdjustment);
  }

  if (editorView) {
    if (Number.isInteger(editorAlbumId) && editorAlbumId > 0) {
      loadAlbumForEdit(editorAlbumId);
    } else {
      openAlbumModal('create');
    }
  } else {
    const initialAlbumFilters =
      filterStateApi && typeof filterStateApi.readSection === 'function'
        ? filterStateApi.readSection(ALBUM_FILTER_SECTION)
        : null;

    applyAlbumFiltersFromState(initialAlbumFilters);
    syncAlbumFiltersToHash();

    if (filterStateApi && typeof filterStateApi.subscribeToSection === 'function') {
      filterStateApi.subscribeToSection(ALBUM_FILTER_SECTION, (state) => {
        const nextState = state && typeof state === 'object' ? state : {};
        applyAlbumFiltersFromState(nextState);
        reloadAlbums();
      });
    }

    initializeAlbumsScroll();
  }
});
</script>
{% endblock %}

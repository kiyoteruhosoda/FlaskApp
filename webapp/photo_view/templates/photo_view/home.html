{% extends 'base.html' %}
{% block title %}Photo View{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
  <div>
    <h1 class="h2 mb-1">{{ _("Photo View Home") }}</h1>
    <p class="text-muted mb-0">{{ _("Create new picker sessions and keep track of imports at a glance.") }}</p>
  </div>
  <div class="d-flex flex-wrap align-items-center gap-2">
    {% if is_admin %}
      <span class="badge bg-warning text-dark d-flex align-items-center px-3 py-2">
        <i class="bi bi-tools me-1"></i>{{ _("Admin tools available") }}
      </span>
    {% endif %}
    <a href="{{ url_for('photo_view.settings') }}" class="btn btn-outline-secondary">
      <i class="bi bi-gear me-1"></i>{{ _("Settings") }}
    </a>
  </div>
</div>

<div class="row g-3 align-items-stretch mb-4">
  <div class="col-xl-7">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white">
        <h2 class="h5 mb-0">{{ _("Start a new picker session") }}</h2>
      </div>
      <div class="card-body">
        <label for="session-account" class="form-label">{{ _("Google account for the new session") }}</label>
        <div class="input-group">
          {% set has_multiple_accounts = google_accounts|length > 1 %}
          <select id="session-account" class="form-select" {% if not google_accounts %}disabled{% endif %}>
            {% if not google_accounts %}
              <option value="" selected disabled>{{ _("No Google accounts are linked yet") }}</option>
            {% else %}
              <option value="" disabled {% if has_multiple_accounts %}selected{% endif %}>{{ _("Select an account") }}</option>
              {% for account in google_accounts %}
                <option value="{{ account.id }}" {% if not has_multiple_accounts and loop.first %}selected{% endif %}>{{ account.email }}</option>
              {% endfor %}
            {% endif %}
          </select>
          <button id="create-session-btn" class="btn btn-success" {% if not google_accounts %}disabled{% endif %}>
            <i class="bi bi-plus-circle me-1"></i>{{ _("Create new session") }}
          </button>
        </div>
        {% if not google_accounts %}
          <div class="form-text text-muted mt-2">
            {{ _("Link a Google account from the admin console before creating a new session.") }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-xl-5">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">{{ _("Quick actions") }}</h2>
        <span class="text-muted small">{{ _("Everything you need for day-to-day work") }}</span>
      </div>
      <div class="card-body d-flex flex-column gap-2">
        <button id="refresh-sessions" class="btn btn-outline-primary d-flex align-items-center justify-content-center">
          <i id="refresh-icon" class="fas fa-arrows-rotate me-2"></i>{{ _("Refresh sessions") }}
        </button>
        <button type="button" id="local-import-btn" class="btn btn-outline-info d-flex align-items-center justify-content-center"
                data-import-display="{{ local_import_info.import.display or '' }}"
                data-import-absolute="{{ local_import_info.import.absolute or '' }}"
                data-import-realpath="{{ local_import_info.import.realpath or '' }}"
                data-import-exists="{{ '1' if local_import_info.import.exists else '0' }}"
                data-destination-display="{{ local_import_info.originals.display or '' }}"
                data-destination-absolute="{{ local_import_info.originals.absolute or '' }}"
                data-destination-realpath="{{ local_import_info.originals.realpath or '' }}"
                data-destination-exists="{{ '1' if local_import_info.originals.exists else '0' }}">
          <i class="bi bi-folder-plus me-2"></i>{{ _("Start local import") }}
        </button>
        <a href="{{ url_for('photo_view.media_list') }}" class="btn btn-primary d-flex align-items-center justify-content-center">
          <i class="fas fa-images me-2"></i>{{ _("Open media gallery") }}
        </a>
        <a href="{{ url_for('photo_view.albums') }}" class="btn btn-outline-success d-flex align-items-center justify-content-center">
          <i class="fas fa-folder me-2"></i>{{ _("Browse albums") }}
        </a>
      </div>
    </div>
  </div>
</div>

{% if local_import_info.import.display %}
  <div class="alert alert-light border small" role="status">
    <div class="fw-semibold mb-1">{{ _("Local import paths") }}</div>
    <div>
      {{ _("Local import source") }}:
      <code>{{ local_import_info.import.display }}</code>
      {% if local_import_info.import.absolute and local_import_info.import.absolute != local_import_info.import.display %}
        <span class="ms-1">({{ _("Configured value") }}: <code>{{ local_import_info.import.absolute }}</code>)</span>
      {% elif local_import_info.import.raw and local_import_info.import.raw != local_import_info.import.display %}
        <span class="ms-1">({{ _("Configured value") }}: <code>{{ local_import_info.import.raw }}</code>)</span>
      {% endif %}
      {% if not local_import_info.import.exists %}
        <span class="ms-1 text-danger">{{ _("Not found") }}</span>
      {% endif %}
    </div>
    <div class="mt-1">
      {{ _("Destination") }}:
      {% if local_import_info.originals.display %}
        <code>{{ local_import_info.originals.display }}</code>
        {% if local_import_info.originals.absolute and local_import_info.originals.absolute != local_import_info.originals.display %}
          <span class="ms-1">({{ _("Configured value") }}: <code>{{ local_import_info.originals.absolute }}</code>)</span>
        {% elif local_import_info.originals.raw and local_import_info.originals.raw != local_import_info.originals.display %}
          <span class="ms-1">({{ _("Configured value") }}: <code>{{ local_import_info.originals.raw }}</code>)</span>
        {% endif %}
        {% if not local_import_info.originals.exists %}
          <span class="ms-1 text-danger">{{ _("Not found") }}</span>
        {% endif %}
      {% else %}
        <span class="text-warning">{{ _("No destination directory configured.") }}</span>
      {% endif %}
    </div>
  </div>
{% endif %}

<div class="mt-4">
  <h2>{{ _("All Picker Sessions") }}</h2>
  <div id="session-stats" class="mb-3">
    <span id="session-count" class="badge bg-info">{{ _("Loading...") }}</span>
  </div>
  <div id="sessions-list">
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>{{ _("Session ID") }}</th>
            <th>{{ _("Status") }}</th>
            <th>{{ _("Target Account") }}</th>
            <th>{{ _("File Status") }}</th>
            <th>{{ _("Created At") }}</th>
            <th>{{ _("Last Progress") }}</th>
            <th>{{ _("Actions") }}</th>
          </tr>
        </thead>
        <tbody id="sessions-body">
          <!-- Sessions will be added dynamically -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="loading-indicator" class="text-center" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">{{ _("Loading...") }}</span>
  </div>
  <p class="mt-2">{{ _("Loading more sessions...") }}</p>
</div>

<div id="no-more-data" class="text-center text-muted" style="display: none;">
  <p>{{ _("All sessions loaded") }}</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const sessionsBody = document.getElementById('sessions-body');
  const loadingIndicator = document.getElementById('loading-indicator');
  const noMoreData = document.getElementById('no-more-data');
  const refreshBtn = document.getElementById('refresh-sessions');
  const sessionCount = document.getElementById('session-count');
  const createSessionBtn = document.getElementById('create-session-btn');
  const accountSelect = document.getElementById('session-account');
  const localImportBtn = document.getElementById('local-import-btn');
  const isAdmin = {{ 'true' if is_admin else 'false' }};

  const selectAccountMessage = '{{ _("Please choose a Google account first.") }}';
  const localImportPromptHeader = '{{ _("Start a local import from the following directories?") }}';
  const localImportSourceLabel = '{{ _("Source") }}';
  const localImportDestinationLabel = '{{ _("Destination") }}';
  const localImportResolvedLabel = '{{ _("Resolved path") }}';
  const localImportMissingLabel = '{{ _("Not found") }}';
  const localImportRemovalNotice = '{{ _("Files will be removed from the original directory after import completes.") }}';
  const localImportDestinationUnset = '{{ _("No destination directory configured.") }}';
  const localImportStartingNotice = '{{ _("Starting local import...") }}';
  const localImportSuccessNotice = '{{ _("Local import has started. Track the progress in the session list.") }}';
  const localImportErrorNotice = '{{ _("Failed to start the local import.") }}';
  const startingImportNotice = '{{ _("Starting import...") }}';
  const localImportStopStartingNotice = '{{ _("Canceling local import...") }}';
  const localImportStopSuccessNotice = '{{ _("Local import was canceled.") }}';
  const localImportStopErrorNotice = '{{ _("Failed to stop local import.") }}';
  const stopLocalImportLabel = '{{ _("Stop Local Import") }}';
  const localImportRunningMessage = '{{ _("Local import is running. You can stop it if needed.") }}';

  let totalLoaded = 0;
  const sessionsLoadedLabel = '{{ _("sessions loaded") }}';
  const noSessionsLoadedLabel = '{{ _("No sessions loaded yet") }}';

  function formatDateTime(isoString) {
    if (!isoString) return '-';
    const helper = window.appTime;
    if (helper && typeof helper.formatDateTime === 'function') {
      const formatted = helper.formatDateTime(isoString);
      return formatted || '-';
    }
    const date = new Date(isoString);
    return Number.isNaN(date.getTime()) ? '-' : date.toLocaleString();
  }

  const selectionStatusLabels = {
    pending: '{{ _("Pending") }}',
    enqueued: '{{ _("Enqueued") }}',
    running: '{{ _("Running") }}',
    imported: '{{ _("Imported") }}',
    failed: '{{ _("Failed") }}',
    dup: '{{ _("Duplicate") }}',
    skipped: '{{ _("Skipped") }}'
  };

  const sessionStatusLabels = {
    pending: '{{ _("Pending") }}',
    ready: '{{ _("Ready") }}',
    expanding: '{{ _("Expanding") }}',
    processing: '{{ _("Processing") }}',
    enqueued: '{{ _("Enqueued") }}',
    importing: '{{ _("Importing") }}',
    imported: '{{ _("Imported") }}',
    canceled: '{{ _("Canceled") }}',
    expired: '{{ _("Expired") }}',
    error: '{{ _("Error") }}',
    failed: '{{ _("Failed") }}'
  };

  function formatCounts(counts) {
    if (!counts || Object.keys(counts).length === 0) return '-';
    return Object.entries(counts)
      .map(([status, count]) => `${selectionStatusLabels[status] || status}: ${count}`)
      .join(', ');
  }

  function formatAccountLabel(session) {
    if (session.isLocalImport) {
      return '{{ _("Local Import") }}';
    }
    if (session.accountEmail) {
      return session.accountEmail;
    }
    return '-';
  }

  function getStatusBadgeClass(status) {
    switch (status) {
      case 'pending': return 'secondary';
      case 'ready': return 'primary';
      case 'expanding': return 'warning';
      case 'processing': return 'warning';
      case 'importing': return 'info';
      case 'imported': return 'success';
      case 'expired': return 'danger';
      case 'error': return 'danger';
      default: return 'secondary';
    }
  }

  function hasOnlyDuplicates(counts = {}) {
    let duplicateTotal = 0;
    let otherTotal = 0;

    Object.entries(counts).forEach(([status, count]) => {
      const numericCount = Number(count) || 0;
      if (status === 'dup') {
        duplicateTotal += numericCount;
        return;
      }
      if (numericCount > 0) {
        otherTotal += numericCount;
      }
    });

    return duplicateTotal > 0 && otherTotal === 0;
  }

  function determineDisplayStatus(session) {
    const baseStatus = session.status;
    if (!baseStatus) {
      return 'pending';
    }

    if (['processing', 'importing', 'error', 'failed'].includes(baseStatus) && hasOnlyDuplicates(session.counts)) {
      return 'imported';
    }

    return baseStatus;
  }

  function createSessionRow(session) {
    const tr = document.createElement('tr');
    const displayStatus = determineDisplayStatus(session);
    const statusLabel = sessionStatusLabels[displayStatus] || displayStatus;
    const cancellableStatuses = ['expanding', 'processing', 'importing', 'enqueued'];
    const showStopButton = Boolean(isAdmin) && session.isLocalImport && cancellableStatuses.includes(session.status);
    const stopButtonHtml = showStopButton
      ? `<button class="btn btn-sm btn-outline-danger ms-1" onclick="stopLocalImport('${session.sessionId}')"><i class="bi bi-stop-circle"></i> ${stopLocalImportLabel}</button>`
      : '';
    let localStatusMessage = '';
    if (session.isLocalImport) {
      if (session.status === 'canceled') {
        localStatusMessage = `<div class="small text-danger mt-1"><i class="bi bi-stop-circle"></i> ${localImportStopSuccessNotice}</div>`;
      } else if (showStopButton) {
        localStatusMessage = `<div class="small text-muted mt-1"><i class="bi bi-info-circle"></i> ${localImportRunningMessage}</div>`;
      } else {
        localStatusMessage = `<div class="small text-muted mt-1"><i class="bi bi-info-circle"></i> {{ _("Local Import Session. Import runs automatically.") }}</div>`;
      }
    }
    tr.innerHTML = `
      <td>${session.sessionId || 'N/A'}</td>
      <td><span class="badge bg-${getStatusBadgeClass(displayStatus)}">${statusLabel}</span></td>
      <td>${formatAccountLabel(session)}</td>
      <td><small>${formatCounts(session.counts)}</small></td>
      <td><small>${formatDateTime(session.createdAt)}</small></td>
      <td><small>${formatDateTime(session.lastProgressAt)}</small></td>
      <td>
        <a href="/photo-view?session_id=${session.sessionId}" class="btn btn-sm btn-primary">{{ _("View Details") }}</a>
        ${(displayStatus === 'ready' && !session.isLocalImport) ? `<button class="btn btn-sm btn-success ms-1" onclick="startImport('${session.sessionId}')">{{ _("Start Import") }}</button>` : ''}
        ${stopButtonHtml}
        ${localStatusMessage}
      </td>
    `;
    return tr;
  }

  function initializeInfiniteScroll() {
    const refreshIcon = document.getElementById('refresh-icon');
    
    const paginationClient = new PaginationClient({
      baseUrl: '/api/picker/sessions',
      pageSize: 50, // Fetch up to 50 sessions per page
      onItemsLoaded: (items, meta) => {
        if (meta.currentPage === 1) {
          sessionsBody.innerHTML = '';
          totalLoaded = 0;
          // Stop the loading animation
          if (refreshIcon) {
            refreshIcon.style.animation = '';
            refreshIcon.classList.remove('fa-spin');
          }
        }
        
        items.forEach(session => {
          const row = createSessionRow(session);
          sessionsBody.appendChild(row);
          totalLoaded++;
        });
        
        if (totalLoaded > 0) {
          sessionCount.textContent = `${totalLoaded} ${sessionsLoadedLabel}`;
        } else {
          sessionCount.textContent = noSessionsLoadedLabel;
        }
      },
      onError: (error) => {
        console.error('Sessions loading error:', error);

        // Redirect to login when authentication fails
        if (error.status === 401 || error.status === 302) {
          window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
          return;
        }

        sessionsBody.innerHTML = `<tr><td colspan="7"><div class="alert alert-danger">{{ _("Failed to load sessions.") }}</div></td></tr>`;
        sessionCount.textContent = '{{ _("Error loading sessions") }}';
      }
    });

    // Load the initial page
    paginationClient.loadFirst();
  }

  window.startImport = async function(sessionId) {
    try {
      showInfoToast(startingImportNotice, 3000);

      const resp = await window.apiClient.post(`/api/picker/session/${sessionId}/import`);

      if (!resp.ok) {
        const text = await resp.text().catch(() => '');
        console.error('Import start failed:', resp.status, text);
        showErrorToast('{{ _("Failed to start import.") }}');
        return;
      }

      showSuccessToast('{{ _("Import started.") }}', 5000);
      // Reload the session list
      refreshSessions();
    } catch (err) {
      console.error(err);
      showErrorToast('{{ _("Failed to start import.") }}');
    }
  };

  window.stopLocalImport = async function(sessionId) {
    if (!isAdmin) {
      showErrorToast(localImportStopErrorNotice);
      return;
    }

    try {
      showInfoToast(localImportStopStartingNotice, 3000);

      const resp = await window.apiClient.post(`/api/sync/local-import/${encodeURIComponent(sessionId)}/stop`);

      if (!resp.ok) {
        const text = await resp.text().catch(() => '');
        console.error('Local import stop failed:', resp.status, text);
        showErrorToast(localImportStopErrorNotice);
        return;
      }

      const payload = await resp.json().catch(() => ({}));
      const message = (payload && payload.message) ? payload.message : localImportStopSuccessNotice;
      showInfoToast(message, 4000);
      refreshSessions();
    } catch (err) {
      console.error(err);
      showErrorToast(localImportStopErrorNotice);
    }
  };

  function refreshSessions() {
    // Spin the refresh icon while reloading
    const refreshIcon = document.getElementById('refresh-icon');
    if (refreshIcon) {
      refreshIcon.classList.add('fa-spin');
    }
    initializeInfiniteScroll();
  }

  // Refresh button handler
  refreshBtn.addEventListener('click', refreshSessions);

  if (accountSelect) {
    accountSelect.addEventListener('change', () => {
      accountSelect.classList.remove('is-invalid');
    });
    accountSelect.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && createSessionBtn) {
        event.preventDefault();
        createSessionBtn.click();
      }
    });
  }

  if (createSessionBtn) {
    createSessionBtn.addEventListener('click', (event) => {
      event.preventDefault();
      if (!accountSelect) {
        window.location.href = '/auth/picker';
        return;
      }
      const selected = accountSelect.value;
      if (!selected) {
        accountSelect.classList.add('is-invalid');
        if (typeof showInfoToast === 'function') {
          showInfoToast(selectAccountMessage, 4000);
        } else {
          alert(selectAccountMessage);
        }
        return;
      }
      window.location.href = `/auth/picker/${selected}`;
    });
  }

  // Local import button handler
  if (localImportBtn) {
    localImportBtn.addEventListener('click', async (e) => {
      e.preventDefault();

      const importDisplay = localImportBtn.dataset.importDisplay || localImportBtn.dataset.importAbsolute || '';
      const importReal = localImportBtn.dataset.importRealpath || '';
      const importExists = localImportBtn.dataset.importExists === '1';
      const destinationDisplay = localImportBtn.dataset.destinationDisplay || localImportBtn.dataset.destinationAbsolute || '';
      const destinationReal = localImportBtn.dataset.destinationRealpath || '';
      const destinationExists = localImportBtn.dataset.destinationExists === '1';

      const confirmLines = [localImportPromptHeader];
      if (importDisplay) {
        let sourceLine = `${localImportSourceLabel}: ${importDisplay}`;
        if (importReal && importReal !== importDisplay) {
          sourceLine += ` (${localImportResolvedLabel}: ${importReal})`;
        }
        if (!importExists) {
          sourceLine += ` [${localImportMissingLabel}]`;
        }
        confirmLines.push(sourceLine);
      }
      if (destinationDisplay) {
        let destinationLine = `${localImportDestinationLabel}: ${destinationDisplay}`;
        if (destinationReal && destinationReal !== destinationDisplay) {
          destinationLine += ` (${localImportResolvedLabel}: ${destinationReal})`;
        }
        if (!destinationExists) {
          destinationLine += ` [${localImportMissingLabel}]`;
        }
        confirmLines.push(destinationLine);
      } else {
        confirmLines.push(localImportDestinationUnset);
      }
      confirmLines.push(localImportRemovalNotice);

      if (!confirm(confirmLines.join('\n'))) {
        return;
      }

      try {
        // Notify that the import is starting
        showInfoToast(localImportStartingNotice, 3000);

        const resp = await window.apiClient.post('/api/sync/local-import');

        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          console.error('Local import failed:', resp.status, text);
          showErrorToast(localImportErrorNotice);
          return;
        }

        await resp.json();
        showSuccessToast(localImportSuccessNotice, 8000);

        // Automatically refresh the session list
        setTimeout(() => {
          refreshSessions();
        }, 2000);
      } catch (err) {
        console.error(err);
        showErrorToast(localImportErrorNotice);
      }
    });
  }

  // Check authentication status and redirect when necessary
  function checkAuthAndRedirect() {
    // A simple API call is enough because the API client handles refresh tokens
    window.apiClient.get('/api/picker/sessions', {
      method: 'HEAD'
    }).then(response => {
      if (response.status === 401 || response.status === 302) {
        // Redirect to login when authentication is required
        window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
      }
    }).catch(error => {
      console.warn('Auth check failed:', error);
      // Ignore network errors
    });
  }

  // Initialise the page
  checkAuthAndRedirect();
  initializeInfiniteScroll();

  // Periodically refresh (every five seconds)
  setInterval(refreshSessions, 5000);
});
</script>
{% endblock %}

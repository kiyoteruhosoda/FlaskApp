{% extends 'base.html' %}
{% block title %}Photo View{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
{% endblock %}

{% block content %}
<h1>Photo View Home</h1>

<div class="mb-3">
  <a href="/auth/picker" class="btn btn-success">
    {{ _('Create New Session') }}
  </a>
  <button id="refresh-sessions" class="btn btn-outline-primary ms-2">
    <i id="refresh-icon" class="fas fa-refresh"></i> {{ _('Refresh') }}
  </button>
  
  <!-- ローカルインポートボタン -->
  <a href="#" id="local-import-btn" class="btn btn-outline-info ms-2">
    <i class="bi bi-folder-plus"></i> ローカルインポート
  </a>
  
  <!-- 設定リンク -->
  <div class="float-end">
    <a href="{{ url_for('photo_view.settings') }}" class="btn btn-outline-secondary me-2">
      設定
    </a>
    <a href="{{ url_for('photo_view.admin_settings') }}" class="btn btn-outline-warning">
      管理者設定
    </a>
  </div>
</div>

<div class="mt-4">
  <h2>{{ _('All Picker Sessions') }}</h2>
  <div id="session-stats" class="mb-3">
    <span id="session-count" class="badge bg-info">{{ _('Loading...') }}</span>
  </div>
  <div id="sessions-list">
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>{{ _('Session ID') }}</th>
            <th>{{ _('Status') }}</th>
            <th>{{ _('Selected Count') }}</th>
            <th>{{ _('File Status') }}</th>
            <th>{{ _('Created At') }}</th>
            <th>{{ _('Last Progress') }}</th>
            <th>{{ _('Actions') }}</th>
          </tr>
        </thead>
        <tbody id="sessions-body">
          <!-- セッションが動的に追加されます -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="loading-indicator" class="text-center" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">{{ _('Loading...') }}</span>
  </div>
  <p class="mt-2">{{ _('Loading more sessions...') }}</p>
</div>

<div id="no-more-data" class="text-center text-muted" style="display: none;">
  <p>{{ _('All sessions loaded') }}</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const sessionsBody = document.getElementById('sessions-body');
  const loadingIndicator = document.getElementById('loading-indicator');
  const noMoreData = document.getElementById('no-more-data');
  const refreshBtn = document.getElementById('refresh-sessions');
  const sessionCount = document.getElementById('session-count');
  
  let totalLoaded = 0;

  function formatDateTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleString();
  }

  function formatCounts(counts) {
    if (!counts || Object.keys(counts).length === 0) return '-';
    return Object.entries(counts)
      .map(([status, count]) => `${status}: ${count}`)
      .join(', ');
  }

  function getStatusBadgeClass(status) {
    switch (status) {
      case 'pending': return 'secondary';
      case 'ready': return 'primary';
      case 'processing': return 'warning';
      case 'importing': return 'info';
      case 'imported': return 'success';
      case 'expired': return 'danger';
      case 'error': return 'danger';
      default: return 'secondary';
    }
  }

  function getCsrfTokenFromCookie() {
    const m = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }

  function createSessionRow(session) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${session.sessionId || 'N/A'}</td>
      <td><span class="badge bg-${getStatusBadgeClass(session.status)}">${session.status}</span></td>
      <td>${session.selectedCount || 0}</td>
      <td><small>${formatCounts(session.counts)}</small></td>
      <td><small>${formatDateTime(session.createdAt)}</small></td>
      <td><small>${formatDateTime(session.lastProgressAt)}</small></td>
      <td>
        <a href="/photo-view?session_id=${session.sessionId}" class="btn btn-sm btn-primary">{{ _('View Details') }}</a>
        ${session.status === 'ready' ? `<button class="btn btn-sm btn-success ms-1" onclick="startImport('${session.sessionId}')">{{ _('Start Import') }}</button>` : ''}
      </td>
    `;
    return tr;
  }

  function initializeInfiniteScroll() {
    const refreshIcon = document.getElementById('refresh-icon');
    
    const paginationClient = new PaginationClient({
      baseUrl: '/api/picker/sessions',
      pageSize: 50, // セッションは1ページ50件程度で十分
      onItemsLoaded: (items, meta) => {
        if (meta.currentPage === 1) {
          sessionsBody.innerHTML = '';
          totalLoaded = 0;
          // ローディングアイコンを停止
          if (refreshIcon) {
            refreshIcon.style.animation = '';
            refreshIcon.classList.remove('fa-spin');
          }
        }
        
        items.forEach(session => {
          const row = createSessionRow(session);
          sessionsBody.appendChild(row);
          totalLoaded++;
        });
        
        sessionCount.textContent = `${totalLoaded} sessions loaded`;
      },
      onError: (error) => {
        console.error('Sessions loading error:', error);
        
        // 認証エラーの場合はログインページにリダイレクト
        if (error.status === 401 || error.status === 302) {
          window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
          return;
        }
        
        sessionsBody.innerHTML = '<tr><td colspan="7"><div class="alert alert-danger">Failed to load sessions.</div></td></tr>';
        sessionCount.textContent = 'Error loading sessions';
      }
    });

    // 最初のページを読み込み
    paginationClient.loadFirst();
  }

  window.startImport = async function(sessionId) {
    try {
      const headers = {};
      const csrf = getCsrfTokenFromCookie();
      if (csrf) headers['X-CSRFToken'] = csrf;

      showInfoToast('インポートを開始しています...', 3000);

      const resp = await fetch(`/api/picker/session/${sessionId}/import`, {
        method: 'POST',
        headers
      });

      if (!resp.ok) {
        const text = await resp.text().catch(() => '');
        console.error('Import start failed:', resp.status, text);
        showErrorToast('{{ _("Failed to start import.") }}');
        return;
      }

      showSuccessToast('{{ _("Import started.") }}', 5000);
      // セッション一覧を再読み込み
      refreshSessions();
    } catch (err) {
      console.error(err);
      showErrorToast('{{ _("Failed to start import.") }}');
    }
  };

  function refreshSessions() {
    // リフレッシュ開始をトースト通知で案内
    showInfoToast('セッション一覧を更新しています...', 3000);
    initializeInfiniteScroll();
  }

  // 更新ボタンの処理
  refreshBtn.addEventListener('click', refreshSessions);

  // ローカルインポートボタンの処理
  document.getElementById('local-import-btn').addEventListener('click', async function(e) {
    e.preventDefault();
    
    if (!confirm('ローカルディレクトリからファイルをインポートしますか？\n取り込まれたファイルは元の場所から削除されます。')) {
      return;
    }
    
    try {
      const headers = {};
      const csrf = getCsrfTokenFromCookie();
      if (csrf) headers['X-CSRFToken'] = csrf;

      // インポート開始の通知
      showInfoToast('ローカルインポートを開始しています...', 3000);

      const resp = await fetch('/api/sync/local-import', {
        method: 'POST',
        headers
      });

      if (!resp.ok) {
        const text = await resp.text().catch(() => '');
        console.error('Local import failed:', resp.status, text);
        showErrorToast('ローカルインポートの開始に失敗しました。');
        return;
      }

      const result = await resp.json();
      showSuccessToast('ローカルインポートを開始しました。セッション一覧で進行状況を確認できます。', 8000);
      
      // セッション一覧を自動更新
      setTimeout(() => {
        refreshSessions();
      }, 2000);
    } catch (err) {
      console.error(err);
      showErrorToast('ローカルインポートの開始に失敗しました。');
    }
  });

  // 認証状態をチェックし、必要に応じてリダイレクト
  function checkAuthAndRedirect() {
    // 簡単な認証チェック用のAPIエンドポイント呼び出し
    fetch('/api/picker/sessions', {
      method: 'HEAD',  // データは不要なのでHEADリクエスト
      headers: {
        'Content-Type': 'application/json'
      }
    }).then(response => {
      if (response.status === 401 || response.status === 302) {
        // 認証が必要な場合はログインページにリダイレクト
        window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
      }
    }).catch(error => {
      console.warn('Auth check failed:', error);
      // ネットワークエラーの場合は継続
    });
  }

  // 初期化
  checkAuthAndRedirect();
  initializeInfiniteScroll();
  
  // 定期的に更新（5秒ごと）
  setInterval(refreshSessions, 5000);
});
</script>
{% endblock %}

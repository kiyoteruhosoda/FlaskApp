{% extends "base.html" %}
{% block title %}{{ _('Google Accounts Management') }}{% endblock %}

{% block content %}
<h2>{{ _('Management') }}</h2>

<!-- Management Navigation Tabs -->
<ul class="nav nav-tabs mb-4">
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.user') }}">
      <i class="fas fa-users"></i> {{ _('User Management') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link active" href="{{ url_for('admin.google_accounts') }}">
      <i class="fab fa-google"></i> {{ _('Google Accounts') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.show_config') }}">
      <i class="fas fa-cogs"></i> {{ _('Config Settings') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.roles') }}">
      <i class="fas fa-user-tag"></i> {{ _('Roles') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.permissions') }}">
      <i class="fas fa-shield-alt"></i> {{ _('Permissions') }}
    </a>
  </li>
</ul>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">{{ _('Google Accounts Management') }}</h3>
  <a href="#" id="btn-add-account" class="btn btn-primary" data-scope-profile="photo_picker">{{ _('Add Account') }}</a>
</div>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>ID</th>
        <th>{{ _('User') }}</th>
        <th>{{ _('Email') }}</th>
        <th>{{ _('Status') }}</th>
        <th>{{ _('Scopes') }}</th>
        <th>{{ _('Last Synced') }}</th>
        <th>{{ _('Token') }}</th>
        <th>{{ _('Refresh Token Expiry') }}</th>
        <th>{{ _('Actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for a in accounts %}
      <tr>
        <td>{{ a.id }}</td>
        <td>
          {% if a.user %}
            {{ a.user.email }}
          {% else %}
            <span class="text-muted">{{ _('No User') }}</span>
          {% endif %}
        </td>
        <td>{{ a.email }}</td>
        <td>
          {% if a.status == 'active' %}
            <span class="badge bg-success">{{ _('active') }}</span>
          {% else %}
            <span class="badge bg-secondary">{{ a.status }}</span>
          {% endif %}
        </td>
        <td style="min-width: 320px;">
          {% set scope_prefix = 'https://www.googleapis.com/auth/' %}
          {% set scope_prefix_len = scope_prefix|length %}
          <div class="d-flex flex-wrap gap-1 scope-list">
            {% for s in a.scopes_list() %}
              {% set has_prefix = s.startswith(scope_prefix) %}
              <span class="badge text-bg-secondary scope-badge" title="{{ s }}">
                {% if has_prefix %}
                  <span class="scope-prefix">{{ scope_prefix }}</span>
                {% endif %}
                <span class="scope-name">{{ has_prefix and s[scope_prefix_len:] or s }}</span>
              </span>
            {% endfor %}
          </div>
        </td>
        <td>{{ a.last_synced_at or '-' }}</td>
        <td>
          {% if a.oauth_token_json %}
            <span class="badge bg-success">OK</span>
          {% else %}
            <span class="badge bg-danger">NG</span>
          {% endif %}
        </td>
        <td>{{ a.refresh_token_expires_at() or '-' }}</td>
        <td>
          <div class="btn-group btn-group-sm" role="group"
               data-id="{{ a.id }}" data-scopes="{{ a.scopes }}" data-scope-profile="photo_picker">
            {% if a.status == 'disabled' %}
              <a href="#" class="btn btn-outline-success btn-activate">{{ _('Activate') }}</a>
            {% else %}
              <a href="#" class="btn btn-outline-secondary btn-disable">{{ _('Disable') }}</a>
            {% endif %}
            <a href="#" class="btn btn-outline-info btn-reauth">{{ _('Re-auth') }}</a>
            <a href="#" class="btn btn-outline-danger btn-delete">{{ _('Delete') }}</a>
            <a href="{{ url_for('auth.picker', account_id=a.id) }}" class="btn btn-outline-secondary">{{ _('Picker') }}</a>
            <a href="#" class="btn btn-outline-secondary btn-test">{{ _('Test') }}</a>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<style>
.scope-list {
  gap: 0.5rem !important;
}

.scope-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.35rem 0.6rem;
  max-width: 100%;
  white-space: normal;
  word-break: break-word;
  cursor: default;
  line-height: 1.2;
  border-radius: 999px;
}

.scope-badge .scope-prefix {
  font-size: 0.7rem;
  letter-spacing: 0.02em;
  background: rgba(255, 255, 255, 0.25);
  color: #fff;
  padding: 0.1rem 0.45rem;
  border-radius: 999px;
}

.scope-badge .scope-name {
  font-weight: 600;
  font-size: 0.85rem;
}

.scope-badge:hover,
.scope-badge:focus {
  background: #5c636a !important;
  position: relative;
  z-index: 1;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Add Account
  const btnAddAccount = document.getElementById('btn-add-account');
  const defaultScopeProfile = btnAddAccount?.dataset.scopeProfile || 'photo_picker';
  if (btnAddAccount) {
    btnAddAccount.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const payload = {
          redirect: '{{ url_for("admin.google_accounts") }}'
        };
        if (defaultScopeProfile) {
          payload.scope_profile = defaultScopeProfile;
        }

        const resp = await fetch('{{ url_for("api.google_oauth_start") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (data.auth_url) {
          window.location.href = data.auth_url;
        }
      } catch (err) {
        console.error(err);
        showErrorToast('{{ _("Failed to start OAuth.") }}');
      }
    });
  }

  // Re-auth
  document.querySelectorAll('.btn-reauth').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const group = e.target.closest('[data-id]');
      const scopes = (group?.dataset.scopes || '')
        .split(',').map(s => s.trim()).filter(Boolean);
      const scopeProfile = group?.dataset.scopeProfile || defaultScopeProfile;
      try {
        const payload = {
          redirect: '{{ url_for("admin.google_accounts") }}'
        };
        if (scopes.length) {
          payload.scopes = scopes;
        }
        if (scopeProfile) {
          payload.scope_profile = scopeProfile;
        }

        const resp = await fetch('{{ url_for("api.google_oauth_start") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (data.auth_url) {
          window.location.href = data.auth_url;
        }
      } catch (err) {
        console.error(err);
        showErrorToast('{{ _("Failed to start re-auth.") }}');
      }
    });
  });

  // Activate
  document.querySelectorAll('.btn-activate').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = e.target.closest('[data-id]')?.dataset.id;
      if (!id) return;
      if (!confirm('{{ _("Activate this Google account?") }}')) return;
      const resp = await fetch(`/api/google/accounts/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'active' })
      });
      if (resp.ok) {
        showSuccessToast('{{ _("Google account activated successfully") }}');
        location.reload();
      } else {
        showErrorToast('{{ _("Failed to activate Google account") }}');
      }
    });
  });

  // Disable
  document.querySelectorAll('.btn-disable').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = e.target.closest('[data-id]')?.dataset.id;
      if (!id) return;
      if (!confirm('{{ _("Disable this Google account?") }}')) return;
      const resp = await fetch(`/api/google/accounts/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'disabled' })
      });
      if (resp.ok) {
        showSuccessToast('{{ _("Google account disabled successfully") }}');
        location.reload();
      } else {
        showErrorToast('{{ _("Failed to disable Google account") }}');
      }
    });
  });

  // Delete
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = e.target.closest('[data-id]')?.dataset.id;
      if (!id) return;
      if (!confirm('{{ _("Delete this Google account?") }}')) return;
      const resp = await fetch(`/api/google/accounts/${id}`, { method: 'DELETE' });
      if (resp.ok) {
        showSuccessToast('{{ _("Google account deleted successfully") }}');
        location.reload();
      } else {
        showErrorToast('{{ _("Failed to delete Google account") }}');
      }
    });
  });

  // Test
  document.querySelectorAll('.btn-test').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = e.target.closest('[data-id]')?.dataset.id;
      if (!id) return;
      const resp = await fetch(`/api/google/accounts/${id}/test`, { method: 'POST' });
      const data = await resp.json();
      if (data.result) {
        showSuccessToast(data.result);
      } else if (data.error) {
        showErrorToast(data.error);
      } else {
        showInfoToast('OK');
      }
    });
  });
});
</script>

{% endblock %}

{% extends 'base.html' %}
{% block title %}セッション リフレッシュ テスト{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">セッション リフレッシュ テスト</h4>
        </div>
        <div class="card-body">
          <p class="text-muted">
            このページでセッション切れ時の自動リフレッシュ機能をテストできます。
          </p>
          
          <div class="row">
            <div class="col-md-6">
              <h5>手動テスト</h5>
              <div class="d-grid gap-2">
                <button id="testApiCall" class="btn btn-primary">
                  API コール テスト
                </button>
                <button id="clearTokens" class="btn btn-warning">
                  トークンをクリア
                </button>
                <button id="expireToken" class="btn btn-danger">
                  トークンを無効化
                </button>
              </div>
            </div>
            
            <div class="col-md-6">
              <h5>ステータス</h5>
              <div class="card">
                <div class="card-body">
                  <div id="status-info">
                    <p><strong>リフレッシュトークン:</strong> <span id="refresh-status">チェック中...</span></p>
                    <p><strong>最後のAPIコール:</strong> <span id="last-api-call">なし</span></p>
                    <p><strong>エラー回数:</strong> <span id="error-count">0</span></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <hr>
          
          <div class="mt-3">
            <h5>APIレスポンス ログ</h5>
            <div class="card">
              <div class="card-body">
                <pre id="api-log" style="max-height: 300px; overflow-y: auto; font-size: 0.9em; background: #f8f9fa;">
ログが表示されます...
                </pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const refreshStatus = document.getElementById('refresh-status');
  const lastApiCall = document.getElementById('last-api-call');
  const errorCount = document.getElementById('error-count');
  const apiLog = document.getElementById('api-log');
  
  let errors = 0;
  
  function log(message) {
    const timestamp = new Date().toLocaleTimeString();
    apiLog.textContent += `[${timestamp}] ${message}\n`;
    apiLog.scrollTop = apiLog.scrollHeight;
  }
  
  function updateStatus() {
    const refreshToken = localStorage.getItem('refresh_token');
    refreshStatus.textContent = refreshToken ? '存在' : '存在しない';
    refreshStatus.className = refreshToken ? 'text-success' : 'text-danger';
    errorCount.textContent = errors;
  }
  
  // 定期的にステータスを更新
  updateStatus();
  setInterval(updateStatus, 1000);
  
  // API コール テスト
  document.getElementById('testApiCall').addEventListener('click', async function() {
    try {
      log('APIコールを開始...');
      const response = await window.apiClient.get('/api/media?pageSize=1');
      
      if (response.ok) {
        const data = await response.json();
        log(`成功: ${data.items?.length || 0} 件のメディアを取得`);
        lastApiCall.textContent = '成功';
        lastApiCall.className = 'text-success';
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
    } catch (error) {
      errors++;
      log(`エラー: ${error.message}`);
      lastApiCall.textContent = 'エラー';
      lastApiCall.className = 'text-danger';
    }
    updateStatus();
  });
  
  // トークンをクリア
  document.getElementById('clearTokens').addEventListener('click', function() {
    localStorage.removeItem('refresh_token');
    log('リフレッシュトークンをクリアしました');
    updateStatus();
  });
  
  // トークンを無効化（期限切れをシミュレート）
  document.getElementById('expireToken').addEventListener('click', function() {
    localStorage.setItem('refresh_token', 'invalid_token_for_testing');
    log('無効なトークンを設定しました（期限切れをシミュレート）');
    updateStatus();
  });
  
  // 初期ログ
  log('セッション リフレッシュ テストページを開始しました');
  log('API コール テストボタンを押してテストを開始してください');
});
</script>
{% endblock %}

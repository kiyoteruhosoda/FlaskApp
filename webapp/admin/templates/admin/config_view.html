{% extends "base.html" %}
{% block title %}{{ _('Config Settings') }}{% endblock %}
{% block content %}
<h2>{{ _('Management') }}</h2>

<!-- Management Navigation Tabs -->
<ul class="nav nav-tabs mb-4">
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.user') }}">
      <i class="fas fa-users"></i> {{ _('User Management') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.google_accounts') }}">
      <i class="fab fa-google"></i> {{ _('Google Accounts') }}
    </a>
  </li>
  {% if current_user.can('service_account:manage') %}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.service_accounts') }}">
      <i class="fas fa-key"></i> {{ _('Service Accounts') }}
    </a>
  </li>
  {% endif %}
  <li class="nav-item">
    <a class="nav-link active" href="{{ url_for('admin.show_config') }}">
      <i class="fas fa-cogs"></i> {{ _('Config Settings') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.roles') }}">
      <i class="fas fa-user-tag"></i> {{ _('Roles') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.permissions') }}">
      <i class="fas fa-shield-alt"></i> {{ _('Permissions') }}
    </a>
  </li>
</ul>

<h3>{{ _('Config Settings') }}</h3>

<h4 class="mt-4">{{ _('Access Token Signing') }}</h4>
<form method="post" class="mb-4">
  <div class="form-check mb-2">
    <input
      class="form-check-input"
      type="radio"
      name="access_token_signing"
      id="access-token-signing-builtin"
      value="builtin"
      {% if signing_setting.is_builtin %}checked{% endif %}
    >
    <label class="form-check-label" for="access-token-signing-builtin">
      {{ _('Built-in secret (HS256)') }}
    </label>
    <div class="form-text">
      {{ _('Use the built-in JWT secret key configured in the application settings.') }}
    </div>
  </div>

  <div class="mt-3">
    <label class="form-label" for="access-token-signing-server">
      {{ _('Server signing certificate groups') }}
    </label>
    {% if server_signing_groups %}
      <div class="list-group">
        {% for group in server_signing_groups %}
        {% set latest = group.latest_certificate %}
        <label class="list-group-item{% if not latest %} disabled{% endif %}">
          <input
            class="form-check-input me-2"
            type="radio"
            name="access_token_signing"
            value="server_signing:{{ group.group_code }}"
            {% if not latest %}disabled{% endif %}
            {% if signing_setting.is_server_signing and signing_setting.group_code == group.group_code %}checked{% endif %}
          >
          <span class="fw-bold">{{ group.group_label or group.group_code or _('Unnamed group') }}</span>
          <span class="text-muted ms-2">{{ group.group_code }}</span>
          {% if latest %}
          <div class="small text-muted mt-1">
            {{ _('Latest active certificate: %(kid)s', kid=latest.kid) }}
            {% if latest.algorithm %}
              <span class="ms-2">
                {{ _('Algorithm: %(algorithm)s', algorithm=latest.algorithm) }}
              </span>
            {% endif %}
            {% if latest.expires_at %}
              <span class="ms-2">
                {{ _('Expires at: %(timestamp)s', timestamp=latest.expires_at|localtime('%Y-%m-%d %H:%M')) }}
              </span>
            {% endif %}
          </div>
          {% if latest.subject %}
            <div class="small text-muted">{{ latest.subject }}</div>
          {% endif %}
          {% else %}
          <div class="small text-muted mt-1">
            {{ _('No active certificates are available in this group.') }}
          </div>
          {% endif %}
        </label>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted mb-0">
        {{ _('No server signing certificate groups are available. Create a certificate group first.') }}
      </p>
    {% endif %}
  </div>

  <button type="submit" class="btn btn-primary mt-3">
    {{ _('Save signing settings') }}
  </button>
</form>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Key</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    {% for key, value in config.items() %}
    <tr>
      <td>{{ key }}</td>
      <td>{{ value }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

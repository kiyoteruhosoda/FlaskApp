{% extends 'base.html' %}
{% block title %}Photo View{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
{% endblock %}

{% block content %}
<h1>Photo View Home</h1>

<div class="mb-3">
  <a href="/auth/picker" class="btn btn-success">
    {{ _('Create New Session') }}
  </a>
  <button id="refresh-sessions" class="btn btn-outline-primary ms-2">
    <i id="refresh-icon" class="fas fa-refresh"></i> {{ _('Refresh') }}
  </button>
  
  <!-- ローカルインポートボタン -->
  <a href="#" id="local-import-btn" class="btn btn-outline-info ms-2">
    <i class="bi bi-folder-plus"></i> ローカルインポート
  </a>
  
  <!-- メディアギャラリーリンク -->
  <a href="{{ url_for('photo_view.media_list') }}" class="btn btn-primary ms-2">
    <i class="fas fa-images"></i> {{ _('View Media Gallery') }}
  </a>
  
  <!-- アルバムリンク -->
  <a href="{{ url_for('photo_view.albums') }}" class="btn btn-outline-success ms-2">
    <i class="fas fa-folder"></i> {{ _('Albums') }}
  </a>
  
  <!-- 設定リンク -->
  <div class="float-end">
    <a href="{{ url_for('photo_view.settings') }}" class="btn btn-outline-secondary me-2">
      設定
    </a>
    <a href="{{ url_for('photo_view.admin_settings') }}" class="btn btn-outline-warning">
      管理者設定
    </a>
  </div>
</div>

<div class="mt-4">
  <h2>{{ _('All Picker Sessions') }}</h2>
  <div id="session-stats" class="mb-3">
    <span id="session-count" class="badge bg-info">{{ _('Loading...') }}</span>
  </div>
  <div id="sessions-list">
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>{{ _('Session ID') }}</th>
            <th>{{ _('Status') }}</th>
            <th>{{ _('Target Account') }}</th>
            <th>{{ _('File Status') }}</th>
            <th>{{ _('Created At') }}</th>
            <th>{{ _('Last Progress') }}</th>
            <th>{{ _('Actions') }}</th>
          </tr>
        </thead>
        <tbody id="sessions-body">
          <!-- セッションが動的に追加されます -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="loading-indicator" class="text-center" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">{{ _('Loading...') }}</span>
  </div>
  <p class="mt-2">{{ _('Loading more sessions...') }}</p>
</div>

<div id="no-more-data" class="text-center text-muted" style="display: none;">
  <p>{{ _('All sessions loaded') }}</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const sessionsBody = document.getElementById('sessions-body');
  const loadingIndicator = document.getElementById('loading-indicator');
  const noMoreData = document.getElementById('no-more-data');
  const refreshBtn = document.getElementById('refresh-sessions');
  const sessionCount = document.getElementById('session-count');

  let totalLoaded = 0;
  const sessionsLoadedLabel = '{{ _('sessions loaded') }}';
  const noSessionsLoadedLabel = '{{ _('No sessions loaded yet') }}';

  function formatDateTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleString();
  }

  const selectionStatusLabels = {
    pending: '{{ _('Pending') }}',
    enqueued: '{{ _('Enqueued') }}',
    running: '{{ _('Running') }}',
    imported: '{{ _('Imported') }}',
    failed: '{{ _('Failed') }}',
    dup: '{{ _('Duplicate') }}',
    skipped: '{{ _('Skipped') }}'
  };

  const sessionStatusLabels = {
    pending: '{{ _('Pending') }}',
    ready: '{{ _('Ready') }}',
    processing: '{{ _('Processing') }}',
    enqueued: '{{ _('Enqueued') }}',
    importing: '{{ _('Importing') }}',
    imported: '{{ _('Imported') }}',
    canceled: '{{ _('Canceled') }}',
    expired: '{{ _('Expired') }}',
    error: '{{ _('Error') }}',
    failed: '{{ _('Failed') }}'
  };

  function formatCounts(counts) {
    if (!counts || Object.keys(counts).length === 0) return '-';
    return Object.entries(counts)
      .map(([status, count]) => `${selectionStatusLabels[status] || status}: ${count}`)
      .join(', ');
  }

  function formatAccountLabel(session) {
    if (session.isLocalImport) {
      return '{{ _('Local Import') }}';
    }
    if (session.accountEmail) {
      return session.accountEmail;
    }
    return '-';
  }

  function getStatusBadgeClass(status) {
    switch (status) {
      case 'pending': return 'secondary';
      case 'ready': return 'primary';
      case 'processing': return 'warning';
      case 'importing': return 'info';
      case 'imported': return 'success';
      case 'expired': return 'danger';
      case 'error': return 'danger';
      default: return 'secondary';
    }
  }

  function hasOnlyDuplicates(counts = {}) {
    let duplicateTotal = 0;
    let otherTotal = 0;

    Object.entries(counts).forEach(([status, count]) => {
      const numericCount = Number(count) || 0;
      if (status === 'dup') {
        duplicateTotal += numericCount;
        return;
      }
      if (numericCount > 0) {
        otherTotal += numericCount;
      }
    });

    return duplicateTotal > 0 && otherTotal === 0;
  }

  function determineDisplayStatus(session) {
    const baseStatus = session.status;
    if (!baseStatus) {
      return 'pending';
    }

    if (['processing', 'importing', 'error', 'failed'].includes(baseStatus) && hasOnlyDuplicates(session.counts)) {
      return 'imported';
    }

    return baseStatus;
  }

  function createSessionRow(session) {
    const tr = document.createElement('tr');
    const displayStatus = determineDisplayStatus(session);
    const statusLabel = sessionStatusLabels[displayStatus] || displayStatus;
    tr.innerHTML = `
      <td>${session.sessionId || 'N/A'}</td>
      <td><span class="badge bg-${getStatusBadgeClass(displayStatus)}">${statusLabel}</span></td>
      <td>${formatAccountLabel(session)}</td>
      <td><small>${formatCounts(session.counts)}</small></td>
      <td><small>${formatDateTime(session.createdAt)}</small></td>
      <td><small>${formatDateTime(session.lastProgressAt)}</small></td>
      <td>
        <a href="/photo-view?session_id=${session.sessionId}" class="btn btn-sm btn-primary">{{ _('View Details') }}</a>
        ${(displayStatus === 'ready' && !session.isLocalImport) ? `<button class="btn btn-sm btn-success ms-1" onclick="startImport('${session.sessionId}')">{{ _('Start Import') }}</button>` : ''}
      </td>
    `;
    return tr;
  }

  function initializeInfiniteScroll() {
    const refreshIcon = document.getElementById('refresh-icon');
    
    const paginationClient = new PaginationClient({
      baseUrl: '/api/picker/sessions',
      pageSize: 50, // セッションは1ページ50件程度で十分
      onItemsLoaded: (items, meta) => {
        if (meta.currentPage === 1) {
          sessionsBody.innerHTML = '';
          totalLoaded = 0;
          // ローディングアイコンを停止
          if (refreshIcon) {
            refreshIcon.style.animation = '';
            refreshIcon.classList.remove('fa-spin');
          }
        }
        
        items.forEach(session => {
          const row = createSessionRow(session);
          sessionsBody.appendChild(row);
          totalLoaded++;
        });
        
        if (totalLoaded > 0) {
          sessionCount.textContent = `${totalLoaded} ${sessionsLoadedLabel}`;
        } else {
          sessionCount.textContent = noSessionsLoadedLabel;
        }
      },
      onError: (error) => {
        console.error('Sessions loading error:', error);

        // 認証エラーの場合はログインページにリダイレクト
        if (error.status === 401 || error.status === 302) {
          window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
          return;
        }

        sessionsBody.innerHTML = `<tr><td colspan="7"><div class="alert alert-danger">{{ _('Failed to load sessions.') }}</div></td></tr>`;
        sessionCount.textContent = '{{ _('Error loading sessions') }}';
      }
    });

    // 最初のページを読み込み
    paginationClient.loadFirst();
  }

  window.startImport = async function(sessionId) {
    try {
      showInfoToast('インポートを開始しています...', 3000);

      const resp = await window.apiClient.post(`/api/picker/session/${sessionId}/import`);

      if (!resp.ok) {
        const text = await resp.text().catch(() => '');
        console.error('Import start failed:', resp.status, text);
        showErrorToast('{{ _("Failed to start import.") }}');
        return;
      }

      showSuccessToast('{{ _("Import started.") }}', 5000);
      // セッション一覧を再読み込み
      refreshSessions();
    } catch (err) {
      console.error(err);
      showErrorToast('{{ _("Failed to start import.") }}');
    }
  };

  function refreshSessions() {
    // リフレッシュ開始時にローディングアイコンを回転させる
    const refreshIcon = document.getElementById('refresh-icon');
    if (refreshIcon) {
      refreshIcon.classList.add('fa-spin');
    }
    initializeInfiniteScroll();
  }

  // 更新ボタンの処理
  refreshBtn.addEventListener('click', refreshSessions);

  // ローカルインポートボタンの処理
  document.getElementById('local-import-btn').addEventListener('click', async function(e) {
    e.preventDefault();
    
    if (!confirm('ローカルディレクトリからファイルをインポートしますか？\n取り込まれたファイルは元の場所から削除されます。')) {
      return;
    }
    
    try {
      // インポート開始の通知
      showInfoToast('ローカルインポートを開始しています...', 3000);

      const resp = await window.apiClient.post('/api/sync/local-import');

      if (!resp.ok) {
        const text = await resp.text().catch(() => '');
        console.error('Local import failed:', resp.status, text);
        showErrorToast('ローカルインポートの開始に失敗しました。');
        return;
      }

      const result = await resp.json();
      showSuccessToast('ローカルインポートを開始しました。セッション一覧で進行状況を確認できます。', 8000);
      
      // セッション一覧を自動更新
      setTimeout(() => {
        refreshSessions();
      }, 2000);
    } catch (err) {
      console.error(err);
      showErrorToast('ローカルインポートの開始に失敗しました。');
    }
  });

  // 認証状態をチェックし、必要に応じてリダイレクト
  function checkAuthAndRedirect() {
    // APIクライアントが自動的に認証チェックとリフレッシュを処理するため、
    // 単純なAPIコールを行うだけで十分
    window.apiClient.get('/api/picker/sessions', {
      method: 'HEAD'
    }).then(response => {
      if (response.status === 401 || response.status === 302) {
        // 認証が必要な場合はログインページにリダイレクト
        window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
      }
    }).catch(error => {
      console.warn('Auth check failed:', error);
      // ネットワークエラーの場合は継続
    });
  }

  // 初期化
  checkAuthAndRedirect();
  initializeInfiniteScroll();
  
  // 定期的に更新（5秒ごと）
  setInterval(refreshSessions, 5000);
});
</script>
{% endblock %}

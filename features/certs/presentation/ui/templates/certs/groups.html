{% extends "base.html" %}
{% block title %}{{ _('Certificate Groups') }} | {{ super() }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3">{{ _('Certificate Groups') }}</h1>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
    <i class="bi bi-plus-circle me-1"></i>{{ _('Create Group') }}
  </button>
</div>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th scope="col">{{ _('Group Code') }}</th>
        <th scope="col">{{ _('Display Name') }}</th>
        <th scope="col">{{ _('Usage') }}</th>
        <th scope="col">{{ _('Auto Rotate') }}</th>
        <th scope="col">{{ _('Rotation Threshold (days)') }}</th>
        <th scope="col">{{ _('Key Type') }}</th>
        <th scope="col">{{ _('Subject') }}</th>
        <th scope="col">{{ _('Updated At') }}</th>
        <th scope="col" class="text-end">{{ _('Actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% if groups %}
        {% for group in groups %}
        <tr>
          <td class="font-monospace">{{ group.group_code }}</td>
          <td>{{ group.display_name or '-' }}</td>
          <td>{{ group.usage_type.value }}</td>
          <td>
            {% if group.auto_rotate %}
            <span class="badge bg-success">{{ _('Enabled') }}</span>
            {% else %}
            <span class="badge bg-secondary">{{ _('Disabled') }}</span>
            {% endif %}
          </td>
          <td>{{ group.rotation_threshold_days }}</td>
          <td>
            {{ group.key_type }}{% if group.key_size %} {{ group.key_size }}{% endif %}{% if group.key_curve %} / {{ group.key_curve }}{% endif %}
          </td>
          <td>
            {% if group.subject %}
              {% for key, value in group.subject.items() %}
              <span class="badge text-bg-light me-1">{{ key }}={{ value }}</span>
              {% endfor %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td>{{ group.updated_at.strftime('%Y-%m-%d %H:%M:%S') if group.updated_at else '-' }}</td>
          <td class="text-end">
            <div class="d-flex justify-content-end flex-wrap gap-2">
              <a class="btn btn-outline-primary btn-sm" href="{{ url_for('certs_ui.group_detail', group_code=group.group_code) }}">
                {{ _('View Certificates') }}
              </a>
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editGroupModal" data-group='{{ {
                  "groupCode": group.group_code,
                  "displayName": group.display_name,
                  "usageType": group.usage_type.value,
                  "keyType": group.key_type,
                  "keyCurve": group.key_curve,
                  "keySize": group.key_size,
                  "autoRotate": group.auto_rotate,
                  "rotationThresholdDays": group.rotation_threshold_days,
                  "subject": group.subject
                } | tojson }}'>
                {{ _('Edit') }}
              </button>
              <form class="m-0" method="post" action="{{ url_for('certs_ui.delete_group', group_code=group.group_code) }}" onsubmit="return confirm('{{ _('Are you sure you want to delete this group?') }}');">
                <button type="submit" class="btn btn-outline-danger btn-sm">{{ _('Delete') }}</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      {% else %}
      <tr>
        <td colspan="9" class="text-center text-muted py-4">{{ _('No certificate groups available.') }}</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{{ url_for('certs_ui.create_group') }}">
        <div class="modal-header">
          <h2 class="modal-title h5" id="createGroupModalLabel">{{ _('Create Certificate Group') }}</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="group_code">{{ _('Group Code') }}</label>
              <input class="form-control" type="text" id="group_code" name="group_code" required>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="display_name">{{ _('Display Name') }}</label>
              <input class="form-control" type="text" id="display_name" name="display_name">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="usage_type">{{ _('Usage Type') }}</label>
              <select class="form-select" id="usage_type" name="usage_type" required>
                <option value="">{{ _('Select usage type') }}</option>
                {% for value, label in usage_options %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="key_type">{{ _('Key Type') }}</label>
              <select class="form-select" id="key_type" name="key_type">
                {% for key_type in key_type_options %}
                <option value="{{ key_type }}">{{ key_type }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="key_size">{{ _('Key Size') }}</label>
              <input class="form-control" type="number" id="key_size" name="key_size" min="0" step="1">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="key_curve">{{ _('Key Curve') }}</label>
              <input class="form-control" type="text" id="key_curve" name="key_curve">
            </div>
            <div class="col-md-3">
              <label class="form-label" for="rotation_threshold_days">{{ _('Rotation Threshold (days)') }}</label>
              <input class="form-control" type="number" id="rotation_threshold_days" name="rotation_threshold_days" value="30" min="1">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="auto_rotate" name="auto_rotate" checked>
                <label class="form-check-label" for="auto_rotate">{{ _('Auto Rotate') }}</label>
              </div>
            </div>
          </div>
          <hr>
          <h3 class="h6 mb-3">{{ _('Subject Template') }}</h3>
          <div class="row g-3">
            {% for oid, field_name, label in subject_fields %}
            <div class="col-md-6">
              <label class="form-label" for="{{ field_name }}">{{ label }}</label>
              <input class="form-control" type="text" id="{{ field_name }}" name="{{ field_name }}" pattern="{{ subject_value_pattern }}" title="{{ subject_value_hint }}">
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary">{{ _('Save Group') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" id="editGroupForm">
        <div class="modal-header">
          <h2 class="modal-title h5" id="editGroupModalLabel">{{ _('Edit Certificate Group') }}</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="edit_group_code">{{ _('Group Code') }}</label>
              <input class="form-control" type="text" id="edit_group_code" name="group_code" readonly>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit_display_name">{{ _('Display Name') }}</label>
              <input class="form-control" type="text" id="edit_display_name" name="display_name">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit_usage_type">{{ _('Usage Type') }}</label>
              <select class="form-select" id="edit_usage_type" name="usage_type" required>
                {% for value, label in usage_options %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="edit_key_type">{{ _('Key Type') }}</label>
              <select class="form-select" id="edit_key_type" name="key_type">
                {% for key_type in key_type_options %}
                <option value="{{ key_type }}">{{ key_type }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="edit_key_size">{{ _('Key Size') }}</label>
              <input class="form-control" type="number" id="edit_key_size" name="key_size" min="0" step="1">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit_key_curve">{{ _('Key Curve') }}</label>
              <input class="form-control" type="text" id="edit_key_curve" name="key_curve">
            </div>
            <div class="col-md-3">
              <label class="form-label" for="edit_rotation_threshold_days">{{ _('Rotation Threshold (days)') }}</label>
              <input class="form-control" type="number" id="edit_rotation_threshold_days" name="rotation_threshold_days" min="1">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="edit_auto_rotate" name="auto_rotate">
                <label class="form-check-label" for="edit_auto_rotate">{{ _('Auto Rotate') }}</label>
              </div>
            </div>
          </div>
          <hr>
          <h3 class="h6 mb-3">{{ _('Subject Template') }}</h3>
          <div class="row g-3">
            {% for oid, field_name, label in subject_fields %}
            <div class="col-md-6">
              <label class="form-label" for="edit_{{ field_name }}">{{ label }}</label>
              <input class="form-control" type="text" id="edit_{{ field_name }}" name="{{ field_name }}" pattern="{{ subject_value_pattern }}" title="{{ subject_value_hint }}">
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary">{{ _('Update Group') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
{% block scripts %}
{{ super() }}
<script>
(function() {
  const editGroupModal = document.getElementById('editGroupModal');
  if (!editGroupModal) {
    return;
  }
  editGroupModal.addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    if (!button) {
      return;
    }
    const groupData = button.getAttribute('data-group');
    if (!groupData) {
      return;
    }
    let parsed;
    try {
      parsed = JSON.parse(groupData);
    } catch (err) {
      console.error('Failed to parse group data', err);
      return;
    }
    const form = document.getElementById('editGroupForm');
    if (!form) {
      return;
    }
    form.action = `{{ url_for('certs_ui.update_group', group_code='__PLACEHOLDER__') }}`.replace('__PLACEHOLDER__', encodeURIComponent(parsed.groupCode));
    const setInputValue = (selector, value, fallback = '') => {
      const element = form.querySelector(selector);
      if (!element) {
        return;
      }
      element.value = value !== undefined && value !== null && value !== '' ? value : fallback;
    };
    const setSelectValue = (selector, rawValue, fallback = '') => {
      const select = form.querySelector(selector);
      if (!select) {
        return;
      }
      const value = rawValue !== undefined && rawValue !== null ? String(rawValue) : fallback;
      const match = Array.from(select.options).find(option => option.value === value);
      if (match) {
        select.value = match.value;
      } else if (fallback) {
        const fallbackMatch = Array.from(select.options).find(option => option.value === fallback);
        if (fallbackMatch) {
          select.value = fallbackMatch.value;
          return;
        }
        select.selectedIndex = 0;
      } else {
        select.selectedIndex = 0;
      }
    };

    setInputValue('#edit_group_code', parsed.groupCode);
    setInputValue('#edit_display_name', parsed.displayName);
    setSelectValue('#edit_usage_type', parsed.usageType);
    setSelectValue('#edit_key_type', parsed.keyType ? String(parsed.keyType).toUpperCase() : null, 'RSA');
    setInputValue('#edit_key_curve', parsed.keyCurve);
    setInputValue('#edit_key_size', parsed.keySize);
    setInputValue('#edit_rotation_threshold_days', parsed.rotationThresholdDays, 30);

    const autoRotate = form.querySelector('#edit_auto_rotate');
    if (autoRotate) {
      autoRotate.checked = Boolean(parsed.autoRotate);
    }

    const subject = parsed.subject || {};
    {% for oid, field_name, label in subject_fields %}
    setInputValue('#edit_{{ field_name }}', subject['{{ oid }}']);
    {% endfor %}
  });
})();
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}{{ _('Google Accounts') }}{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">{{ _('Google Accounts') }}</h2>
  <a href="#" id="btn-add-account" class="btn btn-primary" data-scope-profile="photo_picker">{{ _('Add Account') }}</a>
</div>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>{{ _('Email') }}</th>
        <th>{{ _('Status') }}</th>
        <th>{{ _('Scopes') }}</th>
        <th>{{ _('Last Synced') }}</th>
        <th>{{ _('Token') }}</th>
        <th>{{ _('Refresh Token Expiry') }}</th>
        <th>{{ _('Actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for a in accounts %}
      <tr>
        <td>{{ a.email }}</td>
        <td>
          {% if a.status == 'active' %}
            <span class="badge bg-success">{{ _('active') }}</span>
          {% else %}
            <span class="badge bg-secondary">{{ a.status }}</span>
          {% endif %}
        </td>
        <td style="max-width: 340px;">
          <div class="d-flex flex-wrap gap-1">
            {% for s in a.scopes_list() %}
              <span class="badge text-bg-secondary scope-badge" title="{{ s }}">{{ s }}</span>
            {% endfor %}
          </div>
        </td>
        <td>{{ a.last_synced_at or '-' }}</td>
        <td>
          {% if a.oauth_token_json %}
            <span class="badge bg-success">OK</span>
          {% else %}
            <span class="badge bg-danger">NG</span>
          {% endif %}
        </td>
        <td>{{ a.refresh_token_expires_at() or '-' }}</td>
        <td>
          <div class="btn-group btn-group-sm" role="group"
               data-id="{{ a.id }}" data-scopes="{{ a.scopes }}" data-scope-profile="photo_picker">
            <a href="#" class="btn btn-outline-secondary btn-reauth">{{ _('Reauth') }}</a>
            <a href="#" class="btn btn-outline-secondary btn-disable">{{ _('Disable') }}</a>
            <a href="#" class="btn btn-outline-secondary btn-delete">{{ _('Delete') }}</a>
            <a href="{{ url_for('auth.picker', account_id=a.id) }}" class="btn btn-outline-secondary">{{ _('Picker') }}</a>
            <a href="#" class="btn btn-outline-secondary btn-test">{{ _('Test') }}</a>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<style>
/* スコープバッジを長文でも崩さず見せる（省略表示＋ホバーで読みやすく） */
.scope-badge {
  display: inline-block;
  max-width: 160px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  vertical-align: middle;
  cursor: default;
}
.scope-badge:hover,
.scope-badge:focus {
  background: #e9ecef;
  position: relative;
  z-index: 1;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Add Account（必要に応じてデフォルトスコープをサーバ側で決定）
  const addBtn = document.getElementById('btn-add-account');
  const defaultScopeProfile = addBtn?.dataset.scopeProfile || 'photo_picker';
  if (addBtn) {
    addBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const payload = {
          redirect: '{{ url_for("auth.google_accounts") }}'
        };
        if (defaultScopeProfile) {
          payload.scope_profile = defaultScopeProfile;
        }

        const resp = await fetch('{{ url_for("api.google_oauth_start") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (data.auth_url) {
          window.location.href = data.auth_url;
        }
      } catch (err) {
        console.error(err);
        showErrorToast('Failed to start OAuth.');
      }
    });
  }

  // 再認可
  document.querySelectorAll('.btn-reauth').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const group = e.target.closest('[data-id]');
      const scopes = (group?.dataset.scopes || '')
        .split(',').map(s => s.trim()).filter(Boolean);
      const scopeProfile = group?.dataset.scopeProfile || defaultScopeProfile;
      try {
        const payload = {
          redirect: '{{ url_for("auth.google_accounts") }}'
        };
        if (scopes.length) {
          payload.scopes = scopes;
        }
        if (scopeProfile) {
          payload.scope_profile = scopeProfile;
        }

        const resp = await fetch('{{ url_for("api.google_oauth_start") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (data.auth_url) {
          window.location.href = data.auth_url;
        }
      } catch (err) {
        console.error(err);
        showErrorToast('Failed to start re-auth.');
      }
    });
  });

  // Disable
  document.querySelectorAll('.btn-disable').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = e.target.closest('[data-id]')?.dataset.id;
      if (!id) return;
      const resp = await fetch(`/api/google/accounts/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'disabled' })
      });
      if (resp.ok) {
        showSuccessToast('Account disabled successfully');
        location.reload();
      } else {
        showErrorToast('Failed to disable account');
      }
    });
  });

  // Delete
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = e.target.closest('[data-id]')?.dataset.id;
      if (!id) return;
      if (!confirm('Delete this account?')) return;
      const resp = await fetch(`/api/google/accounts/${id}`, { method: 'DELETE' });
      if (resp.ok) {
        showSuccessToast('Account deleted successfully');
        location.reload();
      } else {
        showErrorToast('Failed to delete account');
      }
    });
  });

  // Test
  document.querySelectorAll('.btn-test').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = e.target.closest('[data-id]')?.dataset.id;
      if (!id) return;
      const resp = await fetch(`/api/google/accounts/${id}/test`, { method: 'POST' });
      const data = await resp.json();
      if (data.result) {
        showSuccessToast(data.result);
      } else if (data.error) {
        showErrorToast(data.error);
      } else {
        showInfoToast('OK');
      }
    });
  });
});
</script>

{% endblock %}

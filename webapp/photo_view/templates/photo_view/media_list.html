{% extends 'base.html' %}
{% block title %}Media List{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
<style>
  .controls-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
  }
  
  .view-controls {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .size-control {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .media-grid {
    display: grid;
    gap: 15px;
    padding: 20px 0;
    transition: all 0.3s ease;
  }
  
  .media-grid.size-small {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
  }
  
  .media-grid.size-medium {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
  }
  
  .media-grid.size-large {
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
  }
  
  .media-card {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
  }
  
  .media-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  }
  
  .media-thumbnail {
    width: 100%;
    object-fit: cover;
    background: #f8f9fa;
  }
  
  .media-grid.size-small .media-thumbnail {
    height: 150px;
  }
  
  .media-grid.size-medium .media-thumbnail {
    height: 200px;
  }
  
  .media-grid.size-large .media-thumbnail {
    height: 280px;
  }
  
  .media-overlay {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.7rem;
  }
  
  .video-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 8px;
    border-radius: 50%;
    font-size: 1.2rem;
  }
  
  .media-info {
    padding: 10px;
    background: white;
  }
  
  .media-title {
    font-size: 0.9rem;
    margin: 0 0 5px 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .media-meta {
    font-size: 0.8rem;
    color: #6c757d;
    margin: 0;
  }
  
  .loading-spinner {
    text-align: center;
    padding: 40px;
  }
  
  .no-more-data {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    font-style: italic;
  }
  
  .filter-badge {
    background: #007bff;
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-left: 5px;
  }
</style>
{% endblock %}

{% block content %}
<div class="controls-bar">
  <div class="d-flex align-items-center">
    <h1 class="h3 mb-0">{{ _('Media Gallery') }}</h1>
    <span id="media-count" class="filter-badge">{{ _('Loading...') }}</span>
  </div>
  
  <div class="view-controls">
    <!-- フィルタ -->
    <select id="type-filter" class="form-select form-select-sm" style="width: auto;">
      <option value="all">{{ _('All Media') }}</option>
      <option value="photo">{{ _('Photos Only') }}</option>
      <option value="video">{{ _('Videos Only') }}</option>
    </select>
    
    <!-- 表示サイズ -->
    <div class="size-control">
      <label for="size-slider" class="form-label mb-0 me-2" style="font-size: 0.9rem;">{{ _('Size') }}:</label>
      <input type="range" id="size-slider" class="form-range" min="1" max="3" value="2" style="width: 80px;">
    </div>
    
    <!-- ソート -->
    <select id="sort-order" class="form-select form-select-sm" style="width: auto;">
      <option value="desc">{{ _('Newest First') }}</option>
      <option value="asc">{{ _('Oldest First') }}</option>
    </select>
    
    <!-- リフレッシュ -->
    <button id="refresh-btn" class="btn btn-outline-primary btn-sm">
      <i class="fas fa-refresh"></i> {{ _('Refresh') }}
    </button>
  </div>
</div>

<div id="media-grid" class="media-grid size-medium">
  <!-- メディアアイテムが動的に追加されます -->
</div>

<div id="loading-indicator" class="loading-spinner" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">{{ _('Loading...') }}</span>
  </div>
  <p class="mt-2">{{ _('Loading more media...') }}</p>
</div>

<div id="no-more-data" class="no-more-data" style="display: none;">
  <p>{{ _('All media loaded') }}</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const mediaGrid = document.getElementById('media-grid');
  const loadingIndicator = document.getElementById('loading-indicator');
  const noMoreData = document.getElementById('no-more-data');
  const sortOrder = document.getElementById('sort-order');
  const refreshBtn = document.getElementById('refresh-btn');
  const mediaCount = document.getElementById('media-count');
  
  let infiniteScroll;
  let totalLoaded = 0;

  function formatDateTime(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString('ja-JP', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  }

  function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '';
    const units = ['B', 'KB', 'MB', 'GB'];
    let size = bytes;
    let unitIndex = 0;
    while (size >= 1024 && unitIndex < units.length - 1) {
      size /= 1024;
      unitIndex++;
    }
    return `${size.toFixed(1)} ${units[unitIndex]}`;
  }

  const sourceLabels = {
    local: '{{ _('ローカルインポート') }}',
    google_photos: '{{ _('Google フォト') }}'
  };
  const unknownSourceLabel = '{{ _('不明なソース') }}';
  const videoLabel = '{{ _('動画') }}';
  const photoLabel = '{{ _('写真') }}';

  function createMediaCard(media) {
    const card = document.createElement('div');
    card.className = 'media-card';

    // 動画かどうかの判定
    const isVideo = media.isVideo || media.is_video;

    const sourceText = media.source_label || sourceLabels[media.source_type] || unknownSourceLabel;
    const accountText = media.account_email ? ` (${media.account_email})` : '';
    const metaParts = [];
    const typeLabel = isVideo ? videoLabel : photoLabel;
    const sizeLabel = formatFileSize(media.bytes);

    if (sizeLabel) {
      metaParts.push(sizeLabel);
    }
    if (sourceText) {
      metaParts.push(`${sourceText}${accountText}`);
    }
    metaParts.push(typeLabel);
    if (media.camera_make) {
      metaParts.push(media.camera_make);
    }

    const metaLine = metaParts.filter(Boolean).join(' • ');

    card.innerHTML = `
      <img class="media-thumbnail"
           src="/api/media/${media.id}/thumbnail?size=256"
           alt="${media.filename || 'Media'}"
           loading="lazy"
           onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg=='">
      
      ${media.width && media.height ? `<div class="media-overlay">${media.width}×${media.height}</div>` : ''}
      
      ${isVideo ? '<div class="video-overlay"><i class="fas fa-play"></i></div>' : ''}

      <div class="media-info">
        <h6 class="media-title">${formatDateTime(media.shot_at) || 'Unknown Date'}</h6>
        <p class="media-meta">${metaLine}</p>
      </div>
    `;
    
    // クリックでメディア詳細ページに遷移
    card.addEventListener('click', () => {
      window.location.href = `/photo-view/media/${media.id}`;
    });
    
    return card;
  }

  function initializeInfiniteScroll() {
    // 現在のフィルタ設定を取得
    const typeFilter = document.getElementById('type-filter').value;
    const sortOrder = document.getElementById('sort-order').value;
    
    // パラメータ設定
    const parameters = { order: sortOrder };
    if (typeFilter !== 'all') {
      parameters.type = typeFilter;
    }
    
    const paginationClient = new PaginationClient({
      baseUrl: '/api/media',
      pageSize: 200,
      parameters: parameters,
      onItemsLoaded: (items, meta) => {
        if (meta.isFirstPage) {
          mediaGrid.innerHTML = '';
          totalLoaded = 0;
        }
        
        items.forEach(media => {
          const card = createMediaCard(media);
          mediaGrid.appendChild(card);
          totalLoaded++;
        });
        
        mediaCount.textContent = `${totalLoaded} media loaded`;
        
        if (items.length === 0 && meta.isFirstPage) {
          mediaGrid.innerHTML = '<div class="text-center text-muted p-5"><h4>No media found</h4><p>Try adjusting your filters or add some media to your collection.</p></div>';
        }
      },
      onError: (error) => {
        console.error('Media loading error:', error);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger';
        errorDiv.textContent = '{{ _("Failed to load media. Please try again.") }}';
        mediaGrid.appendChild(errorDiv);
      }
    });

    infiniteScroll = new InfiniteScrollHelper({
      paginationClient: paginationClient,
      loadingIndicator: loadingIndicator,
      noMoreDataIndicator: noMoreData,
      container: document.body,
      threshold: 200
    });

    infiniteScroll.start();
  }

  // サイズ変更
  const sizeSlider = document.getElementById('size-slider');
  sizeSlider.addEventListener('input', () => {
    const sizeClasses = ['size-small', 'size-medium', 'size-large'];
    mediaGrid.className = `media-grid ${sizeClasses[sizeSlider.value - 1]}`;
  });
  
  // フィルタ変更
  const typeFilter = document.getElementById('type-filter');
  typeFilter.addEventListener('change', () => {
    if (infiniteScroll) {
      infiniteScroll.destroy();
    }
    initializeInfiniteScroll();
  });

  // ソート順変更時の処理
  sortOrder.addEventListener('change', () => {
    if (infiniteScroll) {
      infiniteScroll.destroy();
    }
    initializeInfiniteScroll();
  });

  // 更新ボタンの処理
  refreshBtn.addEventListener('click', () => {
    if (infiniteScroll) {
      infiniteScroll.destroy();
    }
    initializeInfiniteScroll();
  });

  // 初期化
  initializeInfiniteScroll();
});
</script>
{% endblock %}

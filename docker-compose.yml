version: '3.8'

services:
  init-paths:
    image: alpine
    command: >
      sh -c "
        echo '[init] ensure dirs exist';
        mkdir -p /host/db_data;
        mkdir -p /host/data/backups;
        mkdir -p /host/data/celery;
        mkdir -p /host/data/media/local_import;
        mkdir -p /host/data/media/originals;
        mkdir -p /host/data/media/playback;
        mkdir -p /host/data/media/thumbs;
        mkdir -p /host/data/tmp;
        mkdir -p /host/data/uploads;
        echo '[init] apply correct ownership';
        chown -R 999:999 /host/db_data;
        chmod -R 770 /host/db_data;
        chown -R 1000:1000 /host/data;
        chmod -R 775 /host/data;
        echo '[init] done';
      "
    volumes:
      - /volume1/docker/photonest:/host
    restart: "no"

  db:
    image: photonest-db:latest
    container_name: mariadb
    environment:
      - TZ=UTC
    ports:
      - "3307:3306"
    env_file:
      - .env
    volumes:
      - /volume1/docker/photonest/db_data:/var/lib/mysql
    command:
      - --default-time-zone=+00:00
    depends_on:
      init-paths:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p\"${MARIADB_ROOT_PASSWORD}\" --silent"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 180s

  web:
    image: photonest:latest
    init: true
    stop_grace_period: 60s
    entrypoint: ["/script/entrypoint.sh"]
    command: web
    ports:
      - "127.0.0.1:8050:5000"
    environment:
      - FLASK_ENV=production
      - TZ=UTC
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - API_BASE_URL=${API_BASE_URL:-http://localhost:5000}
      - DATABASE_URI=mysql+pymysql://${MARIADB_USER}:${MARIADB_PASSWORD}@db:3306/${MARIADB_DATABASE}?charset=utf8mb4
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - /volume1/docker/photonest/data:/app/data
    user: "${PUID:-1000}:${PGID:-1000}"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import os, urllib.request; base = os.environ.get('API_BASE_URL', 'http://localhost:5000').rstrip('/') ; urllib.request.urlopen(base + '/health/live')\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  worker:
    image: photonest:latest
    init: true
    stop_grace_period: 60s
    entrypoint: ["/script/entrypoint.sh"]
    command: worker
    environment:
      - FLASK_ENV=production
      - TZ=UTC
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - API_BASE_URL=${API_BASE_URL:-http://localhost:5000}
      - DATABASE_URI=mysql+pymysql://${MARIADB_USER}:${MARIADB_PASSWORD}@db:3306/${MARIADB_DATABASE}?charset=utf8mb4
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - /volume1/docker/photonest/data:/app/data
    user: "${PUID:-1000}:${PGID:-1000}"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[c]elery.*worker' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  beat:
    image: photonest:latest
    init: true
    stop_grace_period: 60s
    entrypoint: ["/script/entrypoint.sh"]
    command: beat
    volumes:
      - /volume1/docker/photonest/data/celery:/app/data
    environment:
      - FLASK_ENV=production
      - TZ=UTC
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - API_BASE_URL=${API_BASE_URL:-http://localhost:5000}
      - DATABASE_URI=mysql+pymysql://${MARIADB_USER}:${MARIADB_PASSWORD}@db:3306/${MARIADB_DATABASE}?charset=utf8mb4
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy        
    user: "${PUID:-1000}:${PGID:-1000}"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[c]elery.*beat' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  redis:
    image: redis:7-alpine
    command:
      - redis-server
      - --user
      - default
      - on
      - ">${REDIS_PASSWORD:-photonest123}"
      - +@all
      - ~*
      - allchannels
      - --appendonly
      - "yes"
      - --appendfsync
      - everysec
    environment:
      - TZ=UTC
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-photonest123}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  redis_data:
  media_data:
  thumb_data:
  playback_data:

networks:
  default:
    external: true
    name: photonest-dev
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16

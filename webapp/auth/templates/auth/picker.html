{% extends "base.html" %}
{% block title %}{{ _('Photo Picker') }}{% endblock %}

{% block content %}
<h2>{{ _('Photo Picker') }}</h2>


<p id="picker-link-block">
  <a href="{{ picker_uri }}" target="_blank" rel="noopener" class="btn btn-primary">
    {{ _('Open Photo Picker') }}
  </a>
</p>

<img id="qr-img" src="{{ qr_data }}" alt="QR Code" class="mt-3">

<p id="photo-view-link-block" style="display:none;">
  <a href="{{ url_for('photo_view.home', session_id=session_id) }}"
     target="_blank" rel="noopener" class="btn btn-secondary">
    {{ _('Open Photo View') }}
  </a>
</p>

<!-- 埋め込み用データ（この要素が元コードに無かった） -->
<script id="session-data" type="application/json">
    {{ {
        "db_session_id": session_id,
        "session_name": session_name,
        "poll_interval": poll_interval
      } | tojson | safe }}
  </script>

<script>
  // JSONデータ読込
  const dataEl = document.getElementById('session-data');
  const sessionData = JSON.parse(dataEl.textContent);

  // interval パース（ms/s対応・デフォルトms）
  function parseInterval(v) {
    if (typeof v === 'number') return v;
    if (typeof v === 'string') {
      const m = v.trim().match(/^(\d+(?:\.\d+)?)(ms|s)?$/i);
      if (!m) return NaN;
      const num = Number(m[1]);
      const unit = (m[2] || 'ms').toLowerCase();
      return unit === 's' ? num * 1000 : num;
    }
    return NaN;
  }

  const intervalMs = parseInterval(sessionData.poll_interval);

  async function fetchMediaItems() {
    try {
      let cursor = null;
      do {
        const resp = await fetch('/api/picker/session/mediaItems', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            sessionId: sessionData.session_name,
            cursor: cursor,
          }),
        });
        if (!resp.ok) {
          console.warn('mediaItems fetch failed:', resp.status);
          break;
        }
        const data = await resp.json();
        cursor = data.nextCursor;
      } while (cursor);
    } catch (e) {
      console.error(e);
    }
  }

  let timer;


  async function poll() {
    try {
      const resp = await fetch(`/api/picker/session/${sessionData.db_session_id}`);
      if (!resp.ok) {
        console.warn('status poll failed:', resp.status);
        return;
      }
      const data = await resp.json();
      if (data.mediaItemsSet) {
        clearInterval(timer);
        // picker_uriリンクとqr_dataを非表示にする
        const linkBlock = document.getElementById('picker-link-block');
        if (linkBlock) linkBlock.style.display = 'none';
        const qrImg = document.getElementById('qr-img');
        if (qrImg) qrImg.style.display = 'none';
        // photo_viewリンクを表示
        const photoViewBlock = document.getElementById('photo-view-link-block');
        if (photoViewBlock) photoViewBlock.style.display = '';
        await fetchMediaItems();
      }
    } catch (e) {
      console.error(e);
    }
  }

  if (Number.isFinite(intervalMs) && intervalMs > 0) {
    // 初回即時 + インターバル
    poll();
    timer = setInterval(() => {
      if (document.visibilityState === 'visible') {
        poll();
      }
    }, intervalMs);

    // ページ離脱で停止（念のため）
    window.addEventListener('beforeunload', () => clearInterval(timer));
  } else {
    console.warn('Invalid poll interval:', sessionData.poll_interval);
  }
</script>
{% endblock %}

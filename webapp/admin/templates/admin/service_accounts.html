{% extends "base.html" %}
{% block title %}{{ _('Service Accounts') }}{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h3 mb-1">{{ _('Service Accounts') }}</h1>
    <p class="text-muted mb-0">{{ _('Manage machine-to-machine credentials and scopes.') }}</p>
  </div>
  <button class="btn btn-primary" id="btn-new-account">
    <i class="bi bi-plus-circle"></i>
    <span>{{ _('New Service Account') }}</span>
  </button>
</div>

<ul class="nav nav-tabs mb-4">
  {% if current_user.can('user:manage') %}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.user') }}">
      <i class="fas fa-users"></i> {{ _('User Management') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.google_accounts') }}">
      <i class="fab fa-google"></i> {{ _('Google Accounts') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.show_config') }}">
      <i class="fas fa-cogs"></i> {{ _('Config Settings') }}
    </a>
  </li>
  {% endif %}
  <li class="nav-item">
    <a class="nav-link active" href="{{ url_for('admin.service_accounts') }}">
      <i class="fas fa-robot"></i> {{ _('Service Accounts') }}
    </a>
  </li>
  {% if current_user.can('role:manage') %}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.roles') }}">
      <i class="fas fa-user-tag"></i> {{ _('Roles') }}
    </a>
  </li>
  {% endif %}
  {% if current_user.can('permission:manage') %}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.permissions') }}">
      <i class="fas fa-shield-alt"></i> {{ _('Permissions') }}
    </a>
  </li>
  {% endif %}
</ul>

<div class="card shadow-sm">
  <div class="card-header bg-white d-flex justify-content-between align-items-center">
    <h2 class="h5 mb-0">{{ _('Registered Service Accounts') }}</h2>
    <div class="text-muted small" id="service-account-count"></div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="service-account-table">
        <thead class="table-light">
          <tr>
            <th scope="col">{{ _('Name') }}</th>
            <th scope="col">{{ _('Scopes') }}</th>
            <th scope="col">{{ _('Status') }}</th>
            <th scope="col">{{ _('Registered At') }}</th>
            <th scope="col">{{ _('Updated At') }}</th>
            <th scope="col" class="text-end">{{ _('Actions') }}</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="mt-4">
  <h2 class="h6 text-muted mb-2">{{ _('Available scopes you can assign') }}</h2>
  <div class="d-flex flex-wrap gap-2" id="available-scope-badges"></div>
</div>

<!-- Create / Edit Modal -->
<div class="modal fade" id="serviceAccountModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="serviceAccountModalLabel"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <form id="service-account-form" class="needs-validation" novalidate>
        <div class="modal-body">
          <div class="mb-3">
            <label for="service-account-name" class="form-label">{{ _('Account Name') }}</label>
            <input type="text" class="form-control" id="service-account-name" required maxlength="100">
            <div class="invalid-feedback" data-field="name"></div>
          </div>
          <div class="mb-3">
            <label for="service-account-description" class="form-label">{{ _('Description') }}</label>
            <textarea class="form-control" id="service-account-description" rows="2" maxlength="255"></textarea>
          </div>
          <div class="mb-3">
            <label for="service-account-public-key" class="form-label">{{ _('Public Key (PEM)') }}</label>
            <textarea class="form-control font-monospace" id="service-account-public-key" rows="6" required></textarea>
            <div class="invalid-feedback" data-field="public_key"></div>
          </div>
          <div class="mb-3">
            <label for="service-account-scopes" class="form-label">{{ _('Scopes (comma separated)') }}</label>
            <input type="text" class="form-control" id="service-account-scopes" placeholder="maintenance:read, maintenance:write">
            <div class="form-text">{{ _('Only scopes you already possess can be assigned.') }}</div>
            <div class="invalid-feedback" data-field="scope_names"></div>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="service-account-active" checked>
            <label class="form-check-label" for="service-account-active">{{ _('Enable this account') }}</label>
          </div>
          <div class="alert alert-danger mt-3 d-none" id="service-account-error"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary" id="service-account-submit"></button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="serviceAccountDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="serviceAccountDetailLabel">{{ _('Service Account Details') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0">
          <dt class="col-sm-3">{{ _('Name') }}</dt>
          <dd class="col-sm-9" id="detail-name"></dd>
          <dt class="col-sm-3">{{ _('Description') }}</dt>
          <dd class="col-sm-9" id="detail-description"></dd>
          <dt class="col-sm-3">{{ _('Scopes') }}</dt>
          <dd class="col-sm-9" id="detail-scopes"></dd>
          <dt class="col-sm-3">{{ _('Public Key') }}</dt>
          <dd class="col-sm-9"><pre class="bg-light p-3 small" id="detail-public-key"></pre></dd>
          <dt class="col-sm-3">{{ _('Registered At') }}</dt>
          <dd class="col-sm-9" id="detail-registered"></dd>
          <dt class="col-sm-3">{{ _('Updated At') }}</dt>
          <dd class="col-sm-9" id="detail-updated"></dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
  const initialAccounts = {{ accounts|tojson }};
  const availableScopes = {{ available_scopes|tojson }};

  const tableBody = document.querySelector('#service-account-table tbody');
  const countLabel = document.getElementById('service-account-count');
  const availableScopeBadges = document.getElementById('available-scope-badges');
  const modalElement = document.getElementById('serviceAccountModal');
  const modal = new bootstrap.Modal(modalElement);
  const detailModal = new bootstrap.Modal(document.getElementById('serviceAccountDetailModal'));
  const form = document.getElementById('service-account-form');
  const errorAlert = document.getElementById('service-account-error');
  const submitButton = document.getElementById('service-account-submit');
  const modalTitle = document.getElementById('serviceAccountModalLabel');

  const state = {
    accounts: initialAccounts,
    editingId: null,
  };

  function formatDate(iso) {
    if (!iso) return '-';
    try {
      const date = new Date(iso);
      if (Number.isNaN(date.getTime())) return '-';
      return date.toLocaleString();
    } catch (err) {
      return '-';
    }
  }

  function renderAvailableScopes() {
    availableScopeBadges.innerHTML = '';
    if (!availableScopes || !availableScopes.length) {
      availableScopeBadges.innerHTML = `<span class="badge bg-secondary">{{ _('No scopes available') }}</span>`;
      return;
    }
    availableScopes.sort().forEach(scope => {
      const span = document.createElement('span');
      span.className = 'badge bg-info text-dark';
      span.textContent = scope;
      availableScopeBadges.appendChild(span);
    });
  }

  function renderTable() {
    tableBody.innerHTML = '';
    const rows = [];
    state.accounts.forEach(account => {
      const tr = document.createElement('tr');
      const activeBadge = account.active_flg
        ? `<span class="badge bg-success">{{ _('Active') }}</span>`
        : `<span class="badge bg-secondary">{{ _('Disabled') }}</span>`;
      const scopes = account.scope_names
        ? account.scope_names.split(',').map(scope => `<span class="badge bg-light text-dark me-1">${scope}</span>`).join(' ')
        : '<span class="text-muted">-</span>';
      tr.innerHTML = `
        <td class="fw-semibold">${account.name}</td>
        <td>${scopes}</td>
        <td>${activeBadge}</td>
        <td><small>${formatDate(account.reg_dttm)}</small></td>
        <td><small>${formatDate(account.mod_dttm)}</small></td>
        <td class="text-end">
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-primary" data-action="view" data-id="${account.service_account_id}">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-outline-secondary" data-action="edit" data-id="${account.service_account_id}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-outline-danger" data-action="delete" data-id="${account.service_account_id}">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
      `;
      rows.push(tr);
    });
    rows.forEach(row => tableBody.appendChild(row));
    countLabel.textContent = '{{ _('Total') }}: ' + state.accounts.length;
  }

  function resetValidation() {
    form.classList.remove('was-validated');
    errorAlert.classList.add('d-none');
    errorAlert.textContent = '';
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    form.querySelectorAll('.invalid-feedback').forEach(el => {
      el.textContent = '';
    });
  }

  function openModal(account) {
    resetValidation();
    state.editingId = account ? account.service_account_id : null;
    modalTitle.textContent = account
      ? '{{ _('Edit Service Account') }}'
      : '{{ _('Create Service Account') }}';
    submitButton.textContent = account ? '{{ _('Save Changes') }}' : '{{ _('Create') }}';

    document.getElementById('service-account-name').value = account ? account.name : '';
    document.getElementById('service-account-description').value = account?.description || '';
    document.getElementById('service-account-public-key').value = account ? account.public_key : '';
    document.getElementById('service-account-scopes').value = account ? account.scope_names : '';
    document.getElementById('service-account-active').checked = account ? account.active_flg : true;

    modal.show();
  }

  function showDetail(account) {
    document.getElementById('detail-name').textContent = account.name;
    document.getElementById('detail-description').textContent = account.description || '-';
    document.getElementById('detail-scopes').innerHTML = account.scope_names
      ? account.scope_names.split(',').map(scope => `<span class="badge bg-secondary me-1">${scope}</span>`).join(' ')
      : '<span class="text-muted">-</span>';
    document.getElementById('detail-public-key').textContent = account.public_key || '';
    document.getElementById('detail-registered').textContent = formatDate(account.reg_dttm);
    document.getElementById('detail-updated').textContent = formatDate(account.mod_dttm);
    detailModal.show();
  }

  function findAccount(id) {
    return state.accounts.find(item => item.service_account_id === id);
  }

  function serializeForm() {
    return {
      name: document.getElementById('service-account-name').value.trim(),
      description: document.getElementById('service-account-description').value.trim(),
      public_key: document.getElementById('service-account-public-key').value.trim(),
      scope_names: document.getElementById('service-account-scopes').value.trim(),
      active_flg: document.getElementById('service-account-active').checked,
    };
  }

  async function submitForm(event) {
    event.preventDefault();
    const formData = serializeForm();
    form.classList.add('was-validated');
    if (!form.checkValidity()) {
      return;
    }

    const url = state.editingId
      ? `{{ url_for('admin.service_accounts_update', account_id=0)[:-6] }}${state.editingId}.json`
      : `{{ url_for('admin.service_accounts_create') }}`;
    const method = state.editingId ? 'PUT' : 'POST';

    try {
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });
      const data = await response.json();
      if (!response.ok) {
        if (data && data.error) {
          if (data.field) {
            const feedback = form.querySelector(`.invalid-feedback[data-field="${data.field}"]`);
            if (feedback) {
              feedback.textContent = data.error;
              feedback.closest('.mb-3')?.querySelector('input,textarea')?.classList.add('is-invalid');
            }
          } else {
            errorAlert.textContent = data.error;
            errorAlert.classList.remove('d-none');
          }
        }
        return;
      }

      const item = data.item;
      if (state.editingId) {
        const index = state.accounts.findIndex(a => a.service_account_id === item.service_account_id);
        if (index >= 0) {
          state.accounts.splice(index, 1, item);
        }
      } else {
        state.accounts.push(item);
      }
      renderTable();
      modal.hide();
    } catch (error) {
      errorAlert.textContent = '{{ _('Unexpected error occurred. Please try again.') }}';
      errorAlert.classList.remove('d-none');
    }
  }

  async function deleteAccount(id) {
    if (!confirm('{{ _('Are you sure you want to delete this service account?') }}')) {
      return;
    }
    const url = `{{ url_for('admin.service_accounts_delete', account_id=0)[:-6] }}${id}.json`;
    try {
      const response = await fetch(url, { method: 'DELETE' });
      if (!response.ok) {
        return;
      }
      state.accounts = state.accounts.filter(acc => acc.service_account_id !== id);
      renderTable();
    } catch (error) {
      console.error('Failed to delete service account', error);
    }
  }

  tableBody.addEventListener('click', (event) => {
    const button = event.target.closest('button[data-action]');
    if (!button) return;
    const id = Number.parseInt(button.dataset.id, 10);
    const action = button.dataset.action;
    const account = findAccount(id);
    if (!account) return;

    if (action === 'view') {
      showDetail(account);
    } else if (action === 'edit') {
      openModal(account);
    } else if (action === 'delete') {
      deleteAccount(id);
    }
  });

  document.getElementById('btn-new-account').addEventListener('click', () => openModal(null));
  form.addEventListener('submit', submitForm);

  renderTable();
  renderAvailableScopes();
})();
</script>
{% endblock %}

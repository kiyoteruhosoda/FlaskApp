{% extends 'base.html' %}
{% block title %}Photo View Settings{% endblock %}
{% block content %}
<div class="container">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-3 mb-4">
        <div>
            <h1 class="mb-0">{{ _("Settings") }}</h1>
            <p class="text-muted mb-0 small">
                {{ _("Check the status of local imports and upcoming preferences.") }}
                {% if is_admin %}
                <span class="badge bg-warning text-dark ms-2">{{ _("Admin tools available") }}</span>
                {% endif %}
            </p>
        </div>
        <a href="{{ url_for('photo_view.home') }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> {{ _("Back to Sessions") }}
        </a>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-2">
            <h2 class="h5 mb-0">{{ _("Local Import Overview") }}</h2>
            <div class="d-flex flex-wrap gap-2">
                <button id="refresh-status-btn" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-clockwise"></i> {{ _("Refresh") }}
                </button>
                {% if is_admin %}
                <button id="ensure-dirs-btn" class="btn btn-outline-secondary btn-sm d-none">
                    <i class="bi bi-folder-plus"></i> {{ _("Create Directories") }}
                </button>
                <button id="start-import-btn" class="btn btn-primary btn-sm" disabled>
                    <i class="bi bi-upload"></i> {{ _("Start Import") }}
                </button>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <div id="local-import-loading" class="text-muted d-flex align-items-center gap-2">
                <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
                <span>{{ _("Loading status...") }}</span>
            </div>
            <div id="local-import-content" class="d-none">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="border rounded h-100 p-3 bg-light">
                            <div class="fw-semibold mb-2">{{ _("System Status") }}</div>
                            <span id="system-status" class="badge bg-secondary">-</span>
                            <div class="mt-3">
                                <div class="text-muted small">{{ _("Pending files") }}</div>
                                <div id="pending-files" class="fs-4 fw-semibold">0</div>
                            </div>
                            <p class="text-muted small mb-0 mt-3">
                                {{ _("The import process becomes available when all directories are ready.") }}
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded h-100 p-3">
                            <div class="fw-semibold">{{ _("Import directory") }}</div>
                            <div class="d-flex justify-content-between align-items-start gap-2 mt-2">
                                <code id="import-dir" class="d-block text-break flex-grow-1">-</code>
                                <span id="import-dir-status" class="badge bg-secondary">-</span>
                            </div>
                            <div id="import-dir-extra" class="form-text text-muted mt-2"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded h-100 p-3">
                            <div class="fw-semibold">{{ _("Originals directory") }}</div>
                            <div class="d-flex justify-content-between align-items-start gap-2 mt-2">
                                <code id="originals-dir" class="d-block text-break flex-grow-1">-</code>
                                <span id="originals-dir-status" class="badge bg-secondary">-</span>
                            </div>
                            <div id="originals-dir-extra" class="form-text text-muted mt-2"></div>
                        </div>
                    </div>
                </div>

                <div id="status-message" class="alert alert-warning mt-3 d-none" role="alert"></div>

                {% if not is_admin %}
                <p class="text-muted small mt-3 mb-0">
                    <i class="bi bi-info-circle"></i>
                    {{ _("Only administrators can manage the import process. Please contact the administrator if you need assistance.") }}
                </p>
                {% endif %}
            </div>

            {% if is_admin %}
            <div id="import-progress" class="mt-4 d-none">
                <h3 class="h6 mb-3">{{ _("Import progress") }}</h3>
                <div class="progress mb-2">
                    <div id="progress-bar" class="progress-bar" role="progressbar"
                         style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div id="progress-status" class="mb-2 text-muted small">{{ _("Waiting...") }}</div>
                <div id="progress-details" class="mb-2 text-muted small d-none">
                    <span id="progress-current">0</span> / <span id="progress-total">0</span>
                </div>
                <div id="progress-message" class="text-info small"></div>
            </div>
            <div id="import-result" class="mt-3 d-none"></div>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h2 class="h5 mb-0">{{ _("Other settings") }}</h2>
        </div>
        <div class="card-body">
            <p class="text-muted mb-0">{{ _("User preference settings will be added soon.") }}</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const loadingEl = document.getElementById('local-import-loading');
  const contentEl = document.getElementById('local-import-content');
  const refreshBtn = document.getElementById('refresh-status-btn');
  const systemStatusEl = document.getElementById('system-status');
  const pendingFilesEl = document.getElementById('pending-files');
  const statusMessageEl = document.getElementById('status-message');
  const importDirEl = document.getElementById('import-dir');
  const importDirStatusEl = document.getElementById('import-dir-status');
  const importDirExtraEl = document.getElementById('import-dir-extra');
  const originalsDirEl = document.getElementById('originals-dir');
  const originalsDirStatusEl = document.getElementById('originals-dir-status');
  const originalsDirExtraEl = document.getElementById('originals-dir-extra');
  const ensureDirsBtn = document.getElementById('ensure-dirs-btn');
  const startImportBtn = document.getElementById('start-import-btn');
  const progressSection = document.getElementById('import-progress');
  const progressBar = document.getElementById('progress-bar');
  const progressStatus = document.getElementById('progress-status');
  const progressDetails = document.getElementById('progress-details');
  const progressCurrent = document.getElementById('progress-current');
  const progressTotal = document.getElementById('progress-total');
  const progressMessage = document.getElementById('progress-message');
  const resultDiv = document.getElementById('import-result');

  const isAdmin = JSON.parse("{{ is_admin | tojson }}");

  let currentTaskId = null;
  let progressInterval = null;

  function toggleLoading(isLoading) {
    if (isLoading) {
      loadingEl.classList.remove('d-none');
      contentEl.classList.add('d-none');
    } else {
      loadingEl.classList.add('d-none');
      contentEl.classList.remove('d-none');
    }
  }

  function resetStatusMessage() {
    if (!statusMessageEl) return;
    statusMessageEl.classList.add('d-none');
    statusMessageEl.classList.remove('alert-warning', 'alert-danger', 'alert-success', 'alert-info');
    statusMessageEl.innerHTML = '';
  }

  function showStatusMessage(message, level = 'warning') {
    if (!statusMessageEl) return;
    statusMessageEl.classList.remove('d-none');
    statusMessageEl.classList.remove('alert-warning', 'alert-danger', 'alert-success', 'alert-info');
    statusMessageEl.classList.add(`alert-${level}`);
    statusMessageEl.innerHTML = message;
  }

  function updateBadge(el, ready, trueText, falseText) {
    if (!el) return;
    el.textContent = ready ? trueText : falseText;
    el.className = `badge ${ready ? 'bg-success' : 'bg-danger'}`;
  }

  function escapeHtml(str) {
    if (str === null || str === undefined) {
      return '';
    }
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function updatePathDisplay(raw, absolute, realpath, exists, codeEl, badgeEl, extraEl) {
    if (!codeEl) return;

    const display = realpath || absolute || raw || '{{ _("Not configured") }}';
    codeEl.textContent = display;

    if (badgeEl) {
      updateBadge(badgeEl, exists, '{{ _("Available") }}', '{{ _("Missing") }}');
    }

    if (!extraEl) {
      return;
    }

    const extraLines = [];
    if (raw && raw !== display) {
      extraLines.push(`{{ _("Configured value") }}: <code>${escapeHtml(raw)}</code>`);
    }
    if (absolute && absolute !== display) {
      extraLines.push(`{{ _("Absolute path") }}: <code>${escapeHtml(absolute)}</code>`);
    }
    if (realpath && realpath !== display) {
      extraLines.push(`{{ _("Resolved path") }}: <code>${escapeHtml(realpath)}</code>`);
    }

    if (extraLines.length) {
      extraEl.innerHTML = extraLines.join('<br>');
      extraEl.classList.remove('d-none');
    } else {
      extraEl.textContent = '';
      extraEl.classList.add('d-none');
    }
  }

  function updateSystemStatus(status, config) {
    const ready = Boolean(status?.ready);
    const pending = Number(status?.pending_files || 0);

    pendingFilesEl.textContent = pending;

    if (ready) {
      systemStatusEl.textContent = '{{ _("Ready") }}';
      systemStatusEl.className = 'badge bg-success';
      resetStatusMessage();
    } else {
      systemStatusEl.textContent = '{{ _("Needs attention") }}';
      systemStatusEl.className = 'badge bg-warning text-dark';

      const issues = [];
      if (!config.import_dir_exists) {
        issues.push('{{ _("Import directory is missing.") }}');
      }
      if (!config.originals_dir_exists) {
        issues.push('{{ _("Originals directory is missing.") }}');
      }
      if (!issues.length) {
        issues.push('{{ _("Please review the configuration.") }}');
      }
      showStatusMessage(`<strong>{{ _("Attention") }}:</strong><br>${issues.join('<br>')}`);
    }

    if (isAdmin && startImportBtn) {
      const canImport = ready && pending > 0;
      startImportBtn.disabled = !canImport;
      startImportBtn.setAttribute('aria-disabled', String(!canImport));
    }

    if (isAdmin && ensureDirsBtn) {
      const needsDirectories = !config.import_dir_exists || !config.originals_dir_exists;
      ensureDirsBtn.classList.toggle('d-none', !needsDirectories);
      ensureDirsBtn.disabled = false;
    }
  }

  function updateFromConfig(data) {
    if (!data || !data.config || !data.status) {
      showStatusMessage('{{ _("Failed to load status.") }}', 'danger');
      return;
    }

    updatePathDisplay(
      data.config.import_dir,
      data.config.import_dir_absolute,
      data.config.import_dir_realpath,
      data.config.import_dir_exists,
      importDirEl,
      importDirStatusEl,
      importDirExtraEl
    );

    updatePathDisplay(
      data.config.originals_dir,
      data.config.originals_dir_absolute,
      data.config.originals_dir_realpath,
      data.config.originals_dir_exists,
      originalsDirEl,
      originalsDirStatusEl,
      originalsDirExtraEl
    );

    updateSystemStatus(data.status, data.config);

  }

  async function loadStatus() {
    toggleLoading(true);
    resetStatusMessage();

    try {
      const response = await fetch('/api/sync/local-import/status');
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      const data = await response.json();
      updateFromConfig(data);
    } catch (error) {
      showStatusMessage(`{{ _("Failed to load status.") }} ${error.message}`, 'danger');
    } finally {
      toggleLoading(false);
    }
  }

  function clearProgressTimer() {
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
  }

  function showProgressSection() {
    if (!progressSection) return;
    progressSection.classList.remove('d-none');
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', '0');
    progressBar.textContent = '0%';
    progressBar.classList.remove('bg-success', 'bg-danger');
    progressStatus.innerHTML = '<small>{{ _("Starting...") }}</small>';
    if (progressDetails) {
      progressDetails.classList.add('d-none');
      progressCurrent.textContent = '0';
      progressTotal.textContent = '0';
    }
    if (progressMessage) {
      progressMessage.textContent = '';
    }
  }

  function hideProgressSection() {
    if (!progressSection) return;
    progressSection.classList.add('d-none');
  }

  function showResult(content, level = 'success') {
    if (!resultDiv) return;
    resultDiv.className = `alert alert-${level}`;
    resultDiv.innerHTML = content;
    resultDiv.classList.remove('d-none');
  }

  function hideResult() {
    if (!resultDiv) return;
    resultDiv.classList.add('d-none');
    resultDiv.innerHTML = '';
  }

  async function checkProgress(taskId) {
    try {
      const response = await fetch(`/api/sync/local-import/task/${encodeURIComponent(taskId)}`);
      const data = await response.json();

      if (data.state === 'PROGRESS') {
        const progress = Number(data.progress || 0);
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', String(progress));
        progressBar.textContent = `${progress}%`;
        progressStatus.innerHTML = `<small class="text-info">${data.status || '{{ _("Processing...") }}'}</small>`;

        if (data.current && data.total && progressDetails) {
          progressCurrent.textContent = data.current;
          progressTotal.textContent = data.total;
          progressDetails.classList.remove('d-none');
        }
        if (data.message && progressMessage) {
          progressMessage.textContent = data.message;
        }
      } else if (data.state === 'SUCCESS') {
        clearProgressTimer();
        progressBar.style.width = '100%';
        progressBar.setAttribute('aria-valuenow', '100');
        progressBar.textContent = '100%';
        progressBar.classList.add('bg-success');
        progressStatus.innerHTML = '<small class="text-success">{{ _("Completed") }}</small>';

        const result = data.result || {};
        const summary = `
          <div>
            <strong>{{ _("Processed") }}</strong>: ${result.processed || 0},
            <strong>{{ _("Succeeded") }}</strong>: ${result.success || 0},
            <strong>{{ _("Skipped") }}</strong>: ${result.skipped || 0},
            <strong>{{ _("Failed") }}</strong>: ${result.failed || 0}
          </div>`;
        const successContent = `
          <div>
            <i class="bi bi-check-circle text-success"></i> {{ _("Import completed.") }}
          </div>${summary}`;
        showResult(successContent, 'success');
        hideProgressSection();
        loadStatus();
      } else if (data.state === 'FAILURE' || data.state === 'ERROR') {
        clearProgressTimer();
        progressBar.classList.add('bg-danger');
        progressStatus.innerHTML = '<small class="text-danger">{{ _("Error occurred") }}</small>';
        const errorMessage = data.error || data.status || '{{ _("An unexpected error occurred.") }}';
        showResult(`<div><i class="bi bi-exclamation-triangle text-danger"></i> ${errorMessage}</div>`, 'danger');
        hideProgressSection();
        loadStatus();
      }
    } catch (error) {
      console.error('Progress check failed', error);
    }
  }

  async function handleEnsureDirectories() {
    if (!ensureDirsBtn) return;
    const originalHtml = ensureDirsBtn.innerHTML;
    ensureDirsBtn.disabled = true;
    ensureDirsBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>{{ _("Working...") }}';

    try {
      const response = await fetch('/api/sync/local-import/directories', { method: 'POST' });
      const data = await response.json();
      if (response.ok && data.success) {
        if (typeof showSuccessToast === 'function') {
          showSuccessToast(data.message || '{{ _("Directories created successfully.") }}');
        }
      } else {
        const message = data.error || data.message || '{{ _("Failed to create directories.") }}';
        showStatusMessage(message, 'danger');
        if (typeof showErrorToast === 'function') {
          showErrorToast(message);
        }
      }
    } catch (error) {
      const message = `{{ _("Failed to create directories.") }} ${error.message}`;
      showStatusMessage(message, 'danger');
    } finally {
      ensureDirsBtn.innerHTML = originalHtml;
      ensureDirsBtn.disabled = false;
      loadStatus();
    }
  }

  async function handleStartImport() {
    if (!startImportBtn) return;

    const originalHtml = startImportBtn.innerHTML;
    startImportBtn.disabled = true;
    startImportBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>{{ _("Starting...") }}';
    hideResult();
    showProgressSection();

    try {
      const response = await fetch('/api/sync/local-import', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ duplicateRegeneration: 'regenerate' }),
      });
      const data = await response.json();
      if (!response.ok || !data.success) {
        const message = data.error || '{{ _("Failed to start import.") }}';
        showResult(`<div><i class="bi bi-exclamation-triangle text-danger"></i> ${message}</div>`, 'danger');
        hideProgressSection();
        if (typeof showErrorToast === 'function') {
          showErrorToast(message);
        }
        return;
      }

      currentTaskId = data.task_id;
      if (typeof showSuccessToast === 'function') {
        showSuccessToast('{{ _("Import started.") }}');
      }
      clearProgressTimer();
      progressInterval = setInterval(() => {
        if (currentTaskId) {
          checkProgress(currentTaskId);
        }
      }, 1000);
      loadStatus();
    } catch (error) {
      const message = `{{ _("Failed to start import.") }} ${error.message}`;
      showResult(`<div><i class="bi bi-exclamation-triangle text-danger"></i> ${message}</div>`, 'danger');
      hideProgressSection();
    } finally {
      startImportBtn.innerHTML = originalHtml;
      startImportBtn.disabled = false;
    }
  }

  refreshBtn?.addEventListener('click', (event) => {
    event.preventDefault();
    loadStatus();
  });

  if (ensureDirsBtn) {
    ensureDirsBtn.addEventListener('click', (event) => {
      event.preventDefault();
      handleEnsureDirectories();
    });
  }

  if (startImportBtn) {
    startImportBtn.addEventListener('click', (event) => {
      event.preventDefault();
      if (!startImportBtn.disabled) {
        handleStartImport();
      }
    });
  }

  loadStatus();
});
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}{{ _('Config Settings') }}{% endblock %}
{% block content %}
<h2>{{ _('Management') }}</h2>

<!-- Management Navigation Tabs -->
<ul class="nav nav-tabs mb-4">
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.user') }}">
      <i class="fas fa-users"></i> {{ _('User Management') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.google_accounts') }}">
      <i class="fab fa-google"></i> {{ _('Google Accounts') }}
    </a>
  </li>
  {% if current_user.can('service_account:manage') %}
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.service_accounts') }}">
      <i class="fas fa-key"></i> {{ _('Service Accounts') }}
    </a>
  </li>
  {% endif %}
  <li class="nav-item">
    <a class="nav-link active" href="{{ url_for('admin.show_config') }}">
      <i class="fas fa-cogs"></i> {{ _('Config Settings') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.roles') }}">
      <i class="fas fa-user-tag"></i> {{ _('Roles') }}
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.permissions') }}">
      <i class="fas fa-shield-alt"></i> {{ _('Permissions') }}
    </a>
  </li>
</ul>

<h3>{{ _('Config Settings') }}</h3>

<h4 class="mt-4">{{ _('Access Token Signing') }}</h4>
<form method="post" class="mb-4" data-ajax-config-form data-config-form="signing">
  <input type="hidden" name="action" value="update-signing">
  <div class="form-check mb-2">
    <input
      class="form-check-input"
      type="radio"
      name="access_token_signing"
      id="access-token-signing-builtin"
      value="builtin"
      {% if signing_setting.is_builtin %}checked{% endif %}
    >
    <label class="form-check-label" for="access-token-signing-builtin">
      {{ _('Built-in secret (HS256)') }}
    </label>
    <div class="form-text">
      {{ _('Use the built-in JWT secret key configured in the application settings.') }}
    </div>
  </div>

  <div class="mt-3">
    <label class="form-label" for="access-token-signing-server">
      {{ _('Server signing certificate groups') }}
    </label>
    {% if server_signing_groups %}
      <div class="list-group">
        {% for group in server_signing_groups %}
        {% set latest = group.latest_certificate %}
        <label class="list-group-item{% if not latest %} disabled{% endif %}">
          <input
            class="form-check-input me-2"
            type="radio"
            name="access_token_signing"
            value="server_signing:{{ group.group_code }}"
            {% if not latest %}disabled{% endif %}
            {% if signing_setting.is_server_signing and signing_setting.group_code == group.group_code %}checked{% endif %}
          >
          <span class="fw-bold">{{ group.group_label or group.group_code or _('Unnamed group') }}</span>
          <span class="text-muted ms-2">{{ group.group_code }}</span>
          {% if latest %}
          <div class="small text-muted mt-1">
            {{ _('Latest active certificate: %(kid)s', kid=latest.kid) }}
            {% if latest.algorithm %}
              <span class="ms-2">
                {{ _('Algorithm: %(algorithm)s', algorithm=latest.algorithm) }}
              </span>
            {% endif %}
            {% if latest.expires_at %}
              <span class="ms-2">
                {{ _('Expires at: %(timestamp)s', timestamp=latest.expires_at|localtime('%Y-%m-%d %H:%M')) }}
              </span>
            {% endif %}
          </div>
          {% if latest.subject %}
            <div class="small text-muted">{{ latest.subject }}</div>
          {% endif %}
          {% else %}
          <div class="small text-muted mt-1">
            {{ _('No active certificates are available in this group.') }}
          </div>
          {% endif %}
        </label>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted mb-0">
        {{ _('No server signing certificate groups are available. Create a certificate group first.') }}
      </p>
    {% endif %}
  </div>

  <button type="submit" class="btn btn-primary mt-3">
    {{ _('Save signing settings') }}
  </button>
  {% if signing_config_updated_at %}
  <div
    class="form-text text-muted mt-2"
    data-timestamp-target="signing"
    data-label-updated="{{ _('Last updated at: %(timestamp)s', timestamp='__TIME__') }}"
    data-description-label="{{ _('Description: %(description)s', description='__DESC__') }}"
  >
    {{ _('Last updated at: %(timestamp)s', timestamp=signing_config_updated_at|localtime('%Y-%m-%d %H:%M')) }}
  </div>
  {% endif %}
</form>

<h4 class="mt-4">{{ _('Application Configuration (system settings)') }}</h4>
<form method="post" class="mb-4" data-ajax-config-form data-config-form="application">
  <input type="hidden" name="action" value="update-app-config-fields">
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th scope="col">{{ _('Key') }}</th>
          <th scope="col">{{ _('Current value') }}</th>
          <th scope="col">{{ _('Default') }}</th>
          <th scope="col">{{ _('New value') }}</th>
          <th scope="col">{{ _('Required') }}</th>
          <th scope="col">{{ _('Description') }}</th>
          <th scope="col">{{ _('Apply') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for field in application_fields %}
        <tr data-app-key="{{ field.key }}">
          <td>
            <div><code>{{ field.key }}</code></div>
            <div class="text-muted small">{{ field.label }}</div>
            <span
              class="badge mt-1 {% if field.using_default %}bg-secondary{% else %}bg-info{% endif %}"
              data-field="status-badge"
              data-label-using-default="{{ _('Using default') }}"
              data-label-overridden="{{ _('Overridden') }}"
            >
              {% if field.using_default %}
              {{ _('Using default') }}
              {% else %}
              {{ _('Overridden') }}
              {% endif %}
            </span>
          </td>
          <td class="font-monospace small" data-field="current">{{ field.current_json }}</td>
          <td
            class="font-monospace small{% if not field.default_json %} text-muted{% endif %}"
            data-field="default"
            data-none-label="{{ _('None') }}"
          >
            {% if field.default_json %}
              {{ field.default_json }}
            {% else %}
              {{ _('None') }}
            {% endif %}
          </td>
          <td>
            {% if field.editable %}
              {% if field.data_type == 'boolean' %}
              <select
                class="form-select form-select-sm"
                name="app_config_new[{{ field.key }}]"
                data-field-input
              >
                {% for value, label in field.choices %}
                <option value="{{ value }}" {% if field.form_value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
              {% elif field.data_type == 'list' %}
              <textarea
                class="form-control form-control-sm font-monospace"
                name="app_config_new[{{ field.key }}]"
                rows="3"
                data-field-input
              >{{ field.form_value }}</textarea>
              <div class="form-text">{{ _('One value per line.') }}</div>
              {% elif field.data_type == 'integer' %}
              <input
                type="number"
                class="form-control form-control-sm"
                name="app_config_new[{{ field.key }}]"
                value="{{ field.form_value }}"
                data-field-input
              >
              {% elif field.data_type == 'float' %}
              <input
                type="number"
                step="any"
                class="form-control form-control-sm"
                name="app_config_new[{{ field.key }}]"
                value="{{ field.form_value }}"
                data-field-input
              >
              {% else %}
              <input
                type="text"
                class="form-control form-control-sm"
                name="app_config_new[{{ field.key }}]"
                value="{{ field.form_value }}"
                data-field-input
              >
              {% endif %}
              <div class="form-check mt-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="app-config-use-default-{{ field.key }}"
                  name="app_config_use_default[{{ field.key }}]"
                  value="1"
                  {% if field.use_default %}checked{% endif %}
                  data-field-use-default
                >
                <label class="form-check-label" for="app-config-use-default-{{ field.key }}">
                  {{ _('Revert to default value') }}
                </label>
              </div>
            {% else %}
              {% if field.multiline %}
              <textarea class="form-control form-control-sm font-monospace" rows="3" readonly disabled>{{ field.form_value }}</textarea>
              {% else %}
              <input
                type="text"
                class="form-control form-control-sm"
                value="{{ field.form_value }}"
                readonly
                disabled
              >
              {% endif %}
              <div class="form-text text-muted">{{ _('This setting is read-only and cannot be changed from the admin UI.') }}</div>
            {% endif %}
          </td>
          <td>{% if field.required %}{{ _('Yes') }}{% else %}{{ _('No') }}{% endif %}</td>
          <td class="small">{{ field.description }}</td>
          <td>
            {% if field.editable %}
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="app-config-selected-{{ field.key }}"
                name="app_config_selected"
                value="{{ field.key }}"
                {% if field.selected %}checked{% endif %}
                data-field-select
              >
              <label class="form-check-label" for="app-config-selected-{{ field.key }}">
                {{ _('Update') }}
              </label>
            </div>
            {% else %}
            <span class="badge bg-secondary">{{ _('Read only') }}</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="d-flex justify-content-between align-items-center">
    <button type="submit" class="btn btn-primary">
      {{ _('Save application configuration') }}
    </button>
    {% if application_config_updated_at %}
    <div
      class="form-text text-muted text-end"
      data-timestamp-target="application"
      data-description-target="application"
      data-label-updated="{{ _('Last updated at: %(timestamp)s', timestamp='__TIME__') }}"
      data-description-label="{{ _('Description: %(description)s', description='__DESC__') }}"
    >
      {{ _('Last updated at: %(timestamp)s', timestamp=application_config_updated_at|localtime('%Y-%m-%d %H:%M')) }}
      {% if application_config_description %}
      <br>{{ _('Description: %(description)s', description=application_config_description) }}
      {% endif %}
    </div>
    {% endif %}
  </div>
</form>

<h4 class="mt-4">{{ _('CORS Allowed Origins') }}</h4>
<form method="post" class="mb-4" data-ajax-config-form data-config-form="cors">
  <input type="hidden" name="action" value="update-cors">
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th scope="col">{{ _('Key') }}</th>
          <th scope="col">{{ _('Current value') }}</th>
          <th scope="col">{{ _('Default') }}</th>
          <th scope="col">{{ _('New value') }}</th>
          <th scope="col">{{ _('Required') }}</th>
          <th scope="col">{{ _('Description') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for field in cors_fields %}
        <tr data-cors-key="{{ field.key }}">
          <td>
            <div><code>{{ field.key }}</code></div>
            <div class="text-muted small">{{ field.label }}</div>
            <span
              class="badge mt-1 {% if field.using_default %}bg-secondary{% else %}bg-info{% endif %}"
              data-field="status-badge"
              data-label-using-default="{{ _('Using default') }}"
              data-label-overridden="{{ _('Overridden') }}"
            >
              {% if field.using_default %}
              {{ _('Using default') }}
              {% else %}
              {{ _('Overridden') }}
              {% endif %}
            </span>
          </td>
          <td class="font-monospace small" data-field="current">{{ field.current_json }}</td>
          <td
            class="font-monospace small{% if not field.default_json %} text-muted{% endif %}"
            data-field="default"
            data-none-label="{{ _('None') }}"
          >
            {% if field.default_json %}
              {{ field.default_json }}
            {% else %}
              {{ _('None') }}
            {% endif %}
          </td>
          <td>
            {% if field.data_type == 'list' %}
            <textarea
              class="form-control form-control-sm font-monospace"
              name="cors_new[{{ field.key }}]"
              rows="3"
              data-cors-input
            >{{ field.form_value }}</textarea>
            <div class="form-text">{{ _('One value per line. Use "*" to allow any origin.') }}</div>
            {% else %}
            <input
              type="text"
              class="form-control form-control-sm"
              name="cors_new[{{ field.key }}]"
              value="{{ field.form_value }}"
              data-cors-input
            >
            {% endif %}
            <div class="form-check mt-2">
              <input
                class="form-check-input"
                type="checkbox"
                id="cors-use-default-{{ field.key }}"
                name="cors_use_default[{{ field.key }}]"
                value="1"
                {% if field.use_default %}checked{% endif %}
                data-cors-use-default
              >
              <label class="form-check-label" for="cors-use-default-{{ field.key }}">
                {{ _('Revert to default value') }}
              </label>
            </div>
          </td>
          <td>{% if field.required %}{{ _('Yes') }}{% else %}{{ _('No') }}{% endif %}</td>
          <td class="small">{{ field.description }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="d-flex justify-content-between align-items-center">
    <button type="submit" class="btn btn-primary">
      {{ _('Save CORS settings') }}
    </button>
    {% if cors_config_updated_at %}
    <div
      class="form-text text-muted text-end"
      data-timestamp-target="cors"
      data-description-target="cors"
      data-label-updated="{{ _('Last updated at: %(timestamp)s', timestamp='__TIME__') }}"
      data-description-label="{{ _('Description: %(description)s', description='__DESC__') }}"
    >
      {{ _('Last updated at: %(timestamp)s', timestamp=cors_config_updated_at|localtime('%Y-%m-%d %H:%M')) }}
      {% if cors_config_description %}
      <br>{{ _('Description: %(description)s', description=cors_config_description) }}
      {% endif %}
    </div>
    {% endif %}
  </div>
</form>

<table class="table table-bordered" data-config-table>
  <thead>
    <tr>
      <th>Key</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody data-config-table-body>
    {% for key, value in config.items() %}
    <tr>
      <td>{{ key }}</td>
      <td>{{ value }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/admin-config.js') }}"></script>
{% endblock %}

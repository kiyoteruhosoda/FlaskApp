{% extends "base.html" %}
{% block title %}{{ _('API Key Management') }}{% endblock %}

{% block extra_head %}
<style>
  #api-key-table tbody tr td {
    vertical-align: middle;
  }
  #api-key-empty {
    padding: 3rem 1.5rem;
  }
  .api-key-status-badge {
    font-size: 0.85rem;
  }
  .scope-badge {
    font-size: 0.85rem;
  }
  #create-api-key-scopes .btn-check + .scope-option {
    padding: 1rem;
    border-radius: 0.75rem;
    border: 1px solid var(--bs-border-color);
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    box-shadow: 0 0 0 rgba(13, 110, 253, 0);
  }
  #create-api-key-scopes .scope-option-name {
    font-weight: 600;
    word-break: break-all;
  }
  #create-api-key-scopes .scope-option-icon {
    opacity: 0;
    color: rgba(13, 110, 253, 0.85);
    transition: opacity 0.2s ease, color 0.2s ease;
  }
  #create-api-key-scopes .scope-option:hover {
    border-color: rgba(13, 110, 253, 0.45);
    box-shadow: 0 0.75rem 1.5rem rgba(13, 110, 253, 0.12);
  }
  #create-api-key-scopes .btn-check:checked + .scope-option {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: #fff;
    box-shadow: 0 0.75rem 1.5rem rgba(13, 110, 253, 0.35);
  }
  #create-api-key-scopes .btn-check:checked + .scope-option .scope-option-icon {
    opacity: 1;
    color: rgba(255, 255, 255, 0.85);
  }
  #revealed-api-key {
    font-family: var(--bs-font-monospace);
    word-break: break-all;
    font-size: 1rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-start justify-content-between flex-wrap gap-3 mb-4">
  <div>
    <a class="btn btn-link px-0" href="{{ url_for('admin.service_accounts') }}">
      <i class="bi bi-arrow-left"></i>
      {{ _('Back to Service Accounts') }}
    </a>
    <h1 class="h3 mt-2 mb-1">{{ account.name }}</h1>
    <p class="text-muted mb-0">{{ _('Manage API keys issued for this service account.') }}</p>
  </div>
  {% if can_manage_api_keys %}
  <div class="text-end">
    <button class="btn btn-primary" id="btn-create-api-key">
      <i class="bi bi-plus-circle me-1"></i>
      {{ _('Issue API Key') }}
    </button>
  </div>
  {% endif %}
</div>

<div id="api-key-alert-container" class="mb-4"></div>

<div class="row g-4 mb-4">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h6 text-muted text-uppercase mb-3">{{ _('Service Account Overview') }}</h2>
        <div class="row gy-4">
          <div class="col-md-6">
            <span class="text-muted small">{{ _('Status') }}</span>
            <div class="mt-1">
              {% if account.active %}
                <span class="badge bg-success api-key-status-badge">{{ _('Active') }}</span>
              {% else %}
                <span class="badge bg-secondary api-key-status-badge">{{ _('Disabled') }}</span>
              {% endif %}
            </div>
          </div>
          <div class="col-md-6">
            <span class="text-muted small">{{ _('Certificate Group') }}</span>
            <div class="mt-1 text-break">
              {% if account.certificate_group_code %}
                {% if account.certificate_group_display_name %}
                  <div>{{ account.certificate_group_display_name }}</div>
                  <div class="text-muted small">{{ account.certificate_group_code }}</div>
                {% else %}
                  {{ account.certificate_group_code }}
                {% endif %}
              {% else %}
                -
              {% endif %}
            </div>
          </div>
          <div class="col-12">
            <span class="text-muted small">{{ _('Description') }}</span>
            <div class="mt-1">{{ account.description or '-' }}</div>
          </div>
          <div class="col-12">
            <span class="text-muted small">{{ _('Registered Scopes') }}</span>
            <div class="mt-2 d-flex flex-wrap gap-2">
              {% if account.scopes %}
                {% for scope in account.scopes %}
                  <span class="badge bg-light text-dark scope-badge">{{ scope }}</span>
                {% endfor %}
              {% else %}
                <span class="text-muted">{{ _('No scopes assigned.') }}</span>
              {% endif %}
            </div>
            <p class="text-muted small mt-2 mb-0">
              {{ _('API keys can only be issued within the scopes registered for this service account.') }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h2 class="h6 text-muted text-uppercase mb-3">{{ _('Lifecycle Guidance') }}</h2>
        <ul class="mb-0 text-muted small ps-3">
          <li>{{ _('Issue keys per integration and rotate them regularly.') }}</li>
          <li>{{ _('Monitor usage logs to detect suspicious activity quickly.') }}</li>
          <li>{{ _('Revoke unused keys immediately to reduce exposure risk.') }}</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-white d-flex flex-wrap gap-2 justify-content-between align-items-center">
    <div>
      <h2 class="h5 mb-0">{{ _('Issued API Keys') }}</h2>
      <p class="text-muted small mb-0">{{ _('Each key is scoped to this service account. Revoke compromised keys without delay.') }}</p>
    </div>
    <div class="text-muted small" id="api-key-count"></div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="api-key-table">
        <thead class="table-light">
          <tr>
            <th scope="col" style="min-width: 140px;">{{ _('Identifier') }}</th>
            <th scope="col">{{ _('Scopes') }}</th>
            <th scope="col" style="min-width: 120px;">{{ _('Status') }}</th>
            <th scope="col" style="min-width: 180px;">{{ _('Issued At') }}</th>
            <th scope="col">{{ _('Issued By') }}</th>
            <th scope="col" class="text-end" style="width: 160px;">{{ _('Actions') }}</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="api-key-empty" class="text-center text-muted d-none">
      <i class="bi bi-shield-lock display-6 d-block mb-2"></i>
      <p class="mb-0">{{ _('No API keys have been issued yet.') }}</p>
      {% if can_manage_api_keys %}
      <p class="mb-0">{{ _('Use the "Issue API Key" button to create the first credential.') }}</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Create API Key Modal -->
<div class="modal fade" id="createApiKeyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('Issue API Key') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <form id="create-api-key-form" class="needs-validation" novalidate>
          <div class="mb-3">
            <label class="form-label">{{ _('Select scopes for this API key') }}</label>
            <p class="text-muted small mb-3">{{ _('Only scopes already granted to the service account can be chosen.') }}</p>
            <div id="create-api-key-scopes" class="row g-3"></div>
            <div class="invalid-feedback d-none" id="create-api-key-scope-error">{{ _('Please select at least one scope.') }}</div>
          </div>
          <div class="mb-3">
            <label class="form-label" for="api-key-expires-at">{{ _('Expiration (optional)') }}</label>
            <div class="input-group">
              <input type="datetime-local" class="form-control" id="api-key-expires-at">
              <button type="button" class="btn btn-outline-secondary" id="btn-clear-expiration">{{ _('No Expiry') }}</button>
            </div>
            <div class="form-text">{{ _('Leave empty for a non-expiring key. Use UTC or local time; it will be stored in UTC.') }}</div>
            <div class="invalid-feedback" id="create-api-key-expires-error"></div>
          </div>
          <div class="alert alert-danger d-none" id="create-api-key-error"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="submit" class="btn btn-primary" id="create-api-key-submit" form="create-api-key-form">
          <i class="bi bi-check-circle me-1"></i>
          {{ _('Issue API Key') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Reveal API Key Modal -->
<div class="modal fade" id="revealApiKeyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('New API Key Created') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3 text-muted">{{ _('Copy and store this API key securely. It will not be shown again.') }}</p>
        <div class="bg-light border rounded p-3 mb-3">
          <code id="revealed-api-key" class="d-block user-select-all"></code>
        </div>
        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-outline-primary" id="btn-copy-api-key">
            <i class="bi bi-clipboard me-1"></i>
            {{ _('Copy API Key') }}
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">{{ _('I have stored the key safely') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Revoke API Key Modal -->
<div class="modal fade" id="revokeApiKeyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('Revoke API Key') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">{{ _('Revoking this key will immediately block any future requests that use it.') }}</p>
        <div class="bg-light border rounded px-3 py-2">
          <div class="small text-muted">{{ _('Identifier') }}</div>
          <div class="fw-semibold" id="revoke-key-label"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-danger" id="confirm-revoke-api-key">
          <i class="bi bi-shield-x me-1"></i>
          {{ _('Revoke Now') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- API Key Logs Modal -->
<div class="modal fade" id="apiKeyLogsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ _('API Key Usage Logs') }}
          <small class="text-muted d-block" id="logs-key-label"></small>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <div id="api-key-logs-loading" class="text-center py-4 d-none">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">{{ _('Loading...') }}</span>
          </div>
        </div>
        <div id="api-key-logs-empty" class="alert alert-light border d-none" role="status">
          <i class="bi bi-info-circle me-2"></i>{{ _('No usage has been recorded for this key yet.') }}
        </div>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead class="table-light">
              <tr>
                <th scope="col">{{ _('Accessed At') }}</th>
                <th scope="col">{{ _('IP Address') }}</th>
                <th scope="col">{{ _('Endpoint') }}</th>
                <th scope="col">{{ _('User Agent') }}</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
  const account = {{ account|tojson }};
  const initialKeys = {{ initial_keys|tojson }};
  const canManage = {{ can_manage_api_keys|tojson }};
  const createUrl = {{ url_for('api.create_service_account_key', account_id=account['service_account_id'])|tojson }};
  const revokeUrlTemplate = {{ url_for('api.revoke_service_account_key', account_id=account['service_account_id'], key_id=0)|tojson }};
  const logsUrl = {{ url_for('api.list_service_account_key_logs', account_id=account['service_account_id'])|tojson }};
  const text = {
    statusActive: {{ _('Active')|tojson }},
    statusRevoked: {{ _('Revoked')|tojson }},
    statusExpired: {{ _('Expired')|tojson }},
    issuedByUnknown: {{ _('Unknown')|tojson }},
    actionsViewLogs: {{ _('View logs')|tojson }},
    actionsRevoke: {{ _('Revoke')|tojson }},
    actionsRevokeDisabled: {{ _('Cannot revoke')|tojson }},
    noScopesAvailable: {{ _('No scopes are available for issuing new keys.')|tojson }},
    copied: {{ _('API key copied to clipboard.')|tojson }},
    copyFailed: {{ _('Failed to copy. Please copy manually.')|tojson }},
    fetchFailed: {{ _('Failed to load data. Please try again.')|tojson }},
    createSuccess: {{ _('API key was issued successfully.')|tojson }},
    revokeSuccess: {{ _('API key has been revoked.')|tojson }},
    revokeError: {{ _('Failed to revoke the API key. Please try again.')|tojson }},
    createError: {{ _('Failed to issue the API key. Please review the form and try again.')|tojson }},
    issueButtonDefault: {{ _('Issue API Key')|tojson }},
    issueButtonWithCount: {{ _('Issue API Key ({count} selected)')|tojson }},
    emptyScopesHint: {{ _('Assign scopes to the service account before issuing new keys.')|tojson }},
  };

  const state = {
    keys: Array.isArray(initialKeys) ? initialKeys.slice() : [],
    revokeTarget: null,
    logsTarget: null,
  };

  const accountScopes = Array.isArray(account.scopes) ? account.scopes.slice() : [];
  const buttonIconHtml = '<i class="bi bi-check-circle me-1"></i>';
  let isSubmitting = false;

  const tableBody = document.querySelector('#api-key-table tbody');
  const emptyState = document.getElementById('api-key-empty');
  const keyCount = document.getElementById('api-key-count');
  const alertContainer = document.getElementById('api-key-alert-container');
  const createButton = document.getElementById('btn-create-api-key');
  const createModalElement = document.getElementById('createApiKeyModal');
  const createModal = createModalElement ? new bootstrap.Modal(createModalElement) : null;
  const createForm = document.getElementById('create-api-key-form');
  const scopeContainer = document.getElementById('create-api-key-scopes');
  const scopeError = document.getElementById('create-api-key-scope-error');
  const expiresError = document.getElementById('create-api-key-expires-error');
  const createError = document.getElementById('create-api-key-error');
  const createSubmit = document.getElementById('create-api-key-submit');
  const expirationInput = document.getElementById('api-key-expires-at');
  const clearExpirationButton = document.getElementById('btn-clear-expiration');
  const revealModalElement = document.getElementById('revealApiKeyModal');
  const revealModal = revealModalElement ? new bootstrap.Modal(revealModalElement) : null;
  const revealValue = document.getElementById('revealed-api-key');
  const copyButton = document.getElementById('btn-copy-api-key');
  const revokeModalElement = document.getElementById('revokeApiKeyModal');
  const revokeModal = revokeModalElement ? new bootstrap.Modal(revokeModalElement) : null;
  const revokeLabel = document.getElementById('revoke-key-label');
  const revokeConfirm = document.getElementById('confirm-revoke-api-key');
  const revokeConfirmDefaultHtml = revokeConfirm ? revokeConfirm.innerHTML : '';
  const logsModalElement = document.getElementById('apiKeyLogsModal');
  const logsModal = logsModalElement ? new bootstrap.Modal(logsModalElement) : null;
  const logsTableBody = logsModalElement ? logsModalElement.querySelector('tbody') : null;
  const logsEmpty = document.getElementById('api-key-logs-empty');
  const logsLoading = document.getElementById('api-key-logs-loading');
  const logsKeyLabel = document.getElementById('logs-key-label');

  function showAlert(message, type = 'info') {
    if (!alertContainer) return;
    const wrapper = document.createElement('div');
    wrapper.className = `alert alert-${type} alert-dismissible fade show`;
    wrapper.role = 'alert';
    wrapper.innerHTML = `
      <div>${message}</div>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{{ _('Close') }}"></button>
    `;
    alertContainer.appendChild(wrapper);
  }

  function formatDate(isoString) {
    if (!isoString) return '-';
    try {
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return '-';
      return date.toLocaleString();
    } catch (error) {
      return '-';
    }
  }

  function computeStatus(key) {
    const now = Date.now();
    if (key.revoked_at) {
      return { label: text.statusRevoked, variant: 'danger' };
    }
    if (key.expires_at) {
      const expires = new Date(key.expires_at).getTime();
      if (!Number.isNaN(expires) && expires <= now) {
        return { label: text.statusExpired, variant: 'warning' };
      }
    }
    return { label: text.statusActive, variant: 'success' };
  }

  function parseScopes(scopesValue) {
    if (!scopesValue) return [];
    if (Array.isArray(scopesValue)) return scopesValue;
    return scopesValue
      .split(/[\s,]+/)
      .map(scope => scope.trim())
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b));
  }

  function renderKeys() {
    if (!tableBody || !emptyState || !keyCount) return;
    tableBody.innerHTML = '';

    const sorted = state.keys.slice().sort((a, b) => {
      const aTime = a.created_at ? new Date(a.created_at).getTime() : 0;
      const bTime = b.created_at ? new Date(b.created_at).getTime() : 0;
      return bTime - aTime;
    });

    if (!sorted.length) {
      emptyState.classList.remove('d-none');
    } else {
      emptyState.classList.add('d-none');
    }

    sorted.forEach((key) => {
      const row = document.createElement('tr');
      const status = computeStatus(key);
      const scopes = parseScopes(key.scopes);
      const scopeBadges = scopes.length
        ? scopes.map(scope => `<span class="badge bg-secondary me-1 mb-1">${scope}</span>`).join('')
        : '<span class="text-muted">-</span>';
      const issuedAt = formatDate(key.created_at);
      const issuedBy = key.created_by || text.issuedByUnknown;
      const actions = [];

      actions.push(`
        <button class="btn btn-outline-secondary btn-sm" data-action="logs" data-id="${key.api_key_id}">
          <i class="bi bi-list-ul"></i>
        </button>
      `);

      if (canManage) {
        const disabled = Boolean(key.revoked_at);
        actions.push(`
          <button class="btn btn-outline-danger btn-sm ${disabled ? 'disabled' : ''}" data-action="revoke" data-id="${key.api_key_id}" ${disabled ? 'disabled' : ''}>
            <i class="bi bi-shield-x"></i>
          </button>
        `);
      }

      row.innerHTML = `
        <td><code class="text-dark">${key.public_id}</code></td>
        <td>${scopeBadges}</td>
        <td>
          <span class="badge bg-${status.variant} api-key-status-badge">${status.label}</span>
          ${key.expires_at ? `<div class="small text-muted">${formatDate(key.expires_at)}</div>` : ''}
        </td>
        <td><small>${issuedAt}</small></td>
        <td><small>${issuedBy}</small></td>
        <td class="text-end">
          <div class="btn-group" role="group">
            ${actions.join('')}
          </div>
        </td>
      `;

      tableBody.appendChild(row);
    });

    keyCount.textContent = '{{ _('Total') }}: ' + sorted.length;
  }

  function resetCreateForm() {
    if (!createForm) return;
    createForm.classList.remove('was-validated');
    if (scopeError) {
      scopeError.classList.add('d-none');
      scopeError.classList.remove('d-block');
      scopeError.textContent = {{ _('Please select at least one scope.')|tojson }};
    }
    if (expiresError) {
      expiresError.textContent = '';
      expiresError.classList.remove('d-block');
    }
    if (createError) {
      createError.classList.add('d-none');
      createError.textContent = '';
    }
    if (expirationInput) {
      expirationInput.value = '';
    }
    if (scopeContainer) {
      scopeContainer.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
        checkbox.checked = false;
      });
    }
    updateSubmitState();
  }

  function buildScopeOptions() {
    if (!scopeContainer) return;
    scopeContainer.innerHTML = '';

    if (!accountScopes.length) {
      const message = document.createElement('div');
      message.className = 'alert alert-light border';
      message.textContent = text.noScopesAvailable;
      scopeContainer.appendChild(message);
      if (createSubmit) {
        createSubmit.disabled = true;
        createSubmit.classList.add('disabled');
        createSubmit.setAttribute('disabled', 'disabled');
        createSubmit.innerHTML = `${buttonIconHtml}${text.issueButtonDefault}`;
      }
      return;
    }

    const fragment = document.createDocumentFragment();

    accountScopes.sort((a, b) => a.localeCompare(b)).forEach((scope, index) => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6';
      col.innerHTML = `
        <input class="btn-check" type="checkbox" value="${scope}" id="api-key-scope-${index}" autocomplete="off">
        <label class="btn btn-outline-primary scope-option w-100 text-start" for="api-key-scope-${index}">
          <span class="scope-option-name">${scope}</span>
          <span class="scope-option-icon"><i class="bi bi-check-circle-fill"></i></span>
        </label>
      `;
      fragment.appendChild(col);
    });

    scopeContainer.appendChild(fragment);
    updateSubmitState();
  }

  function collectSelectedScopes() {
    if (!scopeContainer) return [];
    return Array.from(scopeContainer.querySelectorAll('input[type="checkbox"]:checked'))
      .map((checkbox) => checkbox.value)
      .filter(Boolean);
  }

  function updateSubmitState() {
    if (!createSubmit || isSubmitting) return;
    const selectedCount = collectSelectedScopes().length;
    if (!selectedCount) {
      createSubmit.disabled = true;
      createSubmit.classList.add('disabled');
      createSubmit.setAttribute('disabled', 'disabled');
      createSubmit.innerHTML = `${buttonIconHtml}${text.issueButtonDefault}`;
      return;
    }

    createSubmit.disabled = false;
    createSubmit.classList.remove('disabled');
    createSubmit.removeAttribute('disabled');
    const buttonLabel = text.issueButtonWithCount.replace('{count}', selectedCount);
    createSubmit.innerHTML = `${buttonIconHtml}${buttonLabel}`;
  }

  function toIsoString(value) {
    if (!value) return null;
    try {
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return null;
      return date.toISOString();
    } catch (error) {
      return null;
    }
  }

  async function submitCreateForm(event) {
    event.preventDefault();
    if (!createForm) return;

    const selectedScopes = collectSelectedScopes();
    const expiresAtRaw = expirationInput ? expirationInput.value : '';
    const expiresAtIso = expiresAtRaw ? toIsoString(expiresAtRaw) : null;

    let hasError = false;
    if (!selectedScopes.length) {
      if (scopeError) {
        scopeError.classList.remove('d-none');
        scopeError.classList.add('d-block');
      }
      hasError = true;
    } else if (scopeError) {
      scopeError.classList.add('d-none');
      scopeError.classList.remove('d-block');
    }

    if (expiresError) {
      if (expiresAtRaw && !expiresAtIso) {
        expiresError.textContent = {{ _('Please provide a valid expiration date.')|tojson }};
        expiresError.classList.add('d-block');
        hasError = true;
      } else {
        expiresError.textContent = '';
        expiresError.classList.remove('d-block');
      }
    }

    if (hasError) {
      return;
    }

    if (!createSubmit) {
      return;
    }

    isSubmitting = true;
    createSubmit.disabled = true;
    createSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>{{ _('Issuing...') }}';

    try {
      const response = await fetch(createUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ scopes: selectedScopes, expires_at: expiresAtIso }),
      });
      const payload = await response.json();
      if (!response.ok) {
        const message = payload && payload.error ? payload.error : text.createError;
        if (payload && payload.field === 'scopes' && scopeError) {
          scopeError.textContent = message;
          scopeError.classList.remove('d-none');
          scopeError.classList.add('d-block');
        } else if (payload && payload.field === 'expires_at' && expiresError) {
          expiresError.textContent = message;
          expiresError.classList.add('d-block');
        } else if (createError) {
          createError.textContent = message;
          createError.classList.remove('d-none');
        }
        return;
      }

      const item = payload.item || {};
      const apiKeyValue = item.api_key;
      const { api_key: _ignored, ...rest } = item;
      state.keys.push(rest);
      renderKeys();

      createModal?.hide();
      resetCreateForm();
      showAlert(text.createSuccess, 'success');

      if (apiKeyValue && revealModal && revealValue) {
        revealValue.textContent = apiKeyValue;
        revealModal.show();
      }
    } catch (error) {
      if (createError) {
        createError.textContent = text.createError;
        createError.classList.remove('d-none');
      }
    } finally {
      isSubmitting = false;
      createSubmit.disabled = false;
      updateSubmitState();
    }
  }

  function openRevokeModal(key) {
    if (!revokeModal || !revokeLabel) return;
    state.revokeTarget = key;
    revokeLabel.textContent = key.public_id;
    revokeModal.show();
  }

  async function confirmRevoke() {
    if (!state.revokeTarget || !revokeModal || !revokeConfirm) return;

    const key = state.revokeTarget;
    const url = revokeUrlTemplate.replace('/0/', `/${key.api_key_id}/`);
    revokeConfirm.disabled = true;
    revokeConfirm.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>{{ _('Revoking...') }}';

    try {
      const response = await fetch(url, { method: 'POST' });
      const payload = await response.json();
      if (!response.ok) {
        showAlert(text.revokeError, 'danger');
        return;
      }
      const updated = payload.item || {};
      const index = state.keys.findIndex(item => item.api_key_id === updated.api_key_id);
      if (index >= 0) {
        state.keys.splice(index, 1, updated);
        renderKeys();
      }
      showAlert(text.revokeSuccess, 'success');
      revokeModal.hide();
    } catch (error) {
      showAlert(text.revokeError, 'danger');
    } finally {
      revokeConfirm.disabled = false;
      revokeConfirm.innerHTML = revokeConfirmDefaultHtml || '<i class="bi bi-shield-x me-1"></i>{{ _('Revoke Now') }}';
      state.revokeTarget = null;
    }
  }

  function renderLogs(items) {
    if (!logsTableBody || !logsEmpty) return;
    logsTableBody.innerHTML = '';

    if (!items.length) {
      logsEmpty.classList.remove('d-none');
      return;
    }

    logsEmpty.classList.add('d-none');
    items.forEach((log) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><small>${formatDate(log.accessed_at)}</small></td>
        <td><small>${log.ip_address || '-'}</small></td>
        <td><small class="text-break">${log.endpoint || '-'}</small></td>
        <td><small class="text-break">${log.user_agent || '-'}</small></td>
      `;
      logsTableBody.appendChild(row);
    });
  }

  async function openLogsModal(key) {
    if (!logsModal || !logsKeyLabel || !logsLoading) return;
    state.logsTarget = key;
    logsKeyLabel.textContent = key.public_id;
    logsEmpty.classList.add('d-none');
    if (logsTableBody) logsTableBody.innerHTML = '';
    logsLoading.classList.remove('d-none');
    logsModal.show();

    try {
      const response = await fetch(`${logsUrl}?key_id=${encodeURIComponent(key.api_key_id)}&limit=100`);
      const payload = await response.json();
      if (!response.ok) {
        showAlert(text.fetchFailed, 'danger');
        logsEmpty.classList.remove('d-none');
        return;
      }
      renderLogs(payload.items || []);
    } catch (error) {
      showAlert(text.fetchFailed, 'danger');
      logsEmpty.classList.remove('d-none');
    } finally {
      logsLoading.classList.add('d-none');
    }
  }

  function handleTableClick(event) {
    const button = event.target.closest('button[data-action]');
    if (!button) return;
    const id = Number.parseInt(button.dataset.id, 10);
    const key = state.keys.find(item => item.api_key_id === id);
    if (!key) return;

    if (button.dataset.action === 'revoke') {
      if (!key.revoked_at) {
        openRevokeModal(key);
      }
    } else if (button.dataset.action === 'logs') {
      openLogsModal(key);
    }
  }

  function copyApiKey() {
    if (!revealValue) return;
    const value = revealValue.textContent || '';
    navigator.clipboard.writeText(value).then(() => {
      if (typeof window.showSuccessToast === 'function') {
        window.showSuccessToast(text.copied);
      } else {
        showAlert(text.copied, 'success');
      }
    }).catch(() => {
      if (typeof window.showWarningToast === 'function') {
        window.showWarningToast(text.copyFailed);
      } else {
        showAlert(text.copyFailed, 'warning');
      }
    });
  }

  if (tableBody) {
    tableBody.addEventListener('click', handleTableClick);
  }

  if (createButton && createModal) {
    createButton.addEventListener('click', () => {
      if (!accountScopes.length) {
        showAlert(text.emptyScopesHint, 'warning');
        return;
      }
      resetCreateForm();
      createModal.show();
    });
  }

  if (createForm) {
    createForm.addEventListener('submit', submitCreateForm);
  }

  if (scopeContainer) {
    scopeContainer.addEventListener('change', () => {
      if (scopeError && collectSelectedScopes().length) {
        scopeError.classList.add('d-none');
        scopeError.classList.remove('d-block');
      }
      updateSubmitState();
    });
  }

  if (clearExpirationButton && expirationInput) {
    clearExpirationButton.addEventListener('click', () => {
      expirationInput.value = '';
    });
  }

  if (revokeConfirm) {
    revokeConfirm.addEventListener('click', confirmRevoke);
  }

  if (copyButton) {
    copyButton.addEventListener('click', copyApiKey);
  }

  buildScopeOptions();
  renderKeys();
})();
</script>
{% endblock %}

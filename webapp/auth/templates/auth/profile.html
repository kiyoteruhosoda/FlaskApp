{% extends "base.html" %}
{% block title %}{{ _('Profile') }} - {{ _('AppName') }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-xl-6 col-lg-7 col-md-9">
    <div class="card shadow-sm profile-card">
      <div class="card-body p-4 p-lg-5">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
          <div>
            <h1 class="h3 mb-1">{{ _('Profile') }}</h1>
            <p class="text-muted mb-0">{{ _('Manage how your account looks and feels.') }}</p>
          </div>
          <div class="text-end">
            <span class="badge rounded-pill text-bg-light text-secondary">
              <i class="fas fa-clock me-1"></i>
              {{ _('Current time') }}
            </span>
            <div class="mt-2 small text-muted">
              <div>{{ _('Local time ({tz})').format(tz=selected_timezone) }}<br><strong>{{ localized_time.strftime('%Y-%m-%d %H:%M:%S %Z') }}</strong></div>
              <div class="mt-1">UTC<br><strong>{{ server_time_utc.strftime('%Y-%m-%d %H:%M:%S UTC') }}</strong></div>
            </div>
          </div>
        </div>

        <div class="profile-section mb-4">
          <h2 class="h5 mb-3">{{ _('Account overview') }}</h2>
          <div class="row g-3">
            <div class="col-sm-6">
              <div class="profile-summary">
                <span class="text-muted small text-uppercase">{{ _('Signed in as') }}</span>
                <p class="mb-0 fw-semibold">{{ current_user.display_name }}</p>
                <p class="mb-0 text-muted">{{ current_user.email }}</p>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="profile-summary">
                <span class="text-muted small text-uppercase">{{ _('Two-factor authentication') }}</span>
                {% if current_user.totp_secret %}
                  <span class="badge bg-success">{{ _('Enabled') }}</span>
                {% else %}
                  <span class="badge bg-secondary">{{ _('Disabled') }}</span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        {% if current_user.roles %}
        {% set role_count = current_user.roles|length %}
        <div class="profile-section mb-4">
          <h2 class="h5 mb-3">{{ _('Role settings') }}</h2>
          {% if role_count > 1 %}
          <form method="post" class="role-switcher-form" data-role-switcher-form data-user-email="{{ current_user.email|e }}">
            <input type="hidden" name="action" value="switch-role">
            <div class="mb-3">
              <label for="active-role" class="form-label">{{ _('Active role') }}</label>
              <select class="form-select" id="active-role" name="active_role" required data-role-switcher-select>
                {% for role in current_user.roles %}
                  {% set is_selected = (active_role and role.id == active_role.id) or (not active_role and loop.first) %}
                  <option value="{{ role.id }}" data-role-permissions='{{ role.permissions|map(attribute="code")|list|tojson }}'
                          {% if is_selected %}selected{% endif %}>{{ role.name }}</option>
                {% endfor %}
              </select>
              <div class="form-text">{{ _('Selecting a specific role limits your permissions to that role.') }}</div>
            </div>
            <button type="submit" class="btn btn-outline-primary">
              <i class="fas fa-exchange-alt me-2"></i>{{ _('Switch role') }}
            </button>
          </form>
          {% else %}
          <div class="profile-summary">
            <span class="text-muted small text-uppercase">{{ _('Current Roles') }}</span>
            <div class="d-flex flex-wrap gap-2 mt-1">
              {% for role in current_user.roles %}
                <span class="badge bg-secondary">{{ role.name }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <form method="post" class="profile-section">
          <input type="hidden" name="action" value="update-preferences">
          <h2 class="h5 mb-3">{{ _('Display preferences') }}</h2>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="language" class="form-label">{{ _('Language') }}</label>
              <select class="form-select" id="language" name="language">
                {% for item in language_choices %}
                  <option value="{{ item.code }}" {% if item.code == selected_language %}selected{% endif %}>{{ item.label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label for="timezone" class="form-label">{{ _('Location / Timezone') }}</label>
              <select class="form-select" id="timezone" name="timezone">
                {% for item in timezone_choices %}
                  <option value="{{ item.code }}" {% if item.code == selected_timezone %}selected{% endif %}>{{ item.label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>{{ _('Save preferences') }}
            </button>
            <a href="{{ url_for('auth.edit') }}" class="btn btn-outline-secondary">
              <i class="fas fa-user-edit me-2"></i>{{ _('Edit profile details') }}
            </a>
            {% if not current_user.totp_secret %}
              <a href="{{ url_for('auth.setup_totp', next=url_for('auth.profile')) }}" class="btn btn-outline-warning">
                <i class="fas fa-mobile-alt me-2"></i>{{ _('Enable two-factor authentication') }}
              </a>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('[data-role-switcher-form]');
    const select = form?.querySelector('[data-role-switcher-select]');
    const userEmail = (form?.dataset.userEmail || '').trim().toLowerCase();
    const storageKey = userEmail ? `login_scope:${userEmail}` : null;

    if (!form || !select || !storageKey) {
      return;
    }

    const persistSelectedScope = () => {
      const option = select.selectedOptions && select.selectedOptions.length > 0
        ? select.selectedOptions[0]
        : null;

      if (!option) {
        localStorage.removeItem(storageKey);
        return;
      }

      const rawPermissions = option.dataset.rolePermissions || '';
      if (!rawPermissions) {
        localStorage.removeItem(storageKey);
        return;
      }

      try {
        const parsed = JSON.parse(rawPermissions);
        if (!Array.isArray(parsed)) {
          localStorage.removeItem(storageKey);
          return;
        }

        const normalized = Array.from(
          new Set(
            parsed
              .map((item) => (typeof item === 'string' ? item.trim() : ''))
              .filter((item) => item.length > 0)
          )
        );

        if (normalized.length > 0) {
          const payload = {
            permissions: normalized,
            source: 'profile-switch',
            roleSelection: {
              roleId: option.value || null,
            },
            updatedAt: new Date().toISOString(),
          };
          localStorage.setItem(storageKey, JSON.stringify(payload));
        } else {
          localStorage.removeItem(storageKey);
        }
      } catch (error) {
        console.warn('Failed to persist selected role scope', error);
        localStorage.removeItem(storageKey);
      }
    };

    select.addEventListener('change', persistSelectedScope);
    form.addEventListener('submit', persistSelectedScope);
    persistSelectedScope();
  });
</script>
{% endblock %}
